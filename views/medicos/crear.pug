extends ../layout

block contenido
  style.
    .page-header { border-bottom: 2px solid #e9ecef; padding-bottom: 1rem; }
    .card-custom {
      background: #ffffff;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      border: 1px solid #dee2e6;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .form-label { font-weight: 600; color: #495057; font-size: 0.85rem; margin-bottom: 4px; }
    .section-title { font-size: 1rem; font-weight: bold; margin-bottom: 1rem; display: flex; align-items: center; gap: 8px; }
    .btn-primary-custom {
      background-color: #3498db;
      color: white; border: none; padding: 10px 25px;
      border-radius: 6px; font-weight: bold;
      transition: all 0.3s;
    }
    .btn-primary-custom:hover { background-color: #2980b9; }

  .page-header.d-flex.justify-content-between.align-items-center.mb-4
    h2.m-0.text-dark
      i.fa-solid.fa-user-doctor.me-2.text-primary
      | Nuevo Médico
    a.btn.btn-outline-secondary.btn-sm(href="/medicos")
      i.fa-solid.fa-arrow-left.me-1
      | Volver al Listado

  //- Muestra de errores del servidor
  if errores && errores.length
    .alert.alert-danger.alert-dismissible.fade.show.shadow-sm(role="alert")
      i.fa-solid.fa-circle-exclamation.me-2
      strong Error: 
      ul.mb-0.mt-2
        each err in errores
          li= err
      button.btn-close(type="button" data-bs-dismiss="alert" aria-label="Close")

  form(action="/medicos" method="POST" novalidate)
    //- Campos ocultos necesarios para el modelo
    input(type="hidden" name="id_rol" value="2") 
    input(type="hidden" name="estado" value="1")

    .row
      //- COLUMNA IZQUIERDA: DATOS PERSONALES Y CUENTA
      .col-lg-8
        .card-custom
          h5.section-title.text-primary
            i.fa-solid.fa-address-card
            | Información Personal
          .row.g-3
            .col-md-6
              label.form-label Nombre
              input.form-control(type="text" name="nombre" value=(old?old.nombre:'') required)
            .col-md-6
              label.form-label Apellido
              input.form-control(type="text" name="apellido" value=(old?old.apellido:'') required)
            .col-md-4
              label.form-label DNI
              input.form-control(type="text" name="dni" value=(old?old.dni:'') required placeholder="Sin puntos")
            .col-md-4
              label.form-label Fecha de Nacimiento
              input.form-control(type="date" name="nacimiento" value=(old?old.nacimiento:'') required)
            .col-md-4
              label.form-label Matrícula Profesional
              input.form-control(type="text" name="matricula" value=(old?old.matricula:'') required placeholder="M.P. / M.N.")

        .card-custom
          h5.section-title.text-secondary
            i.fa-solid.fa-lock
            | Cuenta de Usuario
          .row.g-3
            .col-md-6
              label.form-label Correo Electrónico
              input.form-control(type="email" name="email" value=(old?old.email:'') required placeholder="ejemplo@correo.com")
            .col-md-3
              label.form-label Contraseña
              input.form-control(type="password" name="password" required)
            .col-md-3
              label.form-label Confirmar
              input.form-control(type="password" name="repeatPassword" required)

      //- COLUMNA DERECHA: ESPECIALIDADES Y TELÉFONOS
      .col-lg-4
        .card-custom
          h5.section-title.text-dark
            i.fa-solid.fa-stethoscope
            | Especialidades
          
          #especialidades-container.mb-2
            if old && old.especialidades
              - const espOld = Array.isArray(old.especialidades) ? old.especialidades : [old.especialidades]
              each espId in espOld
                - const esp = especialidades.find(e => String(e.id) === String(espId))
                if esp
                  .input-group.mb-2
                    input.form-control.form-control-sm(readonly value=esp.nombre)
                    input(type="hidden" name="especialidades" value=esp.id)
                    button.btn.btn-sm.btn-outline-danger(type="button" onclick="this.parentNode.remove()")
                      i.fa-solid.fa-trash-can

          .input-group.input-group-sm
            select.form-select#select-especialidad
              option(value="") -- Seleccionar --
              each esp in especialidades
                option(value=esp.id data-nombre=esp.nombre)= esp.nombre
            button.btn.btn-primary(type="button" onclick="agregarEspecialidad()") 
              i.fa-solid.fa-plus

        .card-custom
          .d-flex.justify-content-between.align-items-center.mb-2
            h5.section-title.text-dark.m-0
              i.fa-solid.fa-phone
              | Teléfonos
            button.btn.btn-sm.btn-success(type="button" onclick="agregarTelefono()" style="padding: 0px 8px;") +
          
          #telefonos-container
            .input-group.mb-2
              //- El name="telefonoAlternativo" es CRUCIAL para que el modelo lo reciba
              input.form-control.form-control-sm(type="text" name="telefonoAlternativo" value=(old?old.telefonoAlternativo:'') placeholder="Teléfono Principal" required)
              span.input-group-text: i.fa-solid.fa-star.text-warning.small

    .d-flex.justify-content-end.gap-2.mb-5
      a.btn.btn-light.px-4(href="/medicos") Cancelar
      button.btn-primary-custom(type="submit")
        i.fa-solid.fa-floppy-disk.me-2
        | Registrar Médico

  script.
    function agregarTelefono() {
      const cont = document.getElementById('telefonos-container');
      const div = document.createElement('div');
      div.className = 'input-group mb-2';
      div.innerHTML = `
        <input class="form-control form-control-sm" type="text" name="telefonos_extra" placeholder="Adicional...">
        <button class="btn btn-sm btn-outline-danger" type="button"><i class="fa-solid fa-trash-can"></i></button>
      `;
      div.querySelector('button').onclick = () => div.remove();
      cont.appendChild(div);
    }

    function agregarEspecialidad() {
      const select = document.getElementById('select-especialidad');
      const id = select.value;
      if (!id) return;
      const nombre = select.options[select.selectedIndex].dataset.nombre;
      const cont = document.getElementById('especialidades-container');
      
      // Evitar duplicados
      if ([...cont.querySelectorAll('input[type="hidden"]')].some(i => i.value === id)) return;

      const div = document.createElement('div');
      div.className = 'input-group mb-2';
      div.innerHTML = `
        <input class="form-control form-control-sm" readonly value="${nombre}">
        <input type="hidden" name="especialidades" value="${id}">
        <button class="btn btn-sm btn-outline-danger" type="button"><i class="fa-solid fa-trash-can"></i></button>
      `;
      div.querySelector('button').onclick = () => div.remove();
      cont.appendChild(div);
      select.value = '';
    }
