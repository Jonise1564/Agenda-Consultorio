extends ../layout

block contenido
  style.
    .page-header { border-bottom: 2px solid #e9ecef; padding-bottom: 1rem; }
    .card-custom {
      background: #ffffff;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      border: 1px solid #dee2e6;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .form-label { font-weight: 600; color: #495057; font-size: 0.85rem; margin-bottom: 4px; }
    .section-title { font-size: 1rem; font-weight: bold; margin-bottom: 1rem; display: flex; align-items: center; gap: 8px; }
    .btn-primary-custom {
      background-color: #3498db;
      color: white; border: none; padding: 10px 25px;
      border-radius: 6px; font-weight: bold;
      transition: all 0.3s;
    }
    .btn-primary-custom:hover { background-color: #2980b9; }
    .is-invalid { border-color: #dc3545 !important; box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important; }
    .is-valid { border-color: #198754 !important; }

  .page-header.d-flex.justify-content-between.align-items-center.mb-4
    h2.m-0.text-dark
      i.fa-solid.fa-user-doctor.me-2.text-primary
      | Nuevo Médico
    a.btn.btn-outline-secondary.btn-sm(href="/medicos")
      i.fa-solid.fa-arrow-left.me-1
      | Volver al Listado

  form#formMedico(action="/medicos" method="POST" novalidate)
    input(type="hidden" name="id_rol" value="2") 
    input(type="hidden" name="estado" value="1")

    .row
      .col-lg-8
        .card-custom
          h5.section-title.text-primary
            i.fa-solid.fa-address-card
            | Información Personal
          .row.g-3
            .col-md-6
              label.form-label Nombre
              input.form-control(type="text" name="nombre" id="nombre" value=(old?old.nombre:'') required)
            .col-md-6
              label.form-label Apellido
              input.form-control(type="text" name="apellido" id="apellido" value=(old?old.apellido:'') required)
            .col-md-4
              label.form-label DNI
              input.form-control(type="text" name="dni" id="dni" value=(old?old.dni:'') required placeholder="Sin puntos")
              .invalid-feedback#dni-feedback Ingrese el DNI.
            .col-md-4
              label.form-label Fecha de Nacimiento
              input.form-control(type="date" name="nacimiento" id="nacimiento" value=(old?old.nacimiento:'') required)
            .col-md-4
              label.form-label Matrícula Profesional
              input.form-control(type="text" name="matricula" id="matricula" value=(old?old.matricula:'') required placeholder="M.P. / M.N.")

        .card-custom
          h5.section-title.text-secondary
            i.fa-solid.fa-lock
            | Cuenta de Usuario
          .row.g-3
            .col-md-6
              label.form-label Correo Electrónico
              input.form-control(type="email" name="email" id="email" value=(old?old.email:'') required placeholder="ejemplo@correo.com")
            .col-md-3
              label.form-label Contraseña
              input.form-control(type="password" name="password" id="password" required)
            .col-md-3
              label.form-label Confirmar
              input.form-control(type="password" name="repeatPassword" id="repeatPassword" required)

      .col-lg-4
        .card-custom
          h5.section-title.text-dark
            i.fa-solid.fa-stethoscope
            | Especialidades
          
          #especialidades-container.mb-2
            if old && old.especialidades
              - const espOld = Array.isArray(old.especialidades) ? old.especialidades : [old.especialidades]
              each espId in espOld
                - const esp = especialidades.find(e => String(e.id) === String(espId))
                if esp
                  .input-group.mb-2
                    input.form-control.form-control-sm(readonly value=esp.nombre)
                    input(type="hidden" name="especialidades" value=esp.id)
                    button.btn.btn-sm.btn-outline-danger(type="button" onclick="this.parentNode.remove()")
                      i.fa-solid.fa-trash-can

          .input-group.input-group-sm
            select.form-select#select-especialidad
              option(value="") -- Seleccionar --
              each esp in especialidades
                option(value=esp.id data-nombre=esp.nombre)= esp.nombre
            button.btn.btn-primary(type="button" onclick="agregarEspecialidad()") 
              i.fa-solid.fa-plus

        .card-custom
          .d-flex.justify-content-between.align-items-center.mb-2
            h5.section-title.text-dark.m-0
              i.fa-solid.fa-phone
              | Teléfonos
            button.btn.btn-sm.btn-success(type="button" onclick="agregarTelefono()" style="padding: 0px 8px;") +
          
          #telefonos-container
            .input-group.mb-2
              input.form-control.form-control-sm(type="text" name="telefonoAlternativo" id="telefonoAlternativo" value=(old?old.telefonoAlternativo:'') placeholder="Teléfono Principal" required)
              span.input-group-text: i.fa-solid.fa-star.text-warning.small

    .d-flex.justify-content-end.gap-2.mb-5
      a.btn.btn-light.px-4(href="/medicos") Cancelar
      button.btn-primary-custom(type="submit")
        i.fa-solid.fa-floppy-disk.me-2
        | Registrar Médico

  script(src="https://cdn.jsdelivr.net/npm/sweetalert2@11")
  script.
    let dniDuplicado = false;

    // --- VALIDACIÓN DNI DUPLICADO (RUTA UNIVERSAL) ---
    document.getElementById('dni').addEventListener('blur', async function() {
        const dni = this.value.trim();
        const feedback = document.getElementById('dni-feedback');
        if (dni.length < 7) return;

        try {
            // Usamos la ruta universal definida en MedicosRouter
            const res = await fetch(`/medicos/verificar-persona/${dni}`);
            const data = await res.json();

            if (data.existe) {
                dniDuplicado = true;
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
                feedback.textContent = "Este DNI ya pertenece a una persona registrada.";
                Swal.fire('DNI Duplicado', `El documento ${dni} ya existe en el sistema.`, 'warning');
            } else {
                dniDuplicado = false;
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        } catch (e) { console.error("Error validando DNI:", e); }
    });

    function agregarTelefono() {
      const cont = document.getElementById('telefonos-container');
      const div = document.createElement('div');
      div.className = 'input-group mb-2';
      div.innerHTML = `
        <input class="form-control form-control-sm" type="text" name="telefonos_extra" placeholder="Adicional...">
        <button class="btn btn-sm btn-outline-danger" type="button"><i class="fa-solid fa-trash-can"></i></button>
      `;
      div.querySelector('button').onclick = () => div.remove();
      cont.appendChild(div);
    }

    function agregarEspecialidad() {
      const select = document.getElementById('select-especialidad');
      const id = select.value;
      if (!id) return;
      const nombre = select.options[select.selectedIndex].dataset.nombre;
      const cont = document.getElementById('especialidades-container');
      if ([...cont.querySelectorAll('input[type="hidden"]')].some(i => i.value === id)) return;

      const div = document.createElement('div');
      div.className = 'input-group mb-2';
      div.innerHTML = `
        <input class="form-control form-control-sm" readonly value="${nombre}">
        <input type="hidden" name="especialidades" value="${id}">
        <button class="btn btn-sm btn-outline-danger" type="button"><i class="fa-solid fa-trash-can"></i></button>
      `;
      div.querySelector('button').onclick = () => div.remove();
      cont.appendChild(div);
      select.value = '';
    }

    // --- VALIDACIÓN AL ENVIAR ---
    document.getElementById('formMedico').onsubmit = function(e) {
      e.preventDefault();
      const form = this;

      if (dniDuplicado) {
        Swal.fire('Atención', 'El DNI ingresado ya existe. Por favor verifique.', 'error');
        document.getElementById('dni').focus();
        return;
      }

      const inputs = form.querySelectorAll('[required]');
      let incompleto = false;
      inputs.forEach(i => {
        if (!i.value.trim()) {
          i.classList.add('is-invalid');
          incompleto = true;
        } else {
          i.classList.remove('is-invalid');
        }
      });

      if (incompleto) {
        Swal.fire('Campos vacíos', 'Por favor complete los campos obligatorios marcados en rojo.', 'error');
        return;
      }

      if (document.getElementById('password').value !== document.getElementById('repeatPassword').value) {
        document.getElementById('repeatPassword').classList.add('is-invalid');
        Swal.fire('Error', 'Las contraseñas no coinciden.', 'error');
        return;
      }

      if (document.querySelectorAll('input[name="especialidades"]').length === 0) {
        Swal.fire('Especialidad', 'Debe seleccionar al menos una especialidad.', 'warning');
        return;
      }

      Swal.fire({
        title: '¿Registrar médico?',
        text: "Se dará de alta al profesional en el sistema.",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3498db',
        confirmButtonText: 'Sí, registrar',
        cancelButtonText: 'Revisar'
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({ title: 'Guardando...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
          form.submit();
        }
      });
    };