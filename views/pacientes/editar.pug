extends ../layout

block contenido
  .container.mt-4.mb-5
    // Encabezado
    .row.mb-4
      .col-12.d-flex.justify-content-between.align-items-center
        div
          h2.fw-bold.text-primary 
            i.bi.bi-person-vcard-fill.me-2
            | Editar Paciente
          p.text-muted Actualice la información personal y cobertura médica.
        a.btn.btn-outline-secondary.btn-sm.shadow-sm(href="/pacientes")
          i.bi.bi-arrow-left.me-1
          | Volver al listado

    // Botones de Estado (Alta/Baja)
    .row.mb-3
      .col-12.d-flex.justify-content-end
        if paciente.estado == 1
          form(method="POST" action=`/pacientes/inactivar/${paciente.id_paciente}`)
            button.btn.btn-danger.btn-sm.px-3.shadow-sm(type="submit")
              i.bi.bi-person-x.me-1
              | Inactivar Paciente
        else
          form(method="POST" action=`/pacientes/activar/${paciente.id_paciente}`)
            button.btn.btn-success.btn-sm.px-3.shadow-sm(type="submit")
              i.bi.bi-person-check.me-1
              | Reactivar Paciente

    // Formulario Principal
    form.needs-validation(
      action=`/pacientes/update/${paciente.id_paciente}`
      method="POST"
      id="formPaciente"
      novalidate
    )
      // Flags para detectar cambios (similar a médico)
      input(type="hidden" name="telefonos_modificados" value="0" id="tel-mod")

      .row
        // Columna Izquierda: Datos Personales y Usuario
        .col-lg-8
          // SECCIÓN 1: DATOS PERSONALES
          .card.border-0.shadow-sm.mb-4
            .card-header.bg-white.py-3
              h5.card-title.mb-0.text-primary
                i.bi.bi-person-lines-fill.me-2
                | Información Personal
            .card-body
              .row.g-3
                .col-md-3
                  label.form-label.fw-bold ID Paciente
                  input.form-control.bg-light(type="number" value=paciente.id_paciente readonly)
                
                .col-md-3
                  label.form-label.fw-bold DNI
                  input.form-control.bg-light(type="number" value=paciente.dni readonly)

                .col-md-3
                  label.form-label.fw-bold Nombre
                  input.form-control(type="text" name="nombre" value=paciente.nombre required)
                  .invalid-feedback El nombre es requerido.
                
                .col-md-3
                  label.form-label.fw-bold Apellido
                  input.form-control(type="text" name="apellido" value=paciente.apellido required)
                  .invalid-feedback El apellido es requerido.

                .col-md-6
                  label.form-label.fw-bold Fecha de Nacimiento
                  input.form-control(
                    type="date"
                    name="nacimiento"
                    value=paciente.nacimiento ? (typeof paciente.nacimiento === 'string' ? paciente.nacimiento.split('T')[0] : paciente.nacimiento.toISOString().split('T')[0]) : ''
                    required
                  )

          // SECCIÓN 2: USUARIO Y ACCESO
          .card.border-0.shadow-sm.mb-4
            .card-header.bg-white.py-3
              h5.card-title.mb-0.text-primary
                i.bi.bi-shield-lock-fill.me-2
                | Credenciales de Acceso
            .card-body
              .form-check.form-switch.mb-3
                input.form-check-input#editar_usuario(type="checkbox")
                label.form-check-label.fw-bold(for="editar_usuario") Habilitar edición de cuenta
              
              .row.g-3
                .col-md-6
                  label.form-label.fw-bold Email
                  .input-group
                    span.input-group-text @
                    input.form-control#email(
                      type="email"
                      name="email"
                      value=(paciente.email || '')
                      disabled
                      required
                    )
                
                .col-md-6
                  label.form-label.fw-bold Nueva Contraseña
                  input.form-control#password(
                    type="password"
                    name="password"
                    placeholder="Solo si desea cambiarla"
                    disabled
                  )
                  small.text-muted Solo complete si desea actualizar la clave.

        // Columna Derecha: Obra Social y Teléfonos
        .col-lg-4
          // SECCIÓN 3: OBRA SOCIAL
          .card.border-0.shadow-sm.mb-4
            .card-header.bg-white.py-3
              h5.card-title.mb-0.text-primary
                i.bi.bi-hospital.me-2
                | Cobertura Médica
            .card-body
              label.form-label.small.fw-bold Obra Social Seleccionada
              select.form-select.form-select-sm(name="id_obra_social")
                option(value="") Sin obra social
                each os in obrasSociales
                  option(
                    value=os.id
                    selected=(Number(os.id) === Number(paciente.id_obra_social))
                  )= os.nombre

          // SECCIÓN 4: TELÉFONOS
          .card.border-0.shadow-sm.mb-4
            .card-header.bg-white.py-3.d-flex.justify-content-between.align-items-center
              h5.card-title.mb-0.text-primary
                i.bi.bi-telephone-fill.me-2
                | Contactos
              button.btn.btn-sm.btn-outline-success#btnAddTelefono(type="button" onclick="agregarTelefono()")
                i.bi.bi-plus-lg
            .card-body
              #telefonosContainer
                // Lógica de teléfonos dinámica igual a la de médicos
                if telefonos && telefonos.length
                  each numero in telefonos
                    .input-group.mb-2.telefono-row
                      input.form-control.form-control-sm.telefono-input(
                        type="text"
                        name="telefonos"
                        value=numero
                        maxlength="15"
                        oninput="marcarTelefonosModificados()"
                      )
                      button.btn.btn-outline-danger.btn-sm(type="button" onclick="marcarTelefonosModificados(); this.parentElement.remove()")
                        i.bi.bi-trash
                else
                  .input-group.mb-2.telefono-row
                    input.form-control.form-control-sm.telefono-input(
                      type="text"
                      name="telefonos"
                      placeholder="Número de teléfono"
                      maxlength="15"
                      oninput="marcarTelefonosModificados()"
                    )
                    button.btn.btn-outline-danger.btn-sm(type="button" onclick="marcarTelefonosModificados(); this.parentElement.remove()")
                      i.bi.bi-trash

      // Botones de Acción Final
      .row.mt-3
        .col-12.d-flex.justify-content-end.gap-2
          a.btn.btn-light.px-4(href="/pacientes") Cancelar
          button.btn.btn-primary.px-5.shadow(type="submit")
            i.bi.bi-check-lg.me-1
            | Guardar Cambios

  script.
    function marcarTelefonosModificados() {
      const telMod = document.getElementById('tel-mod');
      if(telMod) telMod.value = '1';
    }

    function agregarTelefono() {
      marcarTelefonosModificados();
      const container = document.getElementById('telefonosContainer');
      const div = document.createElement('div');
      div.className = 'input-group mb-2 telefono-row animate__animated animate__fadeIn';
      div.innerHTML = `
        <input class="form-control form-control-sm telefono-input" type="text" name="telefonos" placeholder="Número" maxlength="15">
        <button class="btn btn-outline-danger btn-sm" type="button">
          <i class="bi bi-trash"></i>
        </button>
      `;
      div.querySelector('button').onclick = () => {
        const rows = document.querySelectorAll('.telefono-row');
        if (rows.length === 1) {
          alert('Debe tener al menos un teléfono de contacto');
          return;
        }
        marcarTelefonosModificados();
        div.remove();
      };
      // Forzar solo números en el nuevo input
      div.querySelector('input').oninput = (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
        marcarTelefonosModificados();
      };
      container.appendChild(div);
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Toggle de Usuario
      const check = document.getElementById('editar_usuario');
      const emailInput = document.getElementById('email');
      const passInput = document.getElementById('password');

      if(check) {
        check.addEventListener('change', () => {
          emailInput.disabled = !check.checked;
          passInput.disabled = !check.checked;
          if (!check.checked) passInput.value = '';
        });
      }

      // Validación de Bootstrap y Duplicados
      const forms = document.querySelectorAll('.needs-validation');
      Array.prototype.slice.call(forms).forEach(form => {
        form.addEventListener('submit', event => {
          const valores = [...document.querySelectorAll('.telefono-input')]
            .map(i => i.value.trim())
            .filter(Boolean);
          const set = new Set(valores);
          
          if (set.size !== valores.length) {
            event.preventDefault();
            alert('No se permiten teléfonos duplicados');
            return;
          }

          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    });