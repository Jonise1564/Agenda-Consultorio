extends ../layout

block contenido
  //- Forzamos la carga de iconos por si el layout falla
  link(rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css")
  
  .container.py-5
    // ---------- ENCABEZADO ----------
    .row.mb-4
      .col-md-8.mx-auto
        a.btn.btn-outline-primary.btn-sm.rounded-pill.mb-3(href="/agendas")
          i.bi.bi-arrow-left.me-2
          | Volver a Agendas
        h2.fw-bold.text-primary
          i.bi.bi-pencil-square.me-2
          | Editar Agenda Médica
        p.text-muted Actualice los horarios y parámetros de atención del profesional.

    // ---------- FORMULARIO ----------
    .row
      .col-md-8.mx-auto
        if error
          .alert.alert-danger.shadow-sm.border-0.mb-4(role="alert")
            i.bi.bi-exclamation-triangle-fill.me-2
            | #{error}

        form(
          action=`/agendas/update/${agenda.id}`
          method="POST"
          id="editar-form"
          class="needs-validation"
          novalidate
        )
          input(type="hidden" name="id" value=agenda.id)

          //- SECCIÓN 1: PROFESIONAL Y UBICACIÓN
          .card.border-0.shadow-sm.mb-4
            .card-header.bg-white.py-3
              h5.mb-0.text-dark.fw-bold
                i.bi.bi-person-badge.text-primary.me-2
                | Profesional y Ubicación
            .card-body.bg-light.bg-opacity-50
              .row.g-3
                .col-md-6
                  label.form-label.small.fw-bold Médico
                  select.form-select.shadow-sm#medicoSelect(name="id_medico" required)
                    option(value="") Seleccione médico
                    each m in medicos
                      option(
                        value=m.id_medico
                        selected=(String(m.id_medico) === String(agenda.id_medico))
                      ) #{m.apellido} #{m.nombre}
                
                .col-md-6
                  label.form-label.small.fw-bold Especialidad
                  select.form-select.shadow-sm#especialidadSelect(name="id_especialidad" required)
                    option(value="") Seleccione especialidad
                    each e in especialidades
                      option(
                        value=e.id
                        selected=(String(e.id) === String(agenda.id_especialidad))
                      ) #{e.nombre}

                .col-md-6
                  label.form-label.small.fw-bold Sucursal
                  select.form-select.shadow-sm(name="id_sucursal" required)
                    option(value="1" selected=(agenda.id_sucursal == 1)) Clínica Argentina
                    option(value="2" selected=(agenda.id_sucursal == 2)) Clínica España
                
                .col-md-6
                  label.form-label.small.fw-bold Clasificación
                  select.form-select.shadow-sm(name="id_clasificacion" required)
                    option(value="1" selected=(agenda.id_clasificacion == 1)) Normal
                    option(value="2" selected=(agenda.id_clasificacion == 2)) Especial
                    option(value="3" selected=(agenda.id_clasificacion == 3)) VIP

          //- SECCIÓN 2: DÍAS Y HORARIOS
          .card.border-0.shadow-sm.mb-4
            .card-header.bg-white.py-3
              h5.mb-0.text-dark.fw-bold
                i.bi.bi-clock-history.text-primary.me-2
                | Disponibilidad Horaria
            .card-body
              .row.g-3.mb-4
                .col-md-3
                  label.form-label.small.fw-bold Fecha Inicio
                  input.form-control.shadow-sm(type="date" name="fecha_creacion" required value=agenda.fecha_creacion ? agenda.fecha_creacion.toISOString().split('T')[0] : '')
                .col-md-3
                  label.form-label.small.fw-bold Fecha Fin
                  input.form-control.shadow-sm(type="date" name="fecha_fin" required value=agenda.fecha_fin ? agenda.fecha_fin.toISOString().split('T')[0] : '')
                .col-md-3
                  label.form-label.small.fw-bold Hora Inicio
                  input.form-control.shadow-sm(type="time" name="hora_inicio" required value=agenda.hora_inicio)
                .col-md-3
                  label.form-label.small.fw-bold Hora Fin
                  input.form-control.shadow-sm(type="time" name="hora_fin" required value=agenda.hora_fin)

              label.form-label.small.fw-bold.mb-3 Días de atención
              .row.bg-light.p-3.rounded.mx-0
                - const diasSemana = ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo']
                each dia, i in diasSemana
                  - const valorDiaDB = (i + 1).toString()
                  - let isChecked = agenda && agenda.diasIds ? agenda.diasIds.map(String).includes(valorDiaDB) : false
                  .col-md-3.col-6.mb-2
                    .form-check.form-switch
                      input.form-check-input(type="checkbox" name="dias" id=`dia_${valorDiaDB}` value=valorDiaDB checked=isChecked)
                      label.form-check-label.small(for=`dia_${valorDiaDB}`) #{dia}

          //- SECCIÓN 3: PARÁMETROS DE TURNOS
          .card.border-0.shadow-sm.mb-4
            .card-header.bg-white.py-3
              h5.mb-0.text-dark.fw-bold
                i.bi.bi-gear-fill.text-primary.me-2
                | Configuración de Turnos
            .card-body
              .row.g-3
                .col-md-6
                  label.form-label.small.fw-bold Duración de la consulta
                  .input-group.shadow-sm
                    select.form-select(name="duracion_turnos" required)
                      option(value="") Seleccione...
                      each d in [15,20,25,30,35,40,45,50,60]
                        option(value=d selected=(String(d) === String(agenda.duracion_turnos))) #{d} minutos
                    span.input-group-text: i.bi.bi-stopwatch
                
                .col-md-6
                  label.form-label.small.fw-bold Límite de sobreturnos
                  .input-group.shadow-sm
                    input.form-control(type="number" min="0" name="limite_sobreturnos" required value=agenda.limite_sobreturnos)
                    span.input-group-text: i.bi.bi-person-plus

          // ---------- ACCIONES ----------
          .d-grid.gap-2.d-md-flex.justify-content-md-end.mt-4.mb-5
            a.btn.btn-light.btn-lg.px-5.text-muted(href="/agendas") Cancelar
            button.btn.btn-success.btn-lg.px-5.shadow(type="submit")
              i.bi.bi-check-circle.me-2
              | Guardar Cambios

  // ---------- SCRIPTS ----------
  script.
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('editar-form');
      const medicoSelect = document.getElementById('medicoSelect');
      const especialidadSelect = document.getElementById('especialidadSelect');

      medicoSelect.addEventListener('change', async () => {
        const idMedico = medicoSelect.value;
        especialidadSelect.innerHTML = '<option value="">Cargando...</option>';
        if (!idMedico) return;

        try {
          const res = await fetch(`/medicos/${idMedico}/especialidades`);
          const especialidades = await res.json();
          especialidadSelect.innerHTML = '<option value="">Seleccione especialidad</option>';
          especialidades.forEach(e => {
            const opt = document.createElement('option');
            opt.value = e.id;
            opt.textContent = e.nombre;
            especialidadSelect.appendChild(opt);
          });
        } catch (err) { console.error('Error cargando especialidades', err); }
      });

      form.addEventListener('submit', (e) => {
        const diasChecked = form.querySelectorAll('input[name="dias"]:checked');
        if (diasChecked.length === 0) {
          e.preventDefault();
          Swal.fire('Atención', 'Debe seleccionar al menos un día de atención.', 'warning');
          return false;
        }
        if (!form.checkValidity()) {
          e.preventDefault();
          e.stopPropagation();
        }
        form.classList.add('was-validated');
      });
    });