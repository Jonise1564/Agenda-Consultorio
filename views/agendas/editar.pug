extends ../layout

block contenido
  a(href="/agendas" class="btn btn-outline-dark") Volver
  link(rel="stylesheet" href="/css/style.css")

  style.
    .center-text { text-align: center; }

  script.
    function toggleFieldVisibility() {
      const fieldId = document.getElementById('id');
      fieldId.style.display = 'none';
    }

  h1.center-text Editar Agenda

  // ============================
  // ALERTA DE ERROR (si existe)
  // ============================
  if error
    .alert.alert-danger.mt-3(role="alert")
      | #{error}

  form(
    action=`/agendas/update/${agenda.id}`
    method="POST"
    id="editar-form"
    class="needs-validation"
    novalidate
  )

    // =====================
    // ID (oculto)
    // =====================
    div.mb-3
      input.form-control(type="number" name="id" id="id" value=agenda.id readonly)

    // =====================
    // FECHAS
    // =====================
    div.mb-3
      label(for="fecha_creacion" class="form-label") Fecha de Creación:
      input.form-control(
        type="date"
        name="fecha_creacion"
        value=agenda.fecha_creacion.toISOString().split('T')[0]
        required
      )

    div.mb-3
      label(for="fecha_fin" class="form-label") Fecha de Finalización:
      input.form-control(
        type="date"
        name="fecha_fin"
        value=agenda.fecha_fin.toISOString().split('T')[0]
        required
      )

    // =====================
    // HORARIOS
    // =====================
    div.mb-3
      label(for="hora_inicio" class="form-label") Hora de Inicio:
      input.form-control(
        type="time"
        name="hora_inicio"
        value=agenda.hora_inicio
        required
      )

    div.mb-3
      label(for="hora_fin" class="form-label") Hora de Finalización:
      input.form-control(
        type="time"
        name="hora_fin"
        value=agenda.hora_fin
        required
      )

    // =====================
    // LÍMITES
    // =====================
    div.mb-3
      label(for="limite_sobreturnos" class="form-label") Límite de Sobreturnos:
      input.form-control(
        type="number"
        name="limite_sobreturnos"
        value=agenda.limite_sobreturnos
        required
      )

    div.mb-3
      label(for="duracion_turnos" class="form-label") Duración Turnos (min):
      input.form-control(
        type="number"
        name="duracion_turnos"
        value=agenda.duracion_turnos
        required
      )

    // =====================
    // PROFESIONAL (MATRÍCULA)
    // =====================
    div.mb-3
      label(for="matricula" class="form-label") Profesional actual: #{agenda.matricula}
      select.form-select(name="matricula" id="matricula" required)
        option(value="") Seleccione un profesional
        each m in matriculas || []
          option(
            value=m.matricula,
            selected=(m.matricula == agenda.matricula)
          )= `${m.matricula} - ${m.nombre} ${m.apellido} (${m.nombreMat})`

    // =====================
    // SUCURSAL
    // (si querés dinámica, pedímelo)
    // =====================
    div.mb-3
      label(for="id_sucursal" class="form-label") Sucursal actual: #{agenda.sucursal}
      select.form-select(name="id_sucursal" id="id_sucursal" required)
        option(value="") Seleccione una sucursal
        option(value="1" selected=(agenda.id_sucursal == 1)) Clinica Argentina, San Luis
        option(value="2" selected=(agenda.id_sucursal == 2)) Clinica España, Juana Koslay

    // =====================
    // CLASIFICACIÓN
    // =====================
    div.mb-3
      label(for="id_clasificacion" class="form-label") Clasificación actual: #{agenda.clasificacion}
      select.form-select(name="id_clasificacion" required)
        option(value="") Seleccione una clasificación
        option(value="1" selected=(agenda.id_clasificacion == 1)) Normal
        option(value="2" selected=(agenda.id_clasificacion == 2)) Especial
        option(value="3" selected=(agenda.id_clasificacion == 3)) VIP
    //- div.mb-3
    //-   label(for="id_clasificacion" class="form-label") Clasificación actual: #{agenda.clasificacion}
    //-   select.form-select(name="id_clasificacion" id="id_clasificacion" required)
    //-     option(value="") Seleccione una clasificación
    //-     each c in clasificaciones || []
    //-       option(
    //-         value=c.id,
    //-         selected=(c.id == agenda.id_clasificacion)
    //-       )= c.nombre

    button.btn.btn-success(type="submit") Guardar Cambios

  script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js")
  script(src="/js/medicos.js")

  // =====================
  // VALIDACIÓN FINAL
  // =====================
  script.
    document.addEventListener('DOMContentLoaded', () => {
      toggleFieldVisibility();

      document.getElementById('editar-form').addEventListener('submit', (e) => {
        const selects = ['matricula', 'id_sucursal', 'id_clasificacion'];

        for (let id of selects) {
          const sel = document.getElementById(id);
          if (sel && sel.value === "") {
            alert("Debe seleccionar una opción válida en " + id.replace("id_", ""));
            e.preventDefault();
            return false;
          }
        }
      });
    });
