//- //- //- extends ../layout

//- //- //- block contenido
//- //- //-   .container.mt-4
//- //- //-     .row
//- //- //-       .col-md-4
//- //- //-         .card.shadow-sm.border-0.mb-4
//- //- //-           .card-body.text-center
//- //- //-             img.rounded-circle.mb-3(src="/images/user_icon_004.png" width="100")
//- //- //-             h4.fw-bold= usuario.nombre + ' ' + usuario.apellido
//- //- //-             p.text-muted Paciente
//- //- //-             hr
//- //- //-             .d-grid
//- //- //-               a.btn.btn-primary(href="/mi-panel/nuevo-turno") 
//- //- //-                 i.bi.bi-plus-circle.me-2
//- //- //-                 | Solicitar Turno

//- //- //-       .col-md-8
//- //- //-         .card.shadow-sm.border-0
//- //- //-           .card-header.bg-white.py-3
//- //- //-             h5.mb-0.fw-bold Mis Turnos Agendados
//- //- //-           .card-body
//- //- //-             if turnos && turnos.length > 0
//- //- //-               .table-responsive
//- //- //-                 table.table.table-hover
//- //- //-                   thead.table-light
//- //- //-                     tr
//- //- //-                       th Fecha
//- //- //-                       th Especialidad
//- //- //-                       th Médico
//- //- //-                       th Estado
//- //- //-                   tbody
//- //- //-                     each turno in turnos
//- //- //-                       tr
//- //- //-                         td= turno.fecha_formateada
//- //- //-                         td= turno.especialidad
//- //- //-                         td= turno.medico_nombre
//- //- //-                         td
//- //- //-                           span.badge(class=turno.estado === 'pendiente' ? 'bg-warning' : 'bg-success')= turno.estado
//- //- //-             else
//- //- //-               .text-center.py-5
//- //- //-                 i.bi.bi-calendar-x.display-1.text-muted
//- //- //-                 p.mt-3 Todavía no tienes turnos programados.



//- //- extends ../layout

//- //- block contenido
//- //-   .container.mt-4
//- //-     .row
//- //-       .col-md-4
//- //-         .card.shadow-sm.border-0.mb-4
//- //-           .card-body.text-center
//- //-             img.rounded-circle.mb-3(src="/images/user_icon_004.png" width="100")
//- //-             //- Cambiado 'usuario' por 'paciente'
//- //-             h4.fw-bold= paciente.nombre + ' ' + paciente.apellido
//- //-             p.text-muted Paciente
//- //-             hr
//- //-             .d-grid
//- //-               a.btn.btn-primary(href="/pacientes/nuevo-turno") 
//- //-                 i.bi.bi-plus-circle.me-2
//- //-                 | Solicitar Turno

//- //-       .col-md-8
//- //-         .card.shadow-sm.border-0
//- //-           .card-header.bg-white.py-3
//- //-             h5.mb-0.fw-bold Mis Turnos Agendados
//- //-           .card-body
//- //-             if turnos && turnos.length > 0
//- //-               .table-responsive
//- //-                 table.table.table-hover
//- //-                   thead.table-light
//- //-                     tr
//- //-                       th Fecha
//- //-                       th Hora
//- //-                       th Especialidad
//- //-                       th Médico
//- //-                       th Estado
//- //-                   tbody
//- //-                     each turno in turnos
//- //-                       tr
//- //-                         //- Ajustado a los nombres del SQL que escribimos antes
//- //-                         td= turno.fecha.toLocaleDateString()
//- //-                         td= turno.hora
//- //-                         td= turno.especialidad_nombre
//- //-                         td= turno.medico_nombre + ' ' + turno.medico_apellido
//- //-                         td
//- //-                           span.badge(class=(turno.estado === 'pendiente' || turno.estado === 'Reservado') ? 'bg-warning' : 'bg-success')= turno.estado
//- //-             else
//- //-               .text-center.py-5
//- //-                 i.bi.bi-calendar-x.display-1.text-muted
//- //-                 p.mt-3 Todavía no tienes turnos programados.

//- extends ../layout

//- block contenido
//-   .container.mt-4
//-     if !paciente
//-       .alert.alert-warning No se encontró información del perfil.
//-     else
//-       .row
//-         .col-md-4
//-           .card.shadow-sm.border-0.mb-4
//-             .card-body.text-center
//-               img.rounded-circle.mb-3(src="/images/user_icon_004.png" width="100")
//-               //- IMPORTANTE: Usamos 'paciente' porque así lo envía el controller
//-               h4.fw-bold= paciente.nombre + ' ' + paciente.apellido
//-               p.text-muted Paciente
//-               hr
//-               .d-grid
//-                 a.btn.btn-primary(href="/pacientes/nuevo-turno") 
//-                   i.bi.bi-plus-circle.me-2
//-                   | Solicitar Turno

//-         .col-md-8
//-           .card.shadow-sm.border-0
//-             .card-header.bg-white.py-3
//-               h5.mb-0.fw-bold Mis Turnos Agendados
//-             .card-body
//-               //- Verificamos que 'turnos' exista y tenga datos
//-               if turnos && turnos.length > 0
//-                 .table-responsive
//-                   table.table.table-hover
//-                     thead.table-light
//-                       tr
//-                         th Fecha
//-                         th Hora
//-                         th Especialidad
//-                         th Médico
//-                         th Estado
//-                     tbody
//-                       each turno in turnos
//-                         tr
//-                           //- Ajustamos a los nombres de columna del SQL que agregamos antes
//-                           td= new Date(turno.fecha).toLocaleDateString('es-AR')
//-                           td= turno.hora
//-                           td= turno.especialidad_nombre
//-                           td= turno.medico_nombre + ' ' + turno.medico_apellido
//-                           td
//-                             span.badge(class=(turno.estado === 'pendiente' || turno.estado === 'Reservado') ? 'bg-warning text-dark' : 'bg-success')= turno.estado
//-               else
//-                 .text-center.py-5
//-                   i.bi.bi-calendar-x.display-1.text-muted
//-                   p.mt-3 Todavía no tienes turnos programados.

//- extends ../layout

//- block contenido
//-   .container.mt-4
//-     .row
//-       .col-md-4
//-         .card.shadow-sm.border-0.mb-4
//-           .card-body.text-center
//-             //- Imagen (corregida la ruta si no existe)
//-             img.rounded-circle.mb-3(src="https://ui-avatars.com/api/?name=Marisol+Moreno&background=random" width="100")
            
//-             //- Usamos los nombres del DEBUG
//-             h4.fw-bold= paciente.nombre + ' ' + paciente.apellido
//-             p.badge.bg-info.text-dark= paciente.obra_social_nombre
//-             p.text-muted Paciente
//-             hr
//-             .d-grid
//-               //- Corregido el link que daba 404
//-               a.btn.btn-primary(href="/turnos") 
//-                 i.bi.bi-plus-circle.me-2
//-                 | Solicitar Turno

//-       .col-md-8
//-         .card.shadow-sm.border-0
//-           .card-header.bg-white.py-3
//-             h5.mb-0.fw-bold Mis Turnos Agendados
//-           .card-body
//-             if turnos && turnos.length > 0
//-               .table-responsive
//-                 table.table.table-hover
//-                   thead.table-light
//-                     tr
//-                       th Fecha
//-                       th Hora
//-                       th Especialidad
//-                       th Médico
//-                       th Estado
//-                   tbody
//-                     each turno in turnos
//-                       tr
//-                         td= new Date(turno.fecha).toLocaleDateString()
//-                         td= turno.hora
//-                         td= turno.especialidad_nombre
//-                         td= turno.medico_nombre + ' ' + turno.medico_apellido
//-                         td
//-                           span.badge(class=(turno.estado === 'pendiente') ? 'bg-warning' : 'bg-success')= turno.estado
//-             else
//-               .text-center.py-5
//-                 i.bi.bi-calendar-x.display-1.text-muted
//-                 p.mt-3 Todavía no tienes turnos programados.

//- extends ../layout

//- block contenido
//-   .container-fluid.py-4
//-     .row.mb-4
//-       .col-12
//-         h2.fw-bold.text-dark
//-           i.fa-solid.fa-chalkboard-user.me-2.text-primary
//-           | Mi Panel de Salud
//-         p.text-muted Hola, #{paciente.nombre}. Aquí puedes gestionar tus citas médicas.

//-     .row.g-4
//-       //- COLUMNA IZQUIERDA: RESERVA DE TURNO (Estilo Secretaría)
//-       .col-xl-5
//-         .card.border-0.shadow-sm.rounded-4
//-           .card-header.bg-primary.text-white.py-3.rounded-top-4
//-             h5.mb-0.fw-bold 
//-               i.fa-solid.fa-calendar-plus.me-2
//-               | Solicitar Nuevo Turno
//-           .card-body.p-4
//-             form#formReserva(method="POST" action="/pacientes/confirmar-reserva")
//-               input#agendaIdHidden(type="hidden" name="id_agenda")
//-               input(type="hidden" name="id_paciente" value=paciente.id_paciente)

//-               .mb-3
//-                 label.form-label.small.fw-bold.text-uppercase.text-muted Profesional
//-                 .input-group
//-                   span.input-group-text.bg-light: i.fa-solid.fa-user-doctor.text-primary
//-                   input#buscarMedico.form-control.bg-light(type="text" placeholder="Buscar médico..." autocomplete="off")
//-                 #sugerenciasMedico.list-group.position-absolute.w-100.shadow-lg.z-3
//-                 input#medicoId(type="hidden" name="id_medico")
              
//-               .mb-3
//-                 label.form-label.small.fw-bold.text-uppercase.text-muted Especialidad
//-                 select#especialidadSelect.form-select.bg-light(name="id_especialidad" required disabled)
//-                   option(value="" selected disabled) Primero busca un médico

//-               .row
//-                 .col-6.mb-3
//-                   label.form-label.small.fw-bold.text-uppercase.text-muted Fecha
//-                   input#fecha.form-control.bg-light(type="date" name="fecha" required)
//-                 .col-6.mb-3
//-                   label.form-label.small.fw-bold.text-uppercase.text-muted Hora
//-                   input#horaSeleccionadaInput.form-control.bg-white.border-primary.fw-bold(type="text" name="hora_inicio" placeholder="--:--" readonly required)

//-               hr
//-               label.form-label.small.fw-bold.text-uppercase.text-muted Disponibilidad
//-               #slotsContainer.d-flex.flex-wrap.gap-2.mb-4.justify-content-start
//-                 small.text-muted Selecciona profesional y fecha...

//-               button#btnGuardar.btn.btn-primary.w-100.py-3.fw-bold.text-uppercase.rounded-pill(type="submit" disabled)
//-                 | Confirmar Turno

//-       //- COLUMNA DERECHA: MIS TURNOS ACTUALES
//-       .col-xl-7
//-         .card.border-0.shadow-sm.rounded-4
//-           .card-header.bg-white.py-3.rounded-top-4.border-bottom
//-             h5.mb-0.fw-bold 
//-               i.fa-solid.fa-rectangle-list.me-2.text-success
//-               | Mis Turnos Agendados
//-           .card-body
//-             if turnos && turnos.length > 0
//-               .table-responsive
//-                 table.table.table-hover.align-middle
//-                   thead.table-light
//-                     tr
//-                       th Fecha / Hora
//-                       th Especialidad
//-                       th Médico
//-                       th Estado
//-                   tbody
//-                     each turno in turnos
//-                       tr
//-                         td
//-                           div.fw-bold= new Date(turno.fecha).toLocaleDateString()
//-                           small.text-muted= turno.hora
//-                         td= turno.especialidad_nombre
//-                         td= turno.medico_nombre + ' ' + turno.medico_apellido
//-                         td
//-                           span.badge.rounded-pill(class=(turno.estado === 'pendiente' ? 'bg-warning text-dark' : 'bg-success'))= turno.estado
//-             else
//-               .text-center.py-5
//-                 i.fa-solid.fa-calendar-day.display-1.text-light.mb-3
//-                 p.text-muted No tienes turnos programados. ¡Reserva uno a la izquierda!

//-   style.
//-     .card { transition: all 0.3s ease; }
//-     .list-group.position-absolute { max-height: 200px; overflow-y: auto; z-index: 1050; width: 90% !important; }
//-     .slot-hora {
//-       width: 80px; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px 0;
//-       text-align: center; cursor: pointer; background: #f8f9fa; font-size: 0.85rem; font-weight: bold;
//-     }
//-     .slot-hora:hover:not(.ocupado) { border-color: #0d6efd; background: #e7f1ff; }
//-     .slot-hora.selected { background: #0d6efd !important; color: white !important; border-color: #0d6efd; }
//-     .slot-hora.ocupado { cursor: not-allowed; opacity: 0.3; background: #eee; }

//-   script.
//-     document.addEventListener('DOMContentLoaded', () => {
//-       // Reutilizamos la lógica de autocompletado y disponibilidad que ya tienes
//-       const fechaInput = document.getElementById('fecha');
//-       const hoy = new Date().toISOString().split('T')[0];
//-       fechaInput.setAttribute('min', hoy);

//-       // --- LÓGICA AUTOCOMPLETE MÉDICO ---
//-       const inputMed = document.getElementById('buscarMedico');
//-       const suggMed = document.getElementById('sugerenciasMedico');
//-       const hiddenMed = document.getElementById('medicoId');
//-       const espSelect = document.getElementById('especialidadSelect');

//-       inputMed.addEventListener('input', async () => {
//-         const query = inputMed.value.trim();
//-         if (query.length < 2) { suggMed.innerHTML = ''; return; }
//-         const res = await fetch(`/medicos/buscar?q=${query}`);
//-         const data = await res.json();
//-         suggMed.innerHTML = data.map(m => `
//-           <button type="button" class="list-group-item list-group-item-action" data-id="${m.id_medico}" data-name="${m.nombre} ${m.apellido}">
//-             ${m.nombre} ${m.apellido}
//-           </button>`).join('');

//-         suggMed.querySelectorAll('button').forEach(btn => {
//-           btn.onclick = async () => {
//-             inputMed.value = btn.dataset.name;
//-             hiddenMed.value = btn.dataset.id;
//-             suggMed.innerHTML = '';
//-             espSelect.disabled = false;
//-             const respEsp = await fetch(`/medicos/${btn.dataset.id}/especialidades`);
//-             const esps = await respEsp.json();
//-             espSelect.innerHTML = '<option value="" selected disabled>Selecciona especialidad</option>' + 
//-               esps.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
//-             buscarDisponibilidad();
//-           };
//-         });
//-       });

//-       // --- LÓGICA DISPONIBILIDAD ---
//-       async function buscarDisponibilidad() {
//-         const id_medico = hiddenMed.value;
//-         const id_especialidad = espSelect.value;
//-         const fecha = fechaInput.value;
//-         if (!id_medico || !id_especialidad || !fecha) return;

//-         const slotsContainer = document.getElementById('slotsContainer');
//-         slotsContainer.innerHTML = '<small class="text-primary">Buscando horarios...</small>';

//-         try {
//-           const res = await fetch(`/secretaria/disponibilidad?id_medico=${id_medico}&id_especialidad=${id_especialidad}&fecha=${fecha}`);
//-           const data = await res.json();
          
//-           if (data.status === 'success' && data.horarios) {
//-             slotsContainer.innerHTML = data.horarios.map(h => `
//-               <div class="slot-hora ${h.ocupado ? 'ocupado' : ''}" data-hora="${h.hora}" data-agenda="${h.id_agenda}">
//-                 ${h.hora}
//-               </div>`).join('');

//-             document.querySelectorAll('.slot-hora').forEach(slot => {
//-               slot.addEventListener('click', function() {
//-                 if (this.classList.contains('ocupado')) return;
//-                 document.querySelectorAll('.slot-hora').forEach(s => s.classList.remove('selected'));
//-                 this.classList.add('selected');
//-                 document.getElementById('horaSeleccionadaInput').value = this.dataset.hora;
//-                 document.getElementById('agendaIdHidden').value = this.dataset.agenda;
//-                 document.getElementById('btnGuardar').disabled = false;
//-               });
//-             });
//-           } else {
//-             slotsContainer.innerHTML = '<small class="text-danger">Sin turnos para esta fecha.</small>';
//-           }
//-         } catch (err) { slotsContainer.innerHTML = 'Error al cargar.'; }
//-       }

//-       espSelect.addEventListener('change', buscarDisponibilidad);
//-       fechaInput.addEventListener('change', buscarDisponibilidad);
//-     });

//- extends ../layout

//- block contenido
//-   .container-fluid.py-4
//-     .row.mb-4
//-       .col-12
//-         h2.fw-bold.text-dark
//-           i.fa-solid.fa-chalkboard-user.me-2.text-primary
//-           | Mi Panel de Salud
//-         p.text-muted Hola, #{paciente.nombre}. Aquí puedes gestionar tus citas médicas.

//-     .row.g-4
//-       //- COLUMNA IZQUIERDA: RESERVA DE TURNO
//-       .col-xl-5
//-         .card.border-0.shadow-sm.rounded-4
//-           .card-header.bg-primary.text-white.py-3.rounded-top-4
//-             h5.mb-0.fw-bold 
//-               i.fa-solid.fa-calendar-plus.me-2
//-               | Solicitar Nuevo Turno
//-           .card-body.p-4
//-             form#formReserva(method="POST" action="/pacientes/confirmar-reserva")
//-               input#agendaIdHidden(type="hidden" name="id_agenda")
//-               input(type="hidden" name="id_paciente" value=paciente.id_paciente)

//-               .mb-3
//-                 label.form-label.small.fw-bold.text-uppercase.text-muted Profesional
//-                 .input-group
//-                   span.input-group-text.bg-light: i.fa-solid.fa-user-doctor.text-primary
//-                   input#buscarMedico.form-control.bg-light(type="text" placeholder="Buscar médico..." autocomplete="off")
//-                 #sugerenciasMedico.list-group.position-absolute.w-100.shadow-lg.z-3
//-                 input#medicoId(type="hidden" name="id_medico")
              
//-               .mb-3
//-                 label.form-label.small.fw-bold.text-uppercase.text-muted Especialidad
//-                 select#especialidadSelect.form-select.bg-light(name="id_especialidad" required disabled)
//-                   option(value="" selected disabled) Primero busca un médico

//-               .row
//-                 .col-6.mb-3
//-                   label.form-label.small.fw-bold.text-uppercase.text-muted Fecha
//-                   input#fecha.form-control.bg-light(type="date" name="fecha" required)
//-                 .col-6.mb-3
//-                   label.form-label.small.fw-bold.text-uppercase.text-muted Hora
//-                   input#horaSeleccionadaInput.form-control.bg-white.border-primary.fw-bold(type="text" name="hora_inicio" placeholder="--:--" readonly required)

//-               hr
//-               label.form-label.small.fw-bold.text-uppercase.text-muted Disponibilidad
//-               #slotsContainer.d-flex.flex-wrap.gap-2.mb-4.justify-content-start
//-                 small.text-muted Selecciona profesional y fecha...

//-               button#btnGuardar.btn.btn-primary.w-100.py-3.fw-bold.text-uppercase.rounded-pill(type="submit" disabled)
//-                 | Confirmar Turno

//-       //- COLUMNA DERECHA: MIS TURNOS ACTUALES
//-       .col-xl-7
//-         .card.border-0.shadow-sm.rounded-4
//-           .card-header.bg-white.py-3.rounded-top-4.border-bottom
//-             h5.mb-0.fw-bold 
//-               i.fa-solid.fa-rectangle-list.me-2.text-success
//-               | Mis Turnos Agendados
//-           .card-body
//-             if turnos && turnos.length > 0
//-               .table-responsive
//-                 table.table.table-hover.align-middle
//-                   thead.table-light
//-                     tr
//-                       th Fecha / Hora
//-                       th Especialidad
//-                       th Médico
//-                       th Estado
//-                   tbody
//-                     each turno in turnos
//-                       tr
//-                         td
//-                           div.fw-bold= new Date(turno.fecha).toLocaleDateString()
//-                           small.text-muted= turno.hora
//-                         td= turno.especialidad_nombre
//-                         td= turno.medico_nombre + ' ' + turno.medico_apellido
//-                         td
//-                           span.badge.rounded-pill(class=(turno.estado === 'pendiente' ? 'bg-warning text-dark' : 'bg-success'))= turno.estado
//-             else
//-               .text-center.py-5
//-                 i.fa-solid.fa-calendar-day.display-1.text-light.mb-3
//-                 p.text-muted No tienes turnos programados.

//-   style.
//-     .card { transition: all 0.3s ease; }
//-     .list-group.position-absolute { max-height: 200px; overflow-y: auto; z-index: 1050; width: 90% !important; }
//-     .slot-hora {
//-       width: 80px; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px 0;
//-       text-align: center; cursor: pointer; background: #f8f9fa; font-size: 0.85rem; font-weight: bold;
//-     }
//-     .slot-hora:hover:not(.ocupado) { border-color: #0d6efd; background: #e7f1ff; }
//-     .slot-hora.selected { background: #0d6efd !important; color: white !important; border-color: #0d6efd; }
//-     .slot-hora.ocupado { cursor: not-allowed; opacity: 0.3; background: #eee; }

//-   script.
//-     document.addEventListener('DOMContentLoaded', () => {
//-       // 1. GESTIÓN DE ALERTAS (SWEETALERT)
//-       const urlParams = new URLSearchParams(window.location.search);
//-       if (urlParams.get('status') === 'success') {
//-           Swal.fire({
//-               title: '¡Turno Confirmado!',
//-               text: 'Tu cita ha sido agendada correctamente. Te esperamos.',
//-               icon: 'success',
//-               confirmButtonColor: '#0d6efd'
//-           });
//-           window.history.replaceState({}, document.title, "/pacientes/dashboard");
//-       }

//-       // 2. LÓGICA DEL BUSCADOR Y FECHAS
//-       const fechaInput = document.getElementById('fecha');
//-       const hoy = new Date().toISOString().split('T')[0];
//-       fechaInput.setAttribute('min', hoy);

//-       const inputMed = document.getElementById('buscarMedico');
//-       const suggMed = document.getElementById('sugerenciasMedico');
//-       const hiddenMed = document.getElementById('medicoId');
//-       const espSelect = document.getElementById('especialidadSelect');

//-       inputMed.addEventListener('input', async () => {
//-         const query = inputMed.value.trim();
//-         if (query.length < 2) { suggMed.innerHTML = ''; return; }
//-         const res = await fetch(`/medicos/buscar?q=${query}`);
//-         const data = await res.json();
//-         suggMed.innerHTML = data.map(m => `
//-           <button type="button" class="list-group-item list-group-item-action" data-id="${m.id_medico}" data-name="${m.nombre} ${m.apellido}">
//-             ${m.nombre} ${m.apellido}
//-           </button>`).join('');

//-         suggMed.querySelectorAll('button').forEach(btn => {
//-           btn.onclick = async () => {
//-             inputMed.value = btn.dataset.name;
//-             hiddenMed.value = btn.dataset.id;
//-             sugerenciasMedico.innerHTML = '';
//-             espSelect.disabled = false;
//-             const respEsp = await fetch(`/medicos/${btn.dataset.id}/especialidades`);
//-             const esps = await respEsp.json();
//-             espSelect.innerHTML = '<option value="" selected disabled>Selecciona especialidad</option>' + 
//-               esps.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
//-             buscarDisponibilidad();
//-           };
//-         });
//-       });

//-       // 3. LÓGICA DE DISPONIBILIDAD
//-       async function buscarDisponibilidad() {
//-         const id_medico = hiddenMed.value;
//-         const id_especialidad = espSelect.value;
//-         const fecha = fechaInput.value;
//-         if (!id_medico || !id_especialidad || !fecha) return;

//-         const slotsContainer = document.getElementById('slotsContainer');
//-         slotsContainer.innerHTML = '<small class="text-primary">Buscando horarios...</small>';

//-         try {
//-           const res = await fetch(`/secretaria/disponibilidad?id_medico=${id_medico}&id_especialidad=${id_especialidad}&fecha=${fecha}`);
//-           const data = await res.json();
          
//-           if (data.status === 'success' && data.horarios) {
//-             slotsContainer.innerHTML = data.horarios.map(h => `
//-               <div class="slot-hora ${h.ocupado ? 'ocupado' : ''}" data-hora="${h.hora}" data-agenda="${h.id_agenda}">
//-                 ${h.hora}
//-               </div>`).join('');

//-             document.querySelectorAll('.slot-hora').forEach(slot => {
//-               slot.addEventListener('click', function() {
//-                 if (this.classList.contains('ocupado')) return;
//-                 document.querySelectorAll('.slot-hora').forEach(s => s.classList.remove('selected'));
//-                 this.classList.add('selected');
//-                 document.getElementById('horaSeleccionadaInput').value = this.dataset.hora;
//-                 document.getElementById('agendaIdHidden').value = this.dataset.agenda;
//-                 document.getElementById('btnGuardar').disabled = false;
//-               });
//-             });
//-           } else {
//-             slotsContainer.innerHTML = '<small class="text-danger">Sin turnos disponibles.</small>';
//-           }
//-         } catch (err) { slotsContainer.innerHTML = 'Error al cargar.'; }
//-       }

//-       espSelect.addEventListener('change', buscarDisponibilidad);
//-       fechaInput.addEventListener('change', buscarDisponibilidad);
//-     });

//- extends ../layout

//- block contenido
//-   .container-fluid.py-4
//-     //- CABECERA Y DATOS PERSONALES
//-     .row.mb-4.align-items-center
//-       .col-md-8
//-         h2.fw-bold.text-dark
//-           i.fa-solid.fa-chalkboard-user.me-2.text-primary
//-           | Mi Panel de Salud
//-         p.text-muted Hola, #{paciente.nombre}. Aquí puedes gestionar tus citas y revisar tu ficha médica.
//-       .col-md-4.text-md-end
//-         a.btn.btn-outline-danger.rounded-pill.px-4(href="/auth/logout")
//-           i.fa-solid.fa-right-from-bracket.me-2
//-           | Cerrar Sesión

//-     .row.g-4
//-       //- COLUMNA 1: DATOS PERSONALES (NUEVA)
//-       .col-xl-3.col-lg-4
//-         .card.border-0.shadow-sm.rounded-4.h-100
//-           .card-header.bg-light.py-3.rounded-top-4.border-bottom
//-             h6.mb-0.fw-bold.text-primary
//-               i.fa-solid.fa-id-card.me-2
//-               | Mis Datos Personales
//-           .card-body.p-4
//-             .text-center.mb-4
//-               //- Avatar genérico o foto si existiera
//-               .bg-primary.text-white.rounded-circle.d-inline-flex.align-items-center.justify-content-center.mb-3(style="width: 80px; height: 80px; font-size: 2rem;")
//-                 | #{paciente.nombre.charAt(0)}#{paciente.apellido.charAt(0)}
//-               h5.fw-bold.mb-0 #{paciente.nombre} #{paciente.apellido}
//-               span.badge.bg-info.text-dark.mt-2 Paciente Activo

//-             hr.text-muted.opacity-25

//-             .mb-3
//-               label.small.text-muted.text-uppercase.fw-bold DNI / Identificación
//-               p.mb-0.fw-semibold #{paciente.dni || 'No registrado'}
            
//-             .mb-3
//-               label.small.text-muted.text-uppercase.fw-bold Fecha de Nacimiento
//-               p.mb-0.fw-semibold #{new Date(paciente.fecha_nacimiento).toLocaleDateString()}
            
//-             .mb-3
//-               label.small.text-muted.text-uppercase.fw-bold Obra Social
//-               p.mb-0
//-                 if paciente.nombre_obra_social
//-                   span.text-success.fw-bold #{paciente.nombre_obra_social}
//-                   br
//-                   small.text-muted Afiliado: #{paciente.nro_afiliado || 'Sin nro.'}
//-                 else
//-                   span.text-muted Particular
            
//-             .mb-0
//-               label.small.text-muted.text-uppercase.fw-bold Email de Contacto
//-               p.mb-0.fw-semibold.text-truncate #{paciente.email}

//-       //- COLUMNA 2: RESERVA DE TURNO
//-       .col-xl-4.col-lg-8
//-         .card.border-0.shadow-sm.rounded-4.h-100
//-           .card-header.bg-primary.text-white.py-3.rounded-top-4
//-             h5.mb-0.fw-bold 
//-               i.fa-solid.fa-calendar-plus.me-2
//-               | Solicitar Nuevo Turno
//-           .card-body.p-4
//-             form#formReserva(method="POST" action="/pacientes/confirmar-reserva")
//-               input#agendaIdHidden(type="hidden" name="id_agenda")
//-               input(type="hidden" name="id_paciente" value=paciente.id_paciente)

//-               .mb-3
//-                 label.form-label.small.fw-bold.text-uppercase.text-muted Profesional
//-                 .input-group
//-                   span.input-group-text.bg-light: i.fa-solid.fa-user-doctor.text-primary
//-                   input#buscarMedico.form-control.bg-light(type="text" placeholder="Buscar médico..." autocomplete="off")
//-                 #sugerenciasMedico.list-group.position-absolute.w-100.shadow-lg.z-3
//-                 input#medicoId(type="hidden" name="id_medico")
              
//-               .mb-3
//-                 label.form-label.small.fw-bold.text-uppercase.text-muted Especialidad
//-                 select#especialidadSelect.form-select.bg-light(name="id_especialidad" required disabled)
//-                   option(value="" selected disabled) Primero busca un médico

//-               .row
//-                 .col-6.mb-3
//-                   label.form-label.small.fw-bold.text-uppercase.text-muted Fecha
//-                   input#fecha.form-control.bg-light(type="date" name="fecha" required)
//-                 .col-6.mb-3
//-                   label.form-label.small.fw-bold.text-uppercase.text-muted Hora
//-                   input#horaSeleccionadaInput.form-control.bg-white.border-primary.fw-bold(type="text" name="hora_inicio" placeholder="--:--" readonly required)

//-               hr
//-               label.form-label.small.fw-bold.text-uppercase.text-muted Disponibilidad
//-               #slotsContainer.d-flex.flex-wrap.gap-2.mb-4.justify-content-start
//-                 small.text-muted Selecciona profesional y fecha...

//-               button#btnGuardar.btn.btn-primary.w-100.py-3.fw-bold.text-uppercase.rounded-pill(type="submit" disabled)
//-                 | Confirmar Turno

//-       //- COLUMNA 3: MIS TURNOS ACTUALES
//-       .col-xl-5.col-lg-12
//-         .card.border-0.shadow-sm.rounded-4.h-100
//-           .card-header.bg-white.py-3.rounded-top-4.border-bottom
//-             h5.mb-0.fw-bold 
//-               i.fa-solid.fa-rectangle-list.me-2.text-success
//-               | Mis Turnos Agendados
//-           .card-body
//-             if turnos && turnos.length > 0
//-               .table-responsive
//-                 table.table.table-hover.align-middle
//-                   thead.table-light
//-                     tr
//-                       th Fecha / Hora
//-                       th Especialidad
//-                       th Médico
//-                       th Estado
//-                   tbody
//-                     each turno in turnos
//-                       tr
//-                         td
//-                           div.fw-bold= new Date(turno.fecha).toLocaleDateString()
//-                           small.text-muted= turno.hora
//-                         td= turno.especialidad_nombre
//-                         td= turno.medico_nombre + ' ' + turno.medico_apellido
//-                         td
//-                           span.badge.rounded-pill(class=(turno.estado === 'pendiente' ? 'bg-warning text-dark' : 'bg-success'))= turno.estado
//-             else
//-               .text-center.py-5
//-                 i.fa-solid.fa-calendar-day.display-1.text-light.mb-3
//-                 p.text-muted No tienes turnos programados.

//- extends ../layout

//- block contenido
//-   .container-fluid.py-4
//-     //- CABECERA DEL DASHBOARD
//-     .row.mb-4.align-items-center
//-       .col-md-8
//-         h2.fw-bold.text-dark
//-           i.fa-solid.fa-chalkboard-user.me-2.text-primary
//-           | Mi Panel de Salud
//-         p.text-muted Hola, #{paciente.nombre}. Aquí puedes gestionar tus citas médicas.
//-       .col-md-4.text-md-end
//-         button.btn.btn-white.shadow-sm.rounded-circle.me-2.border(type="button" data-bs-toggle="modal" data-bs-target="#modalPerfil" title="Configurar Perfil")
//-           i.fa-solid.fa-gear.text-secondary.fa-lg
//-         a.btn.btn-outline-danger.rounded-pill.px-4(href="/auth/logout")
//-           i.fa-solid.fa-right-from-bracket.me-2
//-           | Salir

//-     .row.g-4
//-       //- COLUMNA IZQUIERDA: RESERVA DE TURNO
//-       .col-xl-5
//-         .card.border-0.shadow-sm.rounded-4
//-           .card-header.bg-primary.text-white.py-3.rounded-top-4
//-             h5.mb-0.fw-bold 
//-               i.fa-solid.fa-calendar-plus.me-2
//-               | Solicitar Nuevo Turno
//-           .card-body.p-4
//-             form#formReserva(method="POST" action="/pacientes/confirmar-reserva")
//-               input#agendaIdHidden(type="hidden" name="id_agenda")
//-               input(type="hidden" name="id_paciente" value=paciente.id_paciente)

//-               .mb-3
//-                 label.form-label.small.fw-bold.text-uppercase.text-muted Profesional
//-                 .input-group
//-                   span.input-group-text.bg-light: i.fa-solid.fa-user-doctor.text-primary
//-                   input#buscarMedico.form-control.bg-light(type="text" placeholder="Buscar médico..." autocomplete="off")
//-                 #sugerenciasMedico.list-group.position-absolute.w-100.shadow-lg.z-3
//-                 input#medicoId(type="hidden" name="id_medico")
              
//-               .mb-3
//-                 label.form-label.small.fw-bold.text-uppercase.text-muted Especialidad
//-                 select#especialidadSelect.form-select.bg-light(name="id_especialidad" required disabled)
//-                   option(value="" selected disabled) Primero busca un médico

//-               .row
//-                 .col-6.mb-3
//-                   label.form-label.small.fw-bold.text-uppercase.text-muted Fecha
//-                   input#fecha.form-control.bg-light(type="date" name="fecha" required)
//-                 .col-6.mb-3
//-                   label.form-label.small.fw-bold.text-uppercase.text-muted Hora
//-                   input#horaSeleccionadaInput.form-control.bg-white.border-primary.fw-bold(type="text" name="hora_inicio" placeholder="--:--" readonly required)

//-               hr
//-               label.form-label.small.fw-bold.text-uppercase.text-muted Disponibilidad
//-               #slotsContainer.d-flex.flex-wrap.gap-2.mb-4.justify-content-start
//-                 small.text-muted Selecciona profesional y fecha...

//-               button#btnGuardar.btn.btn-primary.w-100.py-3.fw-bold.text-uppercase.rounded-pill(type="submit" disabled)
//-                 | Confirmar Turno

//-       //- COLUMNA DERECHA: MIS TURNOS ACTUALES
//-       .col-xl-7
//-         .card.border-0.shadow-sm.rounded-4
//-           .card-header.bg-white.py-3.rounded-top-4.border-bottom
//-             h5.mb-0.fw-bold 
//-               i.fa-solid.fa-rectangle-list.me-2.text-success
//-               | Mis Turnos Agendados
//-           .card-body
//-             if turnos && turnos.length > 0
//-               .table-responsive
//-                 table.table.table-hover.align-middle
//-                   thead.table-light
//-                     tr
//-                       th Fecha / Hora
//-                       th Especialidad
//-                       th Médico
//-                       th Estado
//-                   tbody
//-                     each turno in turnos
//-                       tr
//-                         td
//-                           //- PROTECCIÓN DE FECHA EN TABLA
//-                           - let fTurno = turno.fecha ? new Date(turno.fecha).toLocaleDateString() : 'Fecha no disponible'
//-                           div.fw-bold= fTurno
//-                           small.text-muted= turno.hora
//-                         td= turno.especialidad_nombre
//-                         td= turno.medico_nombre + ' ' + turno.medico_apellido
//-                         td
//-                           span.badge.rounded-pill(class=(turno.estado === 'pendiente' ? 'bg-warning text-dark' : 'bg-success'))= turno.estado
//-             else
//-               .text-center.py-5
//-                 i.fa-solid.fa-calendar-day.display-1.text-light.mb-3
//-                 p.text-muted No tienes turnos programados.

//-   //- =====================================================
//-   //- MODAL DE PERFIL (CON PROTECCIÓN DE FECHAS)
//-   //- =====================================================
//-   .modal.fade#modalPerfil(tabindex="-1" aria-labelledby="modalPerfilLabel" aria-hidden="true")
//-     .modal-dialog.modal-dialog-centered
//-       .modal-content.border-0.shadow-lg.rounded-4
//-         .modal-header.bg-primary.text-white.rounded-top-4
//-           h5.modal-title#modalPerfilLabel 
//-             i.fa-solid.fa-user-circle.me-2
//-             | Mi Perfil de Paciente
//-           button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal" aria-label="Close")
        
//-         form#formEditarPerfil(action="/pacientes/editar-perfil" method="POST")
//-           .modal-body.p-4
//-             .text-center.mb-4
//-               .bg-light.text-primary.rounded-circle.d-inline-flex.align-items-center.justify-content-center.mb-2(style="width: 70px; height: 70px; font-size: 1.5rem; border: 2px solid #0d6efd;")
//-                 | #{paciente.nombre ? paciente.nombre.charAt(0) : 'P'}#{paciente.apellido ? paciente.apellido.charAt(0) : 'U'}
//-               //- p.small.text-muted ID Paciente: ##{paciente.id_paciente}

//-             .row.g-3
//-               .col-md-6
//-                 label.form-label.small.fw-bold Nombre
//-                 input.form-control.bg-light(type="text" name="nombre" value=paciente.nombre required)
//-               .col-md-6
//-                 label.form-label.small.fw-bold Apellido
//-                 input.form-control.bg-light(type="text" name="apellido" value=paciente.apellido required)
              
//-               .col-12
//-                 label.form-label.small.fw-bold Correo Electrónico
//-                 input.form-control.bg-light(type="email" name="email" value=paciente.email required)
              
//-               .col-md-6
//-                 label.form-label.small.fw-bold DNI
//-                 input.form-control.bg-light(type="text" value=paciente.dni readonly)
//-               .col-md-6
//-                 label.form-label.small.fw-bold F. Nacimiento
                
//-                 - let fechaNac = ''
//-                 if paciente.fecha_nacimiento && !isNaN(new Date(paciente.fecha_nacimiento).getTime())
//-                   - fechaNac = new Date(paciente.fecha_nacimiento).toISOString().split('T')[0]
//-                 input.form-control.bg-light(type="date" name="nacimiento" value=fechaNac required)
              
//-               .col-12
//-                 label.form-label.small.fw-bold Obra Social
//-                 input.form-control.bg-light(type="text" value=(paciente.nombre_obra_social || 'Particular') readonly)
//-                 small.text-muted.x-small Para cambios de obra social contacte a recepción.

//-           .modal-footer.border-0.p-4.pt-0
//-             button.btn.btn-light.rounded-pill.px-4(type="button" data-bs-dismiss="modal") Cancelar
//-             button.btn.btn-primary.rounded-pill.px-4(type="submit") Guardar Cambios

//-   style.
//-     .card { transition: all 0.3s ease; }
//-     .list-group.position-absolute { max-height: 200px; overflow-y: auto; z-index: 1050; width: 90% !important; }
//-     .slot-hora {
//-       width: 80px; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px 0;
//-       text-align: center; cursor: pointer; background: #f8f9fa; font-size: 0.85rem; font-weight: bold;
//-     }
//-     .slot-hora:hover:not(.ocupado) { border-color: #0d6efd; background: #e7f1ff; }
//-     .slot-hora.selected { background: #0d6efd !important; color: white !important; border-color: #0d6efd; }
//-     .slot-hora.ocupado { cursor: not-allowed; opacity: 0.3; background: #eee; }
//-     .btn-white:hover { transform: rotate(30deg); transition: 0.3s; background: #f8f9fa; }
//-     .x-small { font-size: 0.75rem; }

//-   script.
//-     document.addEventListener('DOMContentLoaded', () => {
//-       const urlParams = new URLSearchParams(window.location.search);

//-       if (urlParams.get('status') === 'success') {
//-           Swal.fire({ title: '¡Turno Confirmado!', icon: 'success', confirmButtonColor: '#0d6efd' });
//-       }
//-       if (urlParams.get('status') === 'profile_updated') {
//-           Swal.fire({ title: 'Perfil Actualizado', icon: 'success', timer: 2000, showConfirmButton: false });
//-       }

//-       const fechaInput = document.getElementById('fecha');
//-       const hoy = new Date().toISOString().split('T')[0];
//-       if(fechaInput) fechaInput.setAttribute('min', hoy);

//-       const inputMed = document.getElementById('buscarMedico');
//-       const suggMed = document.getElementById('sugerenciasMedico');
//-       const hiddenMed = document.getElementById('medicoId');
//-       const espSelect = document.getElementById('especialidadSelect');

//-       if(inputMed) {
//-         inputMed.addEventListener('input', async () => {
//-           const query = inputMed.value.trim();
//-           if (query.length < 2) { suggMed.innerHTML = ''; return; }
//-           const res = await fetch(`/medicos/buscar?q=${query}`);
//-           const data = await res.json();
//-           suggMed.innerHTML = data.map(m => `
//-             <button type="button" class="list-group-item list-group-item-action" data-id="${m.id_medico}" data-name="${m.nombre} ${m.apellido}">
//-               ${m.nombre} ${m.apellido}
//-             </button>`).join('');

//-           suggMed.querySelectorAll('button').forEach(btn => {
//-             btn.onclick = async () => {
//-               inputMed.value = btn.dataset.name;
//-               hiddenMed.value = btn.dataset.id;
//-               suggMed.innerHTML = '';
//-               espSelect.disabled = false;
//-               const respEsp = await fetch(`/medicos/${btn.dataset.id}/especialidades`);
//-               const esps = await respEsp.json();
//-               espSelect.innerHTML = '<option value="" selected disabled>Selecciona especialidad</option>' + 
//-                 esps.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
//-               buscarDisponibilidad();
//-             };
//-           });
//-         });
//-       }

//-       async function buscarDisponibilidad() {
//-         const id_medico = hiddenMed.value;
//-         const id_especialidad = espSelect.value;
//-         const fecha = fechaInput.value;
//-         if (!id_medico || !id_especialidad || !fecha) return;

//-         const slotsContainer = document.getElementById('slotsContainer');
//-         slotsContainer.innerHTML = '<small class="text-primary">Buscando horarios...</small>';

//-         try {
//-           const res = await fetch(`/secretaria/disponibilidad?id_medico=${id_medico}&id_especialidad=${id_especialidad}&fecha=${fecha}`);
//-           const data = await res.json();
          
//-           if (data.status === 'success' && data.horarios) {
//-             slotsContainer.innerHTML = data.horarios.map(h => `
//-               <div class="slot-hora ${h.ocupado ? 'ocupado' : ''}" data-hora="${h.hora}" data-agenda="${h.id_agenda}">
//-                 ${h.hora}
//-               </div>`).join('');

//-             document.querySelectorAll('.slot-hora').forEach(slot => {
//-               slot.addEventListener('click', function() {
//-                 if (this.classList.contains('ocupado')) return;
//-                 document.querySelectorAll('.slot-hora').forEach(s => s.classList.remove('selected'));
//-                 this.classList.add('selected');
//-                 document.getElementById('horaSeleccionadaInput').value = this.dataset.hora;
//-                 document.getElementById('agendaIdHidden').value = this.dataset.agenda;
//-                 document.getElementById('btnGuardar').disabled = false;
//-               });
//-             });
//-           } else {
//-             slotsContainer.innerHTML = '<small class="text-danger">Sin turnos disponibles.</small>';
//-           }
//-         } catch (err) { slotsContainer.innerHTML = 'Error al cargar.'; }
//-       }

//-       if(espSelect) espSelect.addEventListener('change', buscarDisponibilidad);
//-       if(fechaInput) fechaInput.addEventListener('change', buscarDisponibilidad);
//-     });

//- extends ../layout

//- block contenido
//-   .container-fluid.py-4
//-     //- CABECERA DEL DASHBOARD
//-     .row.mb-4.align-items-center
//-       .col-md-8
//-         h2.fw-bold.text-dark
//-           i.fa-solid.fa-chalkboard-user.me-2.text-primary
//-           | Mi Panel de Salud
//-         p.text-muted Hola, #{paciente.nombre}. Aquí puedes gestionar tus citas médicas.
//-       .col-md-4.text-md-end
//-         button.btn.btn-white.shadow-sm.rounded-circle.me-2.border(type="button" data-bs-toggle="modal" data-bs-target="#modalPerfil" title="Configurar Perfil")
//-           i.fa-solid.fa-gear.text-secondary.fa-lg
//-         a.btn.btn-outline-danger.rounded-pill.px-4(href="/auth/logout")
//-           i.fa-solid.fa-right-from-bracket.me-2
//-           | Salir

//-     .row.g-4
//-       //- COLUMNA IZQUIERDA: RESERVA DE TURNO
//-       .col-xl-5
//-         .card.border-0.shadow-sm.rounded-4
//-           .card-header.bg-primary.text-white.py-3.rounded-top-4
//-             h5.mb-0.fw-bold 
//-               i.fa-solid.fa-calendar-plus.me-2
//-               | Solicitar Nuevo Turno
//-           .card-body.p-4
//-             form#formReserva(method="POST" action="/pacientes/confirmar-reserva")
//-               input#agendaIdHidden(type="hidden" name="id_agenda")
//-               input(type="hidden" name="id_paciente" value=paciente.id_paciente)

//-               .mb-3
//-                 label.form-label.small.fw-bold.text-uppercase.text-muted Profesional
//-                 .input-group
//-                   span.input-group-text.bg-light: i.fa-solid.fa-user-doctor.text-primary
//-                   input#buscarMedico.form-control.bg-light(type="text" placeholder="Buscar médico..." autocomplete="off")
//-                 #sugerenciasMedico.list-group.position-absolute.w-100.shadow-lg.z-3
//-                 input#medicoId(type="hidden" name="id_medico")
              
//-               .mb-3
//-                 label.form-label.small.fw-bold.text-uppercase.text-muted Especialidad
//-                 select#especialidadSelect.form-select.bg-light(name="id_especialidad" required disabled)
//-                   option(value="" selected disabled) Primero busca un médico

//-               .row
//-                 .col-6.mb-3
//-                   label.form-label.small.fw-bold.text-uppercase.text-muted Fecha
//-                   input#fecha.form-control.bg-light(type="date" name="fecha" required)
//-                 .col-6.mb-3
//-                   label.form-label.small.fw-bold.text-uppercase.text-muted Hora
//-                   input#horaSeleccionadaInput.form-control.bg-white.border-primary.fw-bold(type="text" name="hora_inicio" placeholder="--:--" readonly required)

//-               hr
//-               label.form-label.small.fw-bold.text-uppercase.text-muted Disponibilidad
//-               #slotsContainer.d-flex.flex-wrap.gap-2.mb-4.justify-content-start
//-                 small.text-muted Selecciona profesional y fecha...

//-               button#btnGuardar.btn.btn-primary.w-100.py-3.fw-bold.text-uppercase.rounded-pill(type="submit" disabled)
//-                 | Confirmar Turno

//-       //- COLUMNA DERECHA: MIS TURNOS ACTUALES
//-       .col-xl-7
//-         .card.border-0.shadow-sm.rounded-4
//-           .card-header.bg-white.py-3.rounded-top-4.border-bottom
//-             h5.mb-0.fw-bold 
//-               i.fa-solid.fa-rectangle-list.me-2.text-success
//-               | Mis Turnos Agendados
//-           .card-body
//-             if turnos && turnos.length > 0
//-               .table-responsive
//-                 table.table.table-hover.align-middle
//-                   thead.table-light
//-                     tr
//-                       th Fecha / Hora
//-                       th Especialidad
//-                       th Médico
//-                       th Estado
//-                   tbody
//-                     each turno in turnos
//-                       tr
//-                         td
//-                           - let fTurno = turno.fecha ? new Date(turno.fecha).toLocaleDateString() : 'Fecha no disponible'
//-                           div.fw-bold= fTurno
//-                           small.text-muted= turno.hora
//-                         td= turno.especialidad_nombre
//-                         td= turno.medico_nombre + ' ' + turno.medico_apellido
//-                         td
//-                           span.badge.rounded-pill(class=(turno.estado === 'pendiente' ? 'bg-warning text-dark' : 'bg-success'))= turno.estado
//-             else
//-               .text-center.py-5
//-                 i.fa-solid.fa-calendar-day.display-1.text-light.mb-3
//-                 p.text-muted No tienes turnos programados.

//-   //- =====================================================
//-   //- MODAL DE PERFIL (CON FORMATEO MANUAL DE FECHA)
//-   //- =====================================================
//-   .modal.fade#modalPerfil(tabindex="-1" aria-labelledby="modalPerfilLabel" aria-hidden="true")
//-     .modal-dialog.modal-dialog-centered
//-       .modal-content.border-0.shadow-lg.rounded-4
//-         .modal-header.bg-primary.text-white.rounded-top-4
//-           h5.modal-title#modalPerfilLabel 
//-             i.fa-solid.fa-user-circle.me-2
//-             | Mi Perfil de Paciente
//-           button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal" aria-label="Close")
        
//-         form#formEditarPerfil(action="/pacientes/editar-perfil" method="POST")
//-           .modal-body.p-4
//-             .text-center.mb-4
//-               .bg-light.text-primary.rounded-circle.d-inline-flex.align-items-center.justify-content-center.mb-2(style="width: 70px; height: 70px; font-size: 1.5rem; border: 2px solid #0d6efd;")
//-                 | #{paciente.nombre ? paciente.nombre.charAt(0) : 'P'}#{paciente.apellido ? paciente.apellido.charAt(0) : 'U'}

//-             .row.g-3
//-               .col-md-6
//-                 label.form-label.small.fw-bold Nombre
//-                 input.form-control.bg-light(type="text" name="nombre" value=paciente.nombre required)
//-               .col-md-6
//-                 label.form-label.small.fw-bold Apellido
//-                 input.form-control.bg-light(type="text" name="apellido" value=paciente.apellido required)
              
//-               .col-12
//-                 label.form-label.small.fw-bold Correo Electrónico
//-                 input.form-control.bg-light(type="email" name="email" value=paciente.email required)
              
//-               .col-md-6
//-                 label.form-label.small.fw-bold DNI
//-                 input.form-control.bg-light(type="text" value=paciente.dni readonly)
//-               .col-md-6
//-                 label.form-label.small.fw-bold F. Nacimiento
//-                 //- CORRECCIÓN DEFINITIVA DE FECHA
//-                 - let fechaNac = ''
//-                 if paciente.nacimiento
//-                   - const d = new Date(paciente.nacimiento)
//-                   if !isNaN(d.getTime())
//-                     - const year = d.getUTCFullYear()
//-                     - const month = String(d.getUTCMonth() + 1).padStart(2, '0')
//-                     - const day = String(d.getUTCDate()).padStart(2, '0')
//-                     - fechaNac = `${year}-${month}-${day}`
//-                 input.form-control.bg-light(type="date" name="nacimiento" value=fechaNac required)
              
//-               .col-12
//-                 label.form-label.small.fw-bold Obra Social
//-                 input.form-control.bg-light(type="text" value=(paciente.nombre_obra_social || 'Particular') readonly)
//-                 small.text-muted.x-small Para cambios de obra social contacte a recepción.

//-           .modal-footer.border-0.p-4.pt-0
//-             button.btn.btn-light.rounded-pill.px-4(type="button" data-bs-dismiss="modal") Cancelar
//-             button.btn.btn-primary.rounded-pill.px-4(type="submit") Guardar Cambios

//-   style.
//-     .card { transition: all 0.3s ease; }
//-     .list-group.position-absolute { max-height: 200px; overflow-y: auto; z-index: 1050; width: 90% !important; }
//-     .slot-hora {
//-       width: 80px; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px 0;
//-       text-align: center; cursor: pointer; background: #f8f9fa; font-size: 0.85rem; font-weight: bold;
//-     }
//-     .slot-hora:hover:not(.ocupado) { border-color: #0d6efd; background: #e7f1ff; }
//-     .slot-hora.selected { background: #0d6efd !important; color: white !important; border-color: #0d6efd; }
//-     .slot-hora.ocupado { cursor: not-allowed; opacity: 0.3; background: #eee; }
//-     .btn-white:hover { transform: rotate(30deg); transition: 0.3s; background: #f8f9fa; }
//-     .x-small { font-size: 0.75rem; }

//-   script.
//-     document.addEventListener('DOMContentLoaded', () => {
//-       const urlParams = new URLSearchParams(window.location.search);

//-       if (urlParams.get('status') === 'success') {
//-           Swal.fire({ title: '¡Turno Confirmado!', icon: 'success', confirmButtonColor: '#0d6efd' });
//-       }
//-       if (urlParams.get('status') === 'profile_updated') {
//-           Swal.fire({ title: 'Perfil Actualizado', icon: 'success', timer: 2000, showConfirmButton: false });
//-       }

//-       const fechaInput = document.getElementById('fecha');
//-       const hoy = new Date().toISOString().split('T')[0];
//-       if(fechaInput) fechaInput.setAttribute('min', hoy);

//-       const inputMed = document.getElementById('buscarMedico');
//-       const suggMed = document.getElementById('sugerenciasMedico');
//-       const hiddenMed = document.getElementById('medicoId');
//-       const espSelect = document.getElementById('especialidadSelect');

//-       if(inputMed) {
//-         inputMed.addEventListener('input', async () => {
//-           const query = inputMed.value.trim();
//-           if (query.length < 2) { suggMed.innerHTML = ''; return; }
//-           const res = await fetch(`/medicos/buscar?q=${query}`);
//-           const data = await res.json();
//-           suggMed.innerHTML = data.map(m => `
//-             <button type="button" class="list-group-item list-group-item-action" data-id="${m.id_medico}" data-name="${m.nombre} ${m.apellido}">
//-               ${m.nombre} ${m.apellido}
//-             </button>`).join('');

//-           suggMed.querySelectorAll('button').forEach(btn => {
//-             btn.onclick = async () => {
//-               inputMed.value = btn.dataset.name;
//-               hiddenMed.value = btn.dataset.id;
//-               sugerenciasMedico.innerHTML = '';
//-               espSelect.disabled = false;
//-               const respEsp = await fetch(`/medicos/${btn.dataset.id}/especialidades`);
//-               const esps = await respEsp.json();
//-               espSelect.innerHTML = '<option value="" selected disabled>Selecciona especialidad</option>' + 
//-                 esps.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
//-               buscarDisponibilidad();
//-             };
//-           });
//-         });
//-       }

//-       async function buscarDisponibilidad() {
//-         const id_medico = hiddenMed.value;
//-         const id_especialidad = espSelect.value;
//-         const fecha = fechaInput.value;
//-         if (!id_medico || !id_especialidad || !fecha) return;

//-         const slotsContainer = document.getElementById('slotsContainer');
//-         slotsContainer.innerHTML = '<small class="text-primary">Buscando horarios...</small>';

//-         try {
//-           const res = await fetch(`/secretaria/disponibilidad?id_medico=${id_medico}&id_especialidad=${id_especialidad}&fecha=${fecha}`);
//-           const data = await res.json();
          
//-           if (data.status === 'success' && data.horarios) {
//-             slotsContainer.innerHTML = data.horarios.map(h => `
//-               <div class="slot-hora ${h.ocupado ? 'ocupado' : ''}" data-hora="${h.hora}" data-agenda="${h.id_agenda}">
//-                 ${h.hora}
//-               </div>`).join('');

//-             document.querySelectorAll('.slot-hora').forEach(slot => {
//-               slot.addEventListener('click', function() {
//-                 if (this.classList.contains('ocupado')) return;
//-                 document.querySelectorAll('.slot-hora').forEach(s => s.classList.remove('selected'));
//-                 this.classList.add('selected');
//-                 document.getElementById('horaSeleccionadaInput').value = this.dataset.hora;
//-                 document.getElementById('agendaIdHidden').value = this.dataset.agenda;
//-                 document.getElementById('btnGuardar').disabled = false;
//-               });
//-             });
//-           } else {
//-             slotsContainer.innerHTML = '<small class="text-danger">Sin turnos disponibles.</small>';
//-           }
//-         } catch (err) { slotsContainer.innerHTML = 'Error al cargar.'; }
//-       }

//-       if(espSelect) espSelect.addEventListener('change', buscarDisponibilidad);
//-       if(fechaInput) fechaInput.addEventListener('change', buscarDisponibilidad);
//-     });

extends ../layout

block contenido
  .container-fluid.py-4
    //- CABECERA DEL DASHBOARD
    .row.mb-4.align-items-center
      .col-md-8
        h2.fw-bold.text-dark
          i.fa-solid.fa-chalkboard-user.me-2.text-primary
          | Mi Panel de Salud
        p.text-muted Hola, #{paciente.nombre}. Aquí puedes gestionar tus citas médicas.
      .col-md-4.text-md-end
        //- BOTÓN DE CONFIGURACIÓN (LA TUERQUITA)
        button.btn.btn-white.shadow-sm.rounded-circle.me-2.border(type="button" data-bs-toggle="modal" data-bs-target="#modalPerfil" title="Configurar Perfil")
          i.fa-solid.fa-gear.text-secondary.fa-lg
        a.btn.btn-outline-danger.rounded-pill.px-4(href="/auth/logout")
          i.fa-solid.fa-right-from-bracket.me-2
          | Salir

    .row.g-4
      //- COLUMNA IZQUIERDA: RESERVA DE TURNO
      .col-xl-5
        .card.border-0.shadow-sm.rounded-4
          .card-header.bg-primary.text-white.py-3.rounded-top-4
            h5.mb-0.fw-bold 
              i.fa-solid.fa-calendar-plus.me-2
              | Solicitar Nuevo Turno
          .card-body.p-4
            form#formReserva(method="POST" action="/pacientes/confirmar-reserva")
              input#agendaIdHidden(type="hidden" name="id_agenda")
              input(type="hidden" name="id_paciente" value=paciente.id_paciente)

              .mb-3
                label.form-label.small.fw-bold.text-uppercase.text-muted Profesional
                .input-group
                  span.input-group-text.bg-light: i.fa-solid.fa-user-doctor.text-primary
                  input#buscarMedico.form-control.bg-light(type="text" placeholder="Buscar médico..." autocomplete="off")
                #sugerenciasMedico.list-group.position-absolute.w-100.shadow-lg.z-3
                input#medicoId(type="hidden" name="id_medico")
              
              .mb-3
                label.form-label.small.fw-bold.text-uppercase.text-muted Especialidad
                select#especialidadSelect.form-select.bg-light(name="id_especialidad" required disabled)
                  option(value="" selected disabled) Primero busca un médico

              .row
                .col-6.mb-3
                  label.form-label.small.fw-bold.text-uppercase.text-muted Fecha
                  input#fecha.form-control.bg-light(type="date" name="fecha" required)
                .col-6.mb-3
                  label.form-label.small.fw-bold.text-uppercase.text-muted Hora
                  input#horaSeleccionadaInput.form-control.bg-white.border-primary.fw-bold(type="text" name="hora_inicio" placeholder="--:--" readonly required)

              hr
              label.form-label.small.fw-bold.text-uppercase.text-muted Disponibilidad
              #slotsContainer.d-flex.flex-wrap.gap-2.mb-4.justify-content-start
                small.text-muted Selecciona profesional y fecha...

              button#btnGuardar.btn.btn-primary.w-100.py-3.fw-bold.text-uppercase.rounded-pill(type="submit" disabled)
                | Confirmar Turno

      //- COLUMNA DERECHA: MIS TURNOS ACTUALES
      .col-xl-7
        .card.border-0.shadow-sm.rounded-4
          .card-header.bg-white.py-3.rounded-top-4.border-bottom
            h5.mb-0.fw-bold 
              i.fa-solid.fa-rectangle-list.me-2.text-success
              | Mis Turnos Agendados
          .card-body
            if turnos && turnos.length > 0
              .table-responsive
                table.table.table-hover.align-middle
                  thead.table-light
                    tr
                      th Fecha / Hora
                      th Especialidad
                      th Médico
                      th Estado
                  tbody
                    each turno in turnos
                      tr
                        td
                          - let fTurno = turno.fecha ? new Date(turno.fecha).toLocaleDateString() : 'Fecha no disponible'
                          div.fw-bold= fTurno
                          small.text-muted= turno.hora
                        td= turno.especialidad_nombre
                        td= (turno.medico_nombre || '') + ' ' + (turno.medico_apellido || '')
                        td
                          span.badge.rounded-pill(class=(turno.estado === 'pendiente' ? 'bg-warning text-dark' : 'bg-success'))= turno.estado
            else
              .text-center.py-5
                i.fa-solid.fa-calendar-day.display-1.text-light.mb-3
                p.text-muted No tienes turnos programados.

  //- =====================================================
  //- MODAL DE PERFIL (CAMPOS SINCRONIZADOS CON TU DB)
  //- =====================================================
  .modal.fade#modalPerfil(tabindex="-1" aria-labelledby="modalPerfilLabel" aria-hidden="true")
    .modal-dialog.modal-dialog-centered
      .modal-content.border-0.shadow-lg.rounded-4
        .modal-header.bg-primary.text-white.rounded-top-4
          h5.modal-title#modalPerfilLabel 
            i.fa-solid.fa-user-circle.me-2
            | Mi Perfil de Paciente
          button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal" aria-label="Close")
        
        form#formEditarPerfil(action="/pacientes/editar-perfil" method="POST")
          .modal-body.p-4
            .text-center.mb-4
              .bg-light.text-primary.rounded-circle.d-inline-flex.align-items-center.justify-content-center.mb-2(style="width: 70px; height: 70px; font-size: 1.5rem; border: 2px solid #0d6efd;")
                | #{paciente.nombre ? paciente.nombre.charAt(0) : 'P'}#{paciente.apellido ? paciente.apellido.charAt(0) : 'U'}
              //- p.small.text-muted ID: ##{paciente.id_paciente}

            .row.g-3
              .col-md-6
                label.form-label.small.fw-bold Nombre
                input.form-control.bg-light(type="text" name="nombre" value=paciente.nombre required)
              .col-md-6
                label.form-label.small.fw-bold Apellido
                input.form-control.bg-light(type="text" name="apellido" value=paciente.apellido required)
              
              .col-12
                label.form-label.small.fw-bold Correo Electrónico
                input.form-control.bg-light(type="email" name="email" value=paciente.email required)
              
              .col-md-6
                label.form-label.small.fw-bold DNI
                input.form-control.bg-light(type="text" value=paciente.dni readonly)
              .col-md-6
                label.form-label.small.fw-bold F. Nacimiento
                //- FIX FINAL: Usamos 'nacimiento' y aseguramos formato YYYY-MM-DD
                - let fechaFormateada = ''
                if paciente.nacimiento
                  - const d = new Date(paciente.nacimiento)
                  if !isNaN(d.getTime())
                    - const year = d.getUTCFullYear()
                    - const month = String(d.getUTCMonth() + 1).padStart(2, '0')
                    - const day = String(d.getUTCDate()).padStart(2, '0')
                    - fechaFormateada = `${year}-${month}-${day}`
                input.form-control.bg-light(type="date" name="nacimiento" value=fechaFormateada required)
              
              .col-12
                label.form-label.small.fw-bold Obra Social
                input.form-control.bg-light(type="text" value=(paciente.obra_social_nombre || 'Particular') readonly)
                small.text-muted.x-small Para cambios de obra social contacte a recepción.

          .modal-footer.border-0.p-4.pt-0
            button.btn.btn-light.rounded-pill.px-4(type="button" data-bs-dismiss="modal") Cancelar
            button.btn.btn-primary.rounded-pill.px-4(type="submit") Guardar Cambios

  style.
    .card { transition: all 0.3s ease; }
    .list-group.position-absolute { max-height: 200px; overflow-y: auto; z-index: 1050; width: 90% !important; }
    .slot-hora {
      width: 80px; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px 0;
      text-align: center; cursor: pointer; background: #f8f9fa; font-size: 0.85rem; font-weight: bold;
    }
    .slot-hora:hover:not(.ocupado) { border-color: #0d6efd; background: #e7f1ff; }
    .slot-hora.selected { background: #0d6efd !important; color: white !important; border-color: #0d6efd; }
    .slot-hora.ocupado { cursor: not-allowed; opacity: 0.3; background: #eee; }
    .btn-white:hover { transform: rotate(30deg); transition: 0.3s; background: #f8f9fa; }
    .x-small { font-size: 0.75rem; }

  script.
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);

      if (urlParams.get('status') === 'success') {
          Swal.fire({ title: '¡Turno Confirmado!', icon: 'success', confirmButtonColor: '#0d6efd' });
      }
      if (urlParams.get('status') === 'profile_updated') {
          Swal.fire({ title: 'Perfil Actualizado', icon: 'success', timer: 2000, showConfirmButton: false });
      }

      const fechaInput = document.getElementById('fecha');
      const hoy = new Date().toISOString().split('T')[0];
      if(fechaInput) fechaInput.setAttribute('min', hoy);

      const inputMed = document.getElementById('buscarMedico');
      const suggMed = document.getElementById('sugerenciasMedico');
      const hiddenMed = document.getElementById('medicoId');
      const espSelect = document.getElementById('especialidadSelect');

      if(inputMed) {
        inputMed.addEventListener('input', async () => {
          const query = inputMed.value.trim();
          if (query.length < 2) { suggMed.innerHTML = ''; return; }
          const res = await fetch(`/medicos/buscar?q=${query}`);
          const data = await res.json();
          suggMed.innerHTML = data.map(m => `
            <button type="button" class="list-group-item list-group-item-action" data-id="${m.id_medico}" data-name="${m.nombre} ${m.apellido}">
              ${m.nombre} ${m.apellido}
            </button>`).join('');

          suggMed.querySelectorAll('button').forEach(btn => {
            btn.onclick = async () => {
              inputMed.value = btn.dataset.name;
              hiddenMed.value = btn.dataset.id;
              suggMed.innerHTML = '';
              espSelect.disabled = false;
              const respEsp = await fetch(`/medicos/${btn.dataset.id}/especialidades`);
              const esps = await respEsp.json();
              espSelect.innerHTML = '<option value="" selected disabled>Selecciona especialidad</option>' + 
                esps.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
              buscarDisponibilidad();
            };
          });
        });
      }

      async function buscarDisponibilidad() {
        const id_medico = hiddenMed.value;
        const id_especialidad = espSelect.value;
        const fecha = fechaInput.value;
        if (!id_medico || !id_especialidad || !fecha) return;

        const slotsContainer = document.getElementById('slotsContainer');
        slotsContainer.innerHTML = '<small class="text-primary">Buscando horarios...</small>';

        try {
          const res = await fetch(`/secretaria/disponibilidad?id_medico=${id_medico}&id_especialidad=${id_especialidad}&fecha=${fecha}`);
          const data = await res.json();
          
          if (data.status === 'success' && data.horarios) {
            slotsContainer.innerHTML = data.horarios.map(h => `
              <div class="slot-hora ${h.ocupado ? 'ocupado' : ''}" data-hora="${h.hora}" data-agenda="${h.id_agenda}">
                ${h.hora}
              </div>`).join('');

            document.querySelectorAll('.slot-hora').forEach(slot => {
              slot.addEventListener('click', function() {
                if (this.classList.contains('ocupado')) return;
                document.querySelectorAll('.slot-hora').forEach(s => s.classList.remove('selected'));
                this.classList.add('selected');
                document.getElementById('horaSeleccionadaInput').value = this.dataset.hora;
                document.getElementById('agendaIdHidden').value = this.dataset.agenda;
                document.getElementById('btnGuardar').disabled = false;
              });
            });
          } else {
            slotsContainer.innerHTML = '<small class="text-danger">Sin turnos disponibles.</small>';
          }
        } catch (err) { slotsContainer.innerHTML = 'Error al cargar.'; }
      }

      if(espSelect) espSelect.addEventListener('change', buscarDisponibilidad);
      if(fechaInput) fechaInput.addEventListener('change', buscarDisponibilidad);
    });