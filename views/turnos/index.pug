//- extends ../layout
//- block contenido
//-     style.
//-         .center-text {
//-         text-align: center;
//-         }
//-     script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous")
//-     h1.center-text Turnos
//-     h3= `Turnos del Dr.${turnos.nombre}, ${turnos.apellido}`
//-     br
//-     a(href="/turnos/create" class="btn btn-success") Crear Turno
//-     if mensaje
//-       .alert.alert-success
//-         h1= mensaje  
//-         //- solo para secretaria  if(roll = secretaria){}
//-     p Estado
//-     select(name="estado" class="form-select small-width" ) 
//-         option(value="Libre") Libre
//-         option(value="Reservado") Reservado
//-         option(value="Confirmado") Confirmado
//-         option(value="Cancelado") Cancelado
//-         option(value="Ausente") Ausente
//-         option(value="Presente") Presente
//-         option(value="En Consulta") En Consulta
//-         option(value="Atendido") Atendido
//-         option(value="No Disponible") No Disponible  
//-     table#example
//-         thead 
//-             tr 
//-                 th Id
//-                 th N° Agenda
//-                 th Fecha
//-                 th Hora Inicio
//-                 th Motivo
//-                 th Estado 
//-                 th Orden
//-                 th Paciente
//-                 th Acciones                
//-         tbody 
//-             each turno in turnos 
//-                 tr 
//-                     td= turno.id
//-                     td= turno.id_agenda
//-                     td= turno.fecha
//-                     td= `${turno.hora_inicio} hs`
//-                         -if (turno.motivo)
//-                             td= turno.motivo 
//-                         -else 
//-                             td Vacío
//-                     td= turno.estado
//-                     td= turno.orden
//-                         -if (turno.id_paciente)
//-                             td= turno.id_paciente 
//-                         -else 
//-                             td Vacío
//-                     td
//-                        a(href=`/turnos/${turnos.id}` class="btn btn-success") Reservar
//-                        a(href=`/turnos/edit/${turnos.id}` class="btn btn-info") Editar
                       
extends ../layout

block contenido
    style.
        body {
            background-color: #eef5ff;
            font-family: Arial, sans-serif;
        }
        .center-text {
            text-align: center;
            margin-bottom: 10px;
        }
        .page-container {
            padding: 20px;
        }
        .actions i {
            font-size: 20px;
            cursor: pointer;
            margin-right: 10px;
        }
        .icon-edit {
            color: #1e88e5;
        }
        .icon-delete {
            color: #e53935;
        }
        .icon-reservar {
            color: #43a047;
        }

    // ======================
    // TÍTULO Y SUBTÍTULO
    // ======================
    .page-container

        h1.center-text Turnos

        if turnos && turnos.length > 0
            h3.center-text Turnos del Dr. #{turnos[0].nombre} #{turnos[0].apellido}
        else
            h3.center-text Turnos del Doctor

        br

        a(href="/turnos/create" class="btn btn-success mb-3") Crear Turno

        // ======================
        // MENSAJE SWEET ALERT
        // ======================
        if mensaje
            script.
                Swal.fire({
                    title: 'Mensaje',
                    text: '#{mensaje}',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });

        // ======================
        // FILTRO ESTADO
        // ======================
        p Estado
        select(name="estado" id="estado" class="form-select small-width mb-3")
            option(value="") Todos
            option(value="Libre") Libre
            option(value="Reservado") Reservado
            option(value="Confirmado") Confirmado
            option(value="Cancelado") Cancelado
            option(value="Ausente") Ausente
            option(value="Presente") Presente
            option(value="En Consulta") En Consulta
            option(value="Atendido") Atendido
            option(value="No Disponible") No Disponible  

        // ======================
        // TABLA
        // ======================
        table#tablaTurnos.table.table-striped.table-bordered
            thead
                tr 
                    th Id
                    th Agenda
                    th Fecha
                    th Hora
                    th Motivo
                    th Estado 
                    th Orden
                    th Paciente
                    th Acciones                
            tbody 
                each turno in turnos
                    tr(data-estado=turno.estado)
                        td= turno.id
                        td= turno.id_agenda
                        td= turno.fecha
                        td= `${turno.hora_inicio} hs`
                        td= turno.motivo || "Vacío"
                        td= turno.estado
                        td= turno.orden
                        td= turno.id_paciente || "Vacío"
                        td.actions
                            a(href=`/turnos/${turno.id}`)
                                i.icon-reservar.fa-solid.fa-calendar-check(title="Reservar")
                            a(href=`/turnos/edit/${turno.id}`)
                                i.icon-edit.fa-solid.fa-pen-to-square(title="Editar")
                            i.icon-delete.fa-solid.fa-trash(title="Eliminar", onclick=`confirmDelete(${turno.id})`)

    // ======================
    // SCRIPTS
    // ======================
    script.
        function confirmDelete(id) {
            Swal.fire({
                title: '¿Eliminar turno?',
                text: "No podrás revertir esto",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar'
            }).then((result) => {
                if (result.isConfirmed) deleteTurno(id);
            });
        }

        function deleteTurno(id) {
            fetch(`/turnos/${id}`, { method: 'DELETE' })
                .then(res => {
                    if (!res.ok) throw new Error();
                    Swal.fire('Eliminado', 'El turno ha sido eliminado.', 'success')
                        .then(() => location.reload());
                })
                .catch(() => Swal.fire('Error', 'Hubo un problema eliminando el turno.', 'error'));
        }

        // Filtrar por estado
        document.getElementById("estado").addEventListener("change", function () {
            const estado = this.value;
            document.querySelectorAll("#tablaTurnos tbody tr").forEach(row => {
                if (!estado || row.dataset.estado === estado)
                    row.style.display = "";
                else
                    row.style.display = "none";
            });
        });
