extends ../layout

block contenido
    style.
        body {
            background-color: #eef5ff;
            font-family: Arial, sans-serif;
        }
        .center-text {
            text-align: center;
            margin-bottom: 10px;
        }
        .page-container {
            padding: 20px;
        }
        .actions i {
            font-size: 20px;
            cursor: pointer;
            margin-right: 10px;
        }
        .icon-edit {
            color: #1e88e5;
        }
        .icon-delete {
            color: #e53935;
        }
        .icon-reservar {
            color: #43a047;
        }

    .page-container

        // ---------------- BOTÓN VOLVER (IZQUIERDA) ----------------
        .mb-3
            a.btn.btn-secondary(href="/agendas") ⬅ Volver a Agendas
        // ----------------------------------------------------------

        h1.center-text Turnos

        // -------------------- NOMBRE DEL MÉDICO --------------------
        if turnos && turnos.length > 0
            - const medicoNombre = turnos[0].nombre || "Doctor"
            - const medicoApellido = turnos[0].apellido || ""
            h3.center-text Turnos del Dr. #{medicoNombre} #{medicoApellido}
        else
            h3.center-text Turnos del Doctor

        br

        if mensaje
            script.
                Swal.fire({
                    title: 'Mensaje',
                    text: '#{mensaje}',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });

        p Estado
        select(name="estado" id="estado" class="form-select small-width mb-3")
            option(value="") Todos
            option(value="Libre") Libre
            option(value="Reservado") Reservado
            option(value="Confirmado") Confirmado
            option(value="Cancelado") Cancelado
            option(value="Ausente") Ausente
            option(value="Presente") Presente
            option(value="En Consulta") En Consulta
            option(value="Atendido") Atendido
            option(value="No Disponible") No Disponible  

        table#tablaTurnos.table.table-striped.table-bordered
            thead
                tr 
                    th Fecha
                    th Hora
                    th Motivo
                    th Estado 
                    th Orden
                    th Paciente
                    th DNI
                    th Acciones                
            tbody 
                each turno in turnos
                    tr(data-estado=turno.estado)
                        td= turno.fecha_formateada
                        td= `${turno.hora_inicio} hs`
                        td= turno.motivo || "Vacío"
                        td= turno.estado
                        td= turno.orden
                        td= turno.paciente_nombre || 'Vacío'
                        td= turno.id_paciente || 'Vacío'
                        td.actions
                            a(href=`/turnos/reservar/${turno.id}`)
                                i.icon-reservar.fa-solid.fa-calendar-check(title="Reservar")
                            a(href=`/turnos/edit/${turno.id}`)
                                i.icon-edit.fa-solid.fa-pen-to-square(title="Editar")
                            i.icon-delete.fa-solid.fa-trash(title="Eliminar", onclick=`confirmDelete(${turno.id})`)

    script.
        function confirmDelete(id) {
            Swal.fire({
                title: '¿Eliminar turno?',
                text: "No podrás revertir esto",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar'
            }).then((result) => {
                if (result.isConfirmed) deleteTurno(id);
            });
        }

        function deleteTurno(id) {
            fetch(`/turnos/${id}`, { method: 'DELETE' })
                .then(res => {
                    if (!res.ok) throw new Error();
                    Swal.fire('Eliminado', 'El turno ha sido eliminado.', 'success')
                        .then(() => location.reload());
                })
                .catch(() => Swal.fire('Error', 'Hubo un problema eliminando el turno.', 'error'));
        }

        document.getElementById("estado").addEventListener("change", function () {
            const estado = this.value;
            document.querySelectorAll("#tablaTurnos tbody tr").forEach(row => {
                if (!estado || row.dataset.estado === estado)
                    row.style.display = "";
                else
                    row.style.display = "none";
            });
        });
