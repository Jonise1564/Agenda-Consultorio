
extends ../layout

block contenido
  style.
    body { background-color:#eef5ff; font-family:Arial,sans-serif; }
    .center-text { text-align:center; margin-bottom:20px; font-size:26px; font-weight:bold; }
    .page-container { padding:20px; }
    .filter-box { background:#fff; padding:15px; border-radius:10px; margin-bottom:20px; box-shadow:0 2px 4px rgba(0,0,0,.1); }

    td.actions { white-space:nowrap; text-align:center; vertical-align:middle; }
    td.actions .btn { margin:0 4px; }



  .page-container
    .mb-3
      a.btn.btn-secondary(href="/agendas") â¬… Volver a Agendas

    if turnos && turnos.length
      h3.center-text Turnos del Dr/a. #{turnos[0].medico_apellido} #{turnos[0].medico_nombre}

    else
      h3.center-text Turnos del Doctor

    // ===================== FILTROS =====================
    .filter-box
      h4 Filtros
      .row.g-3
        .col-md-2
          label Fecha
          input.form-control(type="date" id="f-fecha")
        .col-md-2
          label Hora
          input.form-control(type="time" id="f-hora")
        .col-md-2
          label Estado
          select.form-select(id="f-estado")
            option(value="") Todos
            each e in ['No disponible','Libre','Sobreturno','Reservado','Confirmado','Cancelado','Ausente','Presente','En consulta','Atendido']
              option= e
        .col-md-2
          label Orden
          input.form-control(type="number" id="f-orden")
        .col-md-2
          label Paciente
          input.form-control(type="text" id="f-paciente")
        .col-md-2
          label DNI
          input.form-control(type="text" id="f-dni")

      .mt-3.text-end
        button.btn.btn-primary(onclick="applyFilters()") Filtrar
        button.btn.btn-secondary.ms-2(onclick="clearFilters()") Limpiar

    // ===================== TABLA =====================
    table#tablaTurnos.table.table-bordered.table-hover
      thead.table-dark
        tr
          th Fecha
          th Hora
          th Motivo
          th Estado
          th Orden
          th Paciente
          th DNI
          th Acciones

      tbody
        each turno in turnos
          tr(
            data-fecha=turno.fecha_iso
            data-hora=turno.hora_inicio.slice(0,5)
            data-estado=turno.estado
            data-orden=turno.orden
            data-paciente=turno.paciente_nombre || ''
            data-dni=turno.dni || ''
          )
            td= turno.fecha_formateada
            td= turno.hora_inicio.slice(0,5)
            td= turno.motivo || 'â€”'
            td= turno.estado
            td= turno.orden
            td= turno.paciente_apellido ? `${turno.paciente_apellido} ${turno.paciente_nombre}` : 'â€”'
            td= turno.dni || 'â€”'

            td.actions
              - const estado = (turno.estado || '').trim().toLowerCase()

              // ðŸ“… RESERVAR â†’ SOLO Libre o Sobreturno
              if ['libre','sobreturno'].includes(estado)
                a.btn.btn-success.btn-sm(
                  href=`/turnos/reservar/${turno.id}`
                  title="Reservar turno"
                )
                  i.fa-solid.fa-calendar-check.fa-lg

              // âœï¸ EDITAR â†’ TODOS MENOS No disponible, Libre y Sobreturno
              if !['no disponible','libre','sobreturno'].includes(estado)
                a.btn.btn-primary.btn-sm(
                  href=`/turnos/reservar/${turno.id}`
                  title="Editar turno"
                )
                  i.fa-solid.fa-pen-to-square.fa-lg

              // ðŸ—‘ ELIMINAR â†’ SIEMPRE
              button.btn.btn-danger.btn-sm(
                title="Eliminar turno"
                onclick=`confirmDelete(${turno.id})`
              )
                i.fa-solid.fa-trash.fa-lg

  // ===================== SCRIPTS =====================
  script.
    function applyFilters() {
      const v = id => document.getElementById(id).value;
      document.querySelectorAll('#tablaTurnos tbody tr').forEach(row => {
        const ok =
          (!v('f-fecha') || row.dataset.fecha === v('f-fecha')) &&
          (!v('f-hora') || row.dataset.hora === v('f-hora')) &&
          (!v('f-estado') || row.dataset.estado === v('f-estado')) &&
          (!v('f-orden') || row.dataset.orden === v('f-orden')) &&
          (!v('f-paciente') || row.dataset.paciente.toLowerCase().includes(v('f-paciente').toLowerCase())) &&
          (!v('f-dni') || row.dataset.dni === v('f-dni'));
        row.style.display = ok ? '' : 'none';
      });
    }

    function clearFilters() {
      document.querySelectorAll('.filter-box input, .filter-box select')
        .forEach(e => e.value = '');
      applyFilters();
    }

    function confirmDelete(id) {
      Swal.fire({
        title: 'Â¿Eliminar turno?',
        text: 'Esta acciÃ³n no se puede deshacer',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Eliminar',
        cancelButtonText: 'Cancelar'
      }).then(r => {
        if (r.isConfirmed) {
          fetch(`/turnos/${id}`, { method: 'DELETE' })
            .then(() => location.reload());
        }
      });
    }
