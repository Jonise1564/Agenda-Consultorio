//- extends ../layout

//- block contenido
//-   //- --- ESTILOS PARA IMPRESIÓN ---
//-   style.
//-     @media print {
//-       /* Ocultar todo por defecto al imprimir */
//-       nav, footer, .navbar, .sidebar, .btn, .d-print-none, .alert, .card-body form {
//-         display: none !important;
//-       }
//-       /* Ajustar el contenedor principal */
//-       .container-fluid {
//-         width: 100% !important;
//-         padding: 0 !important;
//-         margin: 0 !important;
//-       }
//-       /* Mostrar solo el título y la tabla */
//-       .card {
//-         border: none !important;
//-         box-shadow: none !important;
//-       }
//-       .table-responsive {
//-         overflow: visible !important;
//-       }
//-       table {
//-         width: 100% !important;
//-         border-collapse: collapse !important;
//-       }
//-       th, td {
//-         border: 1px solid #dee2e6 !important;
//-         padding: 8px !important;
//-         font-size: 12px !important;
//-       }
//-       th {
//-         background-color: #f8f9fa !important;
//-         color: black !important;
//-       }
//-     }

//-   .container-fluid.py-4
//-     //- --- CABECERA ---
//-     .d-flex.justify-content-between.align-items-center.mb-4.d-print-none
//-       div
//-         h2.fw-bold.text-dark 
//-           i.fa-solid.fa-list-check.me-2.text-info
//-           | Gestión de Turnos
//-         p.text-muted.mb-0 Listado general de citas registradas en el sistema.
//-       .d-flex.gap-2
//-         button.btn.btn-dark.shadow-sm(onclick="window.print()")
//-           i.fa-solid.fa-print.me-2
//-           | Imprimir Listado
//-         a.btn.btn-outline-secondary.shadow-sm(href="/secretaria")
//-           i.fa-solid.fa-house-user.me-2
//-           | Volver al Panel

//-     //- Título solo para impresión (oculto en pantalla)
//-     .d-none.d-print-block.text-center.mb-4
//-       h2 Reporte de Turnos Médicos
//-       p Fecha de reporte: #{new Date().toLocaleDateString('es-AR')}

//-     //- --- SECCIÓN DE ALERTAS ---
//-     #contenedorAlertas.d-print-none
//-       if status === 'traslado_success'
//-         .alert.alert-success.alert-dismissible.fade.show.shadow-sm(role="alert")
//-           i.fa-solid.fa-circle-check.me-2
//-           strong ¡Éxito! 
//-           | El turno ha sido movido correctamente.
//-           button.btn-close(type="button" data-bs-dismiss="alert")
//-       if status === 'error_no_agenda'
//-         .alert.alert-danger.alert-dismissible.fade.show.shadow-sm(role="alert")
//-           i.fa-solid.fa-triangle-exclamation.me-2
//-           strong Error de Agenda: 
//-           | El médico no atiende en esa fecha o no tiene horarios cargados.
//-           button.btn-close(type="button" data-bs-dismiss="alert")

//-     //- --- FILTROS ---
//-     .card.border-0.shadow-sm.mb-4.d-print-none
//-       .card-body.bg-light.rounded
//-         form.row.g-3(method="GET" action="/secretaria/turnos")
//-           .col-md-3
//-             label.form-label.small.fw-bold Paciente / DNI
//-             input.form-control(type="text" name="paciente" placeholder="Ej: Camargo..." value=filtros.paciente)
//-           .col-md-3
//-             label.form-label.small.fw-bold Profesional
//-             input.form-control(type="text" name="profesional" placeholder="Ej: Benitez..." value=filtros.profesional)
//-           .col-md-3
//-             label.form-label.small.fw-bold Fecha
//-             input.form-control(type="date" name="fecha" value=filtros.fecha)
//-           .col-md-3.d-flex.align-items-end.gap-2
//-             button.btn.btn-info.text-white.flex-fill(type="submit")
//-               i.fa-solid.fa-magnifying-glass.me-1
//-               | Filtrar
//-             a.btn.btn-secondary.flex-fill(href="/secretaria/turnos")
//-               i.fa-solid.fa-eraser.me-1
//-               | Limpiar

//-     //- --- TABLA ---
//-     .card.border-0.shadow-sm
//-       .table-responsive
//-         table.table.table-hover.align-middle.mb-0
//-           thead.text-white(style="background-color: #5bc0de;")
//-             tr
//-               th Turno para
//-               th Médico
//-               th Especialidad
//-               th.text-center Fecha
//-               th.text-center Hora
//-               th.text-center Estado
//-               th.d-print-none Acciones
//-           tbody
//-             if turnos && turnos.length > 0
//-               each turno in turnos
//-                 tr(class=turno.estado === 'Reservado' ? 'table-warning' : '')
//-                   td
//-                     .fw-bold.text-uppercase #{turno.paciente_apellido}, #{turno.paciente_nombre}
//-                     small.text-muted DNI: #{turno.paciente_dni}
//-                   td #{turno.medico_apellido}, #{turno.medico_nombre}
//-                   td: span.badge.bg-light.text-dark.border #{turno.especialidad_nombre}
//-                   td.text-center #{new Date(turno.fecha).toLocaleDateString('es-AR')}
//-                   td.text-center: span.fw-bold #{turno.hora}
//-                   td.text-center
//-                     span.badge(class=(turno.estado === 'Reservado' ? 'bg-warning text-dark' : (turno.estado === 'Confirmado' ? 'bg-success' : 'bg-secondary'))) #{turno.estado}
//-                   td.d-print-none
//-                     .d-grid.gap-1
//-                       button.btn.btn-sm.btn-primary(onclick=`abrirModalTraslado('${turno.id}', '${turno.paciente_nombre} ${turno.paciente_apellido}')`) 
//-                         i.fa-solid.fa-arrow-right-arrow-left.me-1
//-                         | Trasladar
//-                       button.btn.btn-sm.btn-outline-info(onclick=`verDetallesTurno(${JSON.stringify(turno)})`) 
//-                         i.fa-solid.fa-eye.me-1
//-                         | Detalles
//-             else
//-               tr
//-                 td.text-center.py-5(colspan="7") No se encontraron turnos.

//-   //- --- MODAL TRASLADO ---
//-   #modalTrasladoIndividual.modal.fade(tabindex="-1")
//-     .modal-dialog
//-       .modal-content.border-0.shadow-lg
//-         .modal-header.bg-primary.text-white
//-           h5.modal-title Trasladar Paciente
//-           button.btn-close.btn-close-white(data-bs-dismiss="modal")
//-         .modal-body
//-           form(action="/secretaria/trasladar-turno" method="POST")
//-             input#trasladoTurnoId(type="hidden" name="id_turno")
//-             p.mb-3 Moviendo a: 
//-               strong#nombrePacienteTraslado -
//-             .mb-3
//-               label.form-label Médico Destino
//-               select.form-select(name="id_medico_destino" required)
//-                 option(value="" disabled selected) Seleccione médico...
//-                 if medicos
//-                   each med in medicos
//-                     - var valId = med.id_medico || med.id || med.id_profesional
//-                     option(value=valId) #{med.apellido}, #{med.nombre}
//-             .row
//-               .col-6
//-                 label.form-label Nueva Fecha
//-                 input#trasladoFecha.form-control(type="date" name="nueva_fecha" required)
//-               .col-6
//-                 label.form-label Nueva Hora
//-                 input.form-control(type="time" name="nueva_hora" required)
//-             .mt-4.d-grid
//-               button.btn.btn-primary(type="submit") Confirmar Traslado

//-   //- --- MODAL DETALLES ---
//-   #modalDetallesTurno.modal.fade(tabindex="-1")
//-     .modal-dialog.modal-lg
//-       .modal-content.border-0.shadow-lg
//-         .modal-header.bg-info.text-white
//-           h5.modal-title Detalles del Turno
//-           button.btn-close.btn-close-white(data-bs-dismiss="modal")
//-         .modal-body
//-           .row
//-             .col-md-6
//-               h6.fw-bold.text-primary Datos Paciente
//-               p.mb-1#det-paciente-nombre
//-               p.mb-1#det-paciente-dni
//-             .col-md-6
//-               h6.fw-bold.text-primary Datos Turno
//-               p.mb-1#det-medico
//-               p.mb-1#det-fecha-hora
//-           hr
//-           .text-center
//-             h6.fw-bold Foto DNI
//-             img#fotoDniPreview.img-fluid.rounded.shadow-sm(style="max-height: 300px; display:none;")
//-             #sinFotoDni.alert.alert-light.border No hay foto.
//-         .modal-footer
//-           button.btn.btn-secondary(data-bs-dismiss="modal") Cerrar

//-   script.
//-     function abrirModalTraslado(id, nombre) {
//-       const modalElement = document.getElementById('modalTrasladoIndividual');
//-       const modal = new bootstrap.Modal(modalElement);
//-       document.getElementById('trasladoTurnoId').value = id;
//-       document.getElementById('nombrePacienteTraslado').innerText = nombre;
//-       const fechaFiltro = document.querySelector('input[name="fecha"]').value;
//-       if(fechaFiltro) document.getElementById('trasladoFecha').value = fechaFiltro;
//-       modal.show();
//-     }
//-     function verDetallesTurno(turno) {
//-       const modal = new bootstrap.Modal(document.getElementById('modalDetallesTurno'));
//-       document.getElementById('det-paciente-nombre').innerText = `Nombre: ${turno.paciente_apellido}, ${turno.paciente_nombre}`;
//-       document.getElementById('det-paciente-dni').innerText = `DNI: ${turno.paciente_dni}`;
//-       document.getElementById('det-medico').innerText = `Médico: ${turno.medico_apellido}`;
//-       document.getElementById('det-fecha-hora').innerText = `Cita: ${new Date(turno.fecha).toLocaleDateString()} - ${turno.hora}`;
//-       const img = document.getElementById('fotoDniPreview');
//-       const alertDiv = document.getElementById('sinFotoDni');
//-       if (turno.archivo_dni) {
//-         img.src = `/uploads/dnis/${turno.archivo_dni.split(/[\\\/]/).pop()}`;
//-         img.style.display = 'inline-block';
//-         alertDiv.style.display = 'none';
//-       } else {
//-         img.style.display = 'none';
//-         alertDiv.style.display = 'block';
//-       }
//-       modal.show();
//-     }
//-     window.addEventListener('load', function() {
//-       const params = new URLSearchParams(window.location.search);
//-       const status = params.get('status');
//-       if (status) {
//-         const mensajes = {
//-           'error_no_agenda': "❌ ERROR: El médico no tiene agenda disponible para esa fecha.",
//-           'error_turno_ocupado': "⚠️ ¡HORARIO OCUPADO! El médico ya tiene un turno a esa hora.",
//-           'traslado_success': "✅ ÉXITO: El turno ha sido trasladado correctamente."
//-         };
//-         if (mensajes[status]) alert(mensajes[status]);
//-         window.history.replaceState({}, document.title, window.location.pathname);
//-       }
//-     });


extends ../layout

block contenido
  //- --- ESTILOS PARA IMPRESIÓN Y UI ---
  style.
    @media print {
      nav, footer, .navbar, .sidebar, .btn, .d-print-none, .alert, .card-body form {
        display: none !important;
      }
      .container-fluid { width: 100% !important; padding: 0 !important; margin: 0 !important; }
      .card { border: none !important; box-shadow: none !important; }
      .table-responsive { overflow: visible !important; }
      table { width: 100% !important; border-collapse: collapse !important; }
      th, td { border: 1px solid #dee2e6 !important; padding: 8px !important; font-size: 12px !important; }
      th { background-color: #f8f9fa !important; color: black !important; }
    }
    /* Estilo para indicar que la foto es cliqueable */
    #fotoDniPreview {
      cursor: zoom-in;
      transition: transform 0.2s;
    }
    #fotoDniPreview:hover {
      transform: scale(1.02);
    }

  .container-fluid.py-4
    //- --- CABECERA ---
    .d-flex.justify-content-between.align-items-center.mb-4.d-print-none
      div
        h2.fw-bold.text-dark 
          i.fa-solid.fa-list-check.me-2.text-info
          | Gestión de Turnos
        p.text-muted.mb-0 Listado general de citas registradas en el sistema.
      .d-flex.gap-2
        button.btn.btn-dark.shadow-sm(onclick="window.print()")
          i.fa-solid.fa-print.me-2
          | Imprimir Listado
        a.btn.btn-outline-secondary.shadow-sm(href="/secretaria")
          i.fa-solid.fa-house-user.me-2
          | Volver al Panel

    .d-none.d-print-block.text-center.mb-4
      h2 Reporte de Turnos Médicos
      p Fecha de reporte: #{new Date().toLocaleDateString('es-AR')}

    //- --- SECCIÓN DE ALERTAS ---
    #contenedorAlertas.d-print-none
      if status === 'traslado_success'
        .alert.alert-success.alert-dismissible.fade.show.shadow-sm(role="alert")
          i.fa-solid.fa-circle-check.me-2
          strong ¡Éxito! 
          | El turno ha sido movido correctamente.
          button.btn-close(type="button" data-bs-dismiss="alert")
      if status === 'error_no_agenda'
        .alert.alert-danger.alert-dismissible.fade.show.shadow-sm(role="alert")
          i.fa-solid.fa-triangle-exclamation.me-2
          strong Error de Agenda: 
          | El médico no atiende en esa fecha.
          button.btn-close(type="button" data-bs-dismiss="alert")

    //- --- FILTROS ---
    .card.border-0.shadow-sm.mb-4.d-print-none
      .card-body.bg-light.rounded
        form.row.g-3(method="GET" action="/secretaria/turnos")
          .col-md-3
            label.form-label.small.fw-bold Paciente / DNI
            input.form-control(type="text" name="paciente" placeholder="Ej: Camargo..." value=filtros.paciente)
          .col-md-3
            label.form-label.small.fw-bold Profesional
            input.form-control(type="text" name="profesional" placeholder="Ej: Benitez..." value=filtros.profesional)
          .col-md-3
            label.form-label.small.fw-bold Fecha
            input.form-control(type="date" name="fecha" value=filtros.fecha)
          .col-md-3.d-flex.align-items-end.gap-2
            button.btn.btn-info.text-white.flex-fill(type="submit")
              i.fa-solid.fa-magnifying-glass.me-1
              | Filtrar
            a.btn.btn-secondary.flex-fill(href="/secretaria/turnos")
              i.fa-solid.fa-eraser.me-1
              | Limpiar

    //- --- TABLA ---
    .card.border-0.shadow-sm
      .table-responsive
        table.table.table-hover.align-middle.mb-0
          thead.text-white(style="background-color: #5bc0de;")
            tr
              th Turno para
              th Médico
              th Especialidad
              th.text-center Fecha
              th.text-center Hora
              th.text-center Estado
              th.d-print-none Acciones
          tbody
            if turnos && turnos.length > 0
              each turno in turnos
                tr(class=turno.estado === 'Reservado' ? 'table-warning' : '')
                  td
                    .fw-bold.text-uppercase #{turno.paciente_apellido}, #{turno.paciente_nombre}
                    small.text-muted DNI: #{turno.paciente_dni}
                  td #{turno.medico_apellido}, #{turno.medico_nombre}
                  td: span.badge.bg-light.text-dark.border #{turno.especialidad_nombre}
                  td.text-center #{new Date(turno.fecha).toLocaleDateString('es-AR')}
                  td.text-center: span.fw-bold #{turno.hora}
                  td.text-center
                    span.badge(class=(turno.estado === 'Reservado' ? 'bg-warning text-dark' : (turno.estado === 'Confirmado' ? 'bg-success' : 'bg-secondary'))) #{turno.estado}
                  td.d-print-none
                    .d-grid.gap-1
                      button.btn.btn-sm.btn-primary(onclick=`abrirModalTraslado('${turno.id}', '${turno.paciente_nombre} ${turno.paciente_apellido}')`) 
                        i.fa-solid.fa-arrow-right-arrow-left.me-1
                        | Trasladar
                      button.btn.btn-sm.btn-outline-info(onclick=`verDetallesTurno(${JSON.stringify(turno)})`) 
                        i.fa-solid.fa-eye.me-1
                        | Detalles
            else
              tr: td.text-center.py-5(colspan="7") No se encontraron turnos.

  //- --- MODAL TRASLADO ---
  #modalTrasladoIndividual.modal.fade(tabindex="-1")
    .modal-dialog
      .modal-content.border-0.shadow-lg
        .modal-header.bg-primary.text-white
          h5.modal-title Trasladar Paciente
          button.btn-close.btn-close-white(data-bs-dismiss="modal")
        .modal-body
          form(action="/secretaria/trasladar-turno" method="POST")
            input#trasladoTurnoId(type="hidden" name="id_turno")
            p.mb-3 Moviendo a: 
              strong#nombrePacienteTraslado -
            .mb-3
              label.form-label Médico Destino
              select.form-select(name="id_medico_destino" required)
                option(value="" disabled selected) Seleccione médico...
                if medicos
                  each med in medicos
                    - var valId = med.id_medico || med.id || med.id_profesional
                    option(value=valId) #{med.apellido}, #{med.nombre}
            .row
              .col-6
                label.form-label Nueva Fecha
                input#trasladoFecha.form-control(type="date" name="nueva_fecha" required)
              .col-6
                label.form-label Nueva Hora
                input.form-control(type="time" name="nueva_hora" required)
            .mt-4.d-grid
              button.btn.btn-primary(type="submit") Confirmar Traslado

  //- --- MODAL DETALLES ---
  #modalDetallesTurno.modal.fade(tabindex="-1")
    .modal-dialog.modal-lg
      .modal-content.border-0.shadow-lg
        .modal-header.bg-info.text-white
          h5.modal-title Detalles del Turno
          button.btn-close.btn-close-white(data-bs-dismiss="modal")
        .modal-body
          .row
            .col-md-6
              h6.fw-bold.text-primary Datos Paciente
              p.mb-1#det-paciente-nombre
              p.mb-1#det-paciente-dni
            .col-md-6
              h6.fw-bold.text-primary Datos Turno
              p.mb-1#det-medico
              p.mb-1#det-fecha-hora
          hr
          .text-center
            h6.fw-bold Foto DNI (Click para ampliar)
            //- Enlace para abrir la foto en grande
            a#linkFotoDni(target="_blank")
              img#fotoDniPreview.img-fluid.rounded.shadow-sm(style="max-height: 350px; display:none;" title="Ver imagen completa")
            #sinFotoDni.alert.alert-light.border No hay foto cargada.
        .modal-footer
          button.btn.btn-secondary(data-bs-dismiss="modal") Cerrar

  script.
    function abrirModalTraslado(id, nombre) {
      const modalElement = document.getElementById('modalTrasladoIndividual');
      const modal = new bootstrap.Modal(modalElement);
      document.getElementById('trasladoTurnoId').value = id;
      document.getElementById('nombrePacienteTraslado').innerText = nombre;
      const fechaFiltro = document.querySelector('input[name="fecha"]').value;
      if(fechaFiltro) document.getElementById('trasladoFecha').value = fechaFiltro;
      modal.show();
    }

    function verDetallesTurno(turno) {
      const modal = new bootstrap.Modal(document.getElementById('modalDetallesTurno'));
      
      // Llenar información textual
      document.getElementById('det-paciente-nombre').innerText = `Nombre: ${turno.paciente_apellido}, ${turno.paciente_nombre}`;
      document.getElementById('det-paciente-dni').innerText = `DNI: ${turno.paciente_dni}`;
      document.getElementById('det-medico').innerText = `Médico: ${turno.medico_apellido}`;
      document.getElementById('det-fecha-hora').innerText = `Cita: ${new Date(turno.fecha).toLocaleDateString('es-AR')} - ${turno.hora}`;
      
      const img = document.getElementById('fotoDniPreview');
      const link = document.getElementById('linkFotoDni');
      const alertDiv = document.getElementById('sinFotoDni');
      
      if (turno.archivo_dni) {
        // Limpiamos la ruta por si viene con barras invertidas del sistema de archivos
        const nombreLimpio = turno.archivo_dni.split(/[\\\/]/).pop();
        const rutaImagen = `/uploads/dnis/${nombreLimpio}`;
        
        img.src = rutaImagen;
        link.href = rutaImagen; // El link apunta a la misma imagen
        
        img.style.display = 'inline-block';
        alertDiv.style.display = 'none';
      } else {
        img.style.display = 'none';
        link.href = "#";
        alertDiv.style.display = 'block';
      }
      modal.show();
    }

    window.addEventListener('load', function() {
      const params = new URLSearchParams(window.location.search);
      const status = params.get('status');
      if (status) {
        const mensajes = {
          'error_no_agenda': "❌ ERROR: El médico no tiene agenda disponible.",
          'error_turno_ocupado': "⚠️ ¡HORARIO OCUPADO!",
          'traslado_success': "✅ ÉXITO: El turno ha sido trasladado correctamente."
        };
        if (mensajes[status]) alert(mensajes[status]);
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    });