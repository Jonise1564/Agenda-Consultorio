extends ../layout

block contenido
  //- --- ESTILOS PARA IMPRESIÓN Y UI ---
  style.
    @media print {
      nav, footer, .navbar, .sidebar, .btn, .d-print-none, .alert, .card-body form, .card-footer {
        display: none !important;
      }
      .container-fluid { width: 100% !important; padding: 0 !important; margin: 0 !important; }
      .card { border: none !important; box-shadow: none !important; }
      .table-responsive { overflow: visible !important; }
      table { width: 100% !important; border-collapse: collapse !important; }
      th, td { border: 1px solid #dee2e6 !important; padding: 8px !important; font-size: 12px !important; }
      th { background-color: #f8f9fa !important; color: black !important; }
    }
    #fotoDniPreview {
      cursor: zoom-in;
      transition: transform 0.2s;
    }
    #fotoDniPreview:hover {
      transform: scale(1.02);
    }
    .fila-ausencia {
      border-left: 5px solid #ffc107 !important;
    }
    .fila-sobreturno {
      background-color: #f8f9fa !important;
      border-left: 5px solid #343a40 !important;
    }
    .badge-sobreturno {
      font-size: 0.7rem;
      vertical-align: middle;
      background-color: #343a40;
      color: white;
    }
    .nav-tabs .nav-link {
      color: #6c757d;
      font-weight: bold;
    }
    .nav-tabs .nav-link.active {
      color: #0d6efd;
      border-bottom: 3px solid #0d6efd;
    }

  .container-fluid.py-4
    //- --- CABECERA ---
    .d-flex.justify-content-between.align-items-center.mb-4.d-print-none
      div
        h2.fw-bold.text-dark 
          i.fa-solid.fa-list-check.me-2.text-info
          | Gestión de Turnos
        p.text-muted.mb-0 Listado general de citas (Página #{currentPage} de #{totalPages})
      .d-flex.gap-2
        button.btn.btn-dark.shadow-sm(onclick="window.print()")
          i.fa-solid.fa-print.me-2
          | Imprimir Listado
        a.btn.btn-outline-secondary.shadow-sm(href="/secretaria")
          i.fa-solid.fa-house-user.me-2
          | Volver al Panel

    .d-none.d-print-block.text-center.mb-4
      h2 Reporte de Turnos Médicos
      p Fecha de reporte: #{new Date().toLocaleDateString('es-AR')}

    //- --- SECCIÓN DE ALERTAS ---
    #contenedorAlertas.d-print-none
      if status === 'traslado_success'
        .alert.alert-success.alert-dismissible.fade.show.shadow-sm(role="alert")
          i.fa-solid.fa-circle-check.me-2
          strong ¡Éxito! El turno ha sido movido correctamente.
          button.btn-close(type="button" data-bs-dismiss="alert")
      if status === 'edit_success'
        .alert.alert-info.alert-dismissible.fade.show.shadow-sm(role="alert")
          i.fa-solid.fa-user-pen.me-2
          strong ¡Actualizado! El estado del turno se guardó correctamente.
          button.btn-close(type="button" data-bs-dismiss="alert")
      if status === 'error'
        .alert.alert-danger.alert-dismissible.fade.show.shadow-sm(role="alert")
          i.fa-solid.fa-circle-xmark.me-2
          strong Error: No se pudieron guardar los cambios.
          button.btn-close(type="button" data-bs-dismiss="alert")

    //- --- FILTROS ---
    .card.border-0.shadow-sm.mb-4.d-print-none
      .card-body.bg-light.rounded
        form.row.g-3(method="GET" action="/secretaria/turnos")
          .col-md-2
            label.form-label.small.fw-bold Paciente / DNI
            input.form-control(type="text" name="paciente" placeholder="Ej: Camargo..." value=filtros.paciente)
          .col-md-2
            label.form-label.small.fw-bold Profesional
            input.form-control(type="text" name="profesional" placeholder="Ej: Benitez..." value=filtros.profesional)
          .col-md-2
            label.form-label.small.fw-bold Especialidad
            select.form-select(name="especialidad")
              option(value="") Todas
              if especialidades
                each esp in especialidades
                  option(value=esp.nombre selected=(filtros.especialidad == esp.nombre))= esp.nombre
          .col-md-2
            label.form-label.small.fw-bold Sucursal
            select.form-select(name="sucursal")
              option(value="") Todas
              - let sedes = []
              if turnos && turnos.length > 0
                - sedes = [...new Set(turnos.map(t => t.sucursal_nombre).filter(s => s))]
              each sede in sedes
                option(value=sede selected=(filtros.sucursal === sede))= sede
          .col-md-2
            label.form-label.small.fw-bold Estado
            //- CAMBIO: name="estado" por name="status" para coincidir con el controlador
            select.form-select(name="status")
              option(value="") Todos
              each est in ['Reservado', 'Confirmado', 'Atendido', 'Cancelado', 'Ausente']
                option(value=est selected=(filtros.status == est))= est
          .col-md-2
            label.form-label.small.fw-bold Fecha
            input.form-control(type="date" name="fecha" value=filtros.fecha)
          
          .col-12.d-flex.justify-content-end.gap-2
            button.btn.btn-info.text-white.px-4(type="submit")
              i.fa-solid.fa-magnifying-glass.me-1
              | Filtrar
            a.btn.btn-secondary.px-4(href="/secretaria/turnos")
              i.fa-solid.fa-eraser.me-1
              | Limpiar

    //- --- TABS ---
    ul.nav.nav-tabs.mb-0.border-bottom-0(role="tablist")
      li.nav-item(role="presentation")
        button.nav-link.active(data-bs-toggle="tab" data-bs-target="#tab-activos" type="button" role="tab")
          i.fa-solid.fa-calendar-days.me-2
          | Turnos Activos
      li.nav-item(role="presentation")
        button.nav-link.position-relative(data-bs-toggle="tab" data-bs-target="#tab-reubicacion" type="button" role="tab")
          i.fa-solid.fa-triangle-exclamation.me-2.text-danger
          | Necesitan Reubicación
          if turnosUrgentes && turnosUrgentes.length > 0
            span.position-absolute.top-0.start-100.translate-middle.badge.rounded-pill.bg-danger
              | #{turnosUrgentes.length}

    .tab-content
      .tab-pane.fade.show.active#tab-activos(role="tabpanel")
        .card.border-0.shadow-sm(style="border-top-left-radius: 0;")
          .table-responsive
            table.table.table-hover.align-middle.mb-0
              thead.text-white(style="background-color: #5bc0de;")
                tr
                  th Turno para
                  th Médico
                  th Especialidad
                  th Sucursal
                  th.text-center Fecha
                  th.text-center Hora
                  th.text-center Estado
                  th.d-print-none Acciones
              tbody
                if turnos && turnos.length > 0
                  each turno in turnos
                    tr(class=(turno.medicoAusente ? 'table-warning fila-ausencia' : (turno.es_sobreturno ? 'fila-sobreturno' : (turno.estado === 'Reservado' ? 'table-warning' : ''))))
                      td
                        .fw-bold.text-uppercase #{turno.paciente_apellido}, #{turno.paciente_nombre}
                        div.d-flex.align-items-center.gap-2
                          small.text-muted DNI: #{turno.paciente_dni}
                          if turno.es_sobreturno
                            span.badge.badge-sobreturno
                              i.fa-solid.fa-plus.me-1
                              | SOBRETURNO
                      td 
                        | #{turno.medico_apellido}, #{turno.medico_nombre}
                        if turno.medicoAusente
                          span.badge.bg-danger.ms-2(title=`Motivo: ${turno.motivoAusencia || 'No especificado'}`)
                            i.fa-solid.fa-user-slash.me-1
                            | AUSENTE
                      td: span.badge.bg-light.text-dark.border #{turno.especialidad_nombre}
                      td
                        span.text-muted.small
                          i.fa-solid.fa-location-dot.me-1.text-danger
                          | #{turno.sucursal_nombre || 'N/A'}
                      td.text-center #{new Date(turno.fecha).toLocaleDateString('es-AR')}
                      td.text-center: span.fw-bold #{turno.hora}
                      td.text-center
                        span.badge(class=(turno.estado === 'Reservado' ? 'bg-warning text-dark' : (turno.estado === 'Confirmado' ? 'bg-success' : (turno.estado === 'Atendido' ? 'bg-info' : 'bg-secondary')))) #{turno.estado}
                      td.d-print-none
                        .d-flex.flex-column.gap-1
                          button.btn.btn-sm.btn-warning.shadow-sm(onclick=`abrirModalEditarTurno(${JSON.stringify(turno)})`)
                            i.fa-solid.fa-pen-to-square.me-1
                            | Editar
                          button.btn.btn-sm(class=turno.medicoAusente ? 'btn-danger shadow-sm' : 'btn-primary' onclick=`abrirModalTraslado('${turno.id}', '${turno.paciente_nombre} ${turno.paciente_apellido}')`) 
                            i.fa-solid.fa-arrow-right-arrow-left.me-1
                            | Trasladar
                          button.btn.btn-sm.btn-outline-info(onclick=`verDetallesTurno(${JSON.stringify(turno)})`) 
                            i.fa-solid.fa-eye.me-1
                            | Detalles
                else
                  tr: td.text-center.py-5(colspan="8") No se encontraron turnos.

          .card-footer.bg-white.d-print-none
            if totalPages > 1
              //- CAMBIO: Se usa status en lugar de estado en la query string
              - const queryParams = `&paciente=${filtros.paciente || ''}&profesional=${filtros.profesional || ''}&fecha=${filtros.fecha || ''}&sucursal=${filtros.sucursal || ''}&especialidad=${filtros.especialidad || ''}&status=${filtros.status || ''}`
              nav(aria-label="Paginación")
                ul.pagination.justify-content-center.mb-0
                  li.page-item(class=(currentPage === 1 ? 'disabled' : ''))
                    a.page-link(href=`/secretaria/turnos?page=1${queryParams}`)
                      i.fa-solid.fa-angles-left
                  li.page-item(class=(currentPage === 1 ? 'disabled' : ''))
                    a.page-link(href=`/secretaria/turnos?page=${currentPage - 1}${queryParams}`)
                      i.fa-solid.fa-angle-left

                  - var start = Math.max(1, currentPage - 2)
                  - var end = Math.min(totalPages, currentPage + 2)
                  
                  if start > 1
                    li.page-item.disabled: span.page-link ...

                  - for (var i = start; i <= end; i++)
                    li.page-item(class=(currentPage === i ? 'active' : ''))
                      a.page-link(href=`/secretaria/turnos?page=${i}${queryParams}`)= i

                  if end < totalPages
                    li.page-item.disabled: span.page-link ...

                  li.page-item(class=(currentPage === totalPages ? 'disabled' : ''))
                    a.page-link(href=`/secretaria/turnos?page=${currentPage + 1}${queryParams}`)
                      i.fa-solid.fa-angle-right
                  li.page-item(class=(currentPage === totalPages ? 'disabled' : ''))
                    a.page-link(href=`/secretaria/turnos?page=${totalPages}${queryParams}`)
                      i.fa-solid.fa-angles-right
            
            .text-center.mt-2.small.text-muted
              | Mostrando página #{currentPage} de #{totalPages} (Total: #{totalTurnos} turnos)

      .tab-pane.fade#tab-reubicacion(role="tabpanel")
        .card.border-0.shadow-sm(style="border-top-left-radius: 0;")
          .alert.alert-danger.m-3.mb-0.d-flex.align-items-center
            i.fa-solid.fa-circle-exclamation.fa-2xl.me-3
            div
              strong Atención: 
              | Estos turnos pertenecen a agendas que han sido desactivadas. Debe contactar al paciente para reprogramar.
          
          .table-responsive.p-3
            table.table.table-hover.align-middle
              thead.table-dark
                tr
                  th Paciente
                  th Contacto
                  th Médico Original
                  th Sucursal
                  th Fecha / Hora
                  th.text-center Acciones
              tbody
                if turnosUrgentes && turnosUrgentes.length > 0
                  each tUrge in turnosUrgentes
                    tr
                      td.fw-bold.text-uppercase #{tUrge.paciente_apellido}, #{tUrge.paciente_nombre}
                      td
                        if tUrge.paciente_telefono
                          a.btn.btn-sm.btn-outline-success(href=`https://wa.me/${tUrge.paciente_telefono.replace(/\D/g,'')}` target="_blank")
                            i.fa-brands.fa-whatsapp.me-1
                            | WhatsApp
                        else
                          span.text-muted Sin tel.
                      td Dr. #{tUrge.medico_apellido}
                      td: small.text-muted= tUrge.sucursal_nombre
                      td
                        span.d-block #{new Date(tUrge.fecha).toLocaleDateString('es-AR')}
                        small.fw-bold #{tUrge.hora} hs
                      td.text-center
                        button.btn.btn-sm.btn-primary(onclick=`abrirModalTraslado('${tUrge.id}', '${tUrge.paciente_nombre} ${tUrge.paciente_apellido}')`)
                          i.fa-solid.fa-calendar-plus.me-1
                          | Reubicar Ahora
                else
                  tr: td.text-center.py-5.text-muted(colspan="6") No hay turnos pendientes.

  //- --- MODALES ---
  #modalEditarTurno.modal.fade(tabindex="-1")
    .modal-dialog.modal-dialog-centered
      .modal-content.border-0.shadow-lg
        .modal-header.bg-warning.text-dark
          h5.modal-title 
            i.fa-solid.fa-pen-to-square.me-2
            | Editar Estado
          button.btn-close(data-bs-dismiss="modal")
        .modal-body
          form(action="/secretaria/actualizar-estado-turno" method="POST")
            input#editTurnoId(type="hidden" name="id_turno")
            .mb-3
              label.form-label.fw-bold Estado
              select.form-select.form-select-lg(name="estado" id="editEstado")
                option(value="Reservado") Reservado
                option(value="Confirmado") Confirmado
                option(value="Cancelado") Cancelado
                option(value="Atendido") Atendido
                option(value="Ausente") Ausente
            .mb-3
              label.form-label.fw-bold Observaciones
              textarea.form-control(name="observaciones" id="editObservaciones" rows="3")
            .mt-4.d-grid
              button.btn.btn-warning.fw-bold(type="submit") Actualizar

  #modalTrasladoIndividual.modal.fade(tabindex="-1")
    .modal-dialog.modal-dialog-centered
      .modal-content.border-0.shadow-lg
        .modal-header.bg-primary.text-white
          h5.modal-title Trasladar Paciente
          button.btn-close.btn-close-white(data-bs-dismiss="modal")
        .modal-body
          form(action="/secretaria/trasladar-turno" method="POST")
            input#trasladoTurnoId(type="hidden" name="id_turno")
            p.mb-3 Moviendo a: 
              strong#nombrePacienteTraslado -
            .mb-3
              label.form-label.fw-bold Médico Destino
              select.form-select(name="id_medico_destino" required)
                option(value="" disabled selected) Seleccione médico...
                if medicos
                  each med in medicos
                    option(value=(med.id_medico || med.id)) #{med.apellido}, #{med.nombre}
            .row.g-2
              .col-6
                label.form-label.fw-bold Nueva Fecha
                input#trasladoFecha.form-control(type="date" name="nueva_fecha" required)
              .col-6
                label.form-label.fw-bold Nueva Hora
                input.form-control(type="time" name="nueva_hora" required)
            .mt-4.d-grid
              button.btn.btn-primary.fw-bold(type="submit") Confirmar Traslado

  #modalDetallesTurno.modal.fade(tabindex="-1")
    .modal-dialog.modal-lg.modal-dialog-centered
      .modal-content.border-0.shadow-lg
        .modal-header.bg-info.text-white
          h5.modal-title Detalles del Turno
          button.btn-close.btn-close-white(data-bs-dismiss="modal")
        .modal-body
          .row
            .col-md-6.border-end
              h6.fw-bold.text-primary Datos Paciente
              p.mb-1#det-paciente-nombre
              p.mb-1#det-paciente-dni
            .col-md-6
              h6.fw-bold.text-primary Datos Turno
              p.mb-1#det-medico
              p.mb-1#det-fecha-hora
          hr
          .text-center
            h6.fw-bold Foto DNI
            a#linkFotoDni(target="_blank")
              img#fotoDniPreview.img-fluid.rounded.shadow-sm(style="max-height: 350px; display:none;")
            #sinFotoDni.alert.alert-light.border No hay foto.
        .modal-footer
          button.btn.btn-secondary(data-bs-dismiss="modal") Cerrar

  script.
    function abrirModalEditarTurno(turno) {
      const modal = new bootstrap.Modal(document.getElementById('modalEditarTurno'));
      document.getElementById('editTurnoId').value = turno.id;
      document.getElementById('editEstado').value = turno.estado;
      document.getElementById('editObservaciones').value = turno.observaciones || '';
      modal.show();
    }

    function abrirModalTraslado(id, nombre) {
      const modal = new bootstrap.Modal(document.getElementById('modalTrasladoIndividual'));
      document.getElementById('trasladoTurnoId').value = id;
      document.getElementById('nombrePacienteTraslado').innerText = nombre;
      const fechaFiltro = document.querySelector('input[name="fecha"]').value;
      if(fechaFiltro) document.getElementById('trasladoFecha').value = fechaFiltro;
      modal.show();
    }

    function verDetallesTurno(turno) {
      const modal = new bootstrap.Modal(document.getElementById('modalDetallesTurno'));
      document.getElementById('det-paciente-nombre').innerText = `Nombre: ${turno.paciente_apellido}, ${turno.paciente_nombre}`;
      document.getElementById('det-paciente-dni').innerText = `DNI: ${turno.paciente_dni}`;
      document.getElementById('det-medico').innerText = `Médico: ${turno.medico_apellido}`;
      document.getElementById('det-fecha-hora').innerText = `Cita: ${new Date(turno.fecha).toLocaleDateString('es-AR')} - ${turno.hora}`;
      
      const img = document.getElementById('fotoDniPreview');
      const link = document.getElementById('linkFotoDni');
      const alertDiv = document.getElementById('sinFotoDni');
      
      if (turno.archivo_dni) {
        const nombreLimpio = turno.archivo_dni.split(/[\\\/]/).pop();
        const rutaImagen = `/uploads/dnis/${nombreLimpio}`;
        img.src = rutaImagen;
        link.href = rutaImagen;
        img.style.display = 'inline-block';
        alertDiv.style.display = 'none';
      } else {
        img.style.display = 'none';
        link.href = "#";
        alertDiv.style.display = 'block';
      }
      modal.show();
    }