extends ../layout

block contenido
  script(src="https://cdn.jsdelivr.net/npm/sweetalert2@11")

  .container-fluid.py-4
    .row.mb-4
      .col-md-5
        h2.fw-bold.text-dark
          i.fa-solid.fa-user-slash.me-2.text-secondary
          | Gestión de Ausencias
        p.text-muted Administre los bloqueos de agenda.
      
      .col-md-4.align-self-center
        .input-group.shadow-sm.rounded-pill
          span.input-group-text.bg-white.border-end-0.rounded-start-pill
            i.fa-solid.fa-magnifying-glass.text-muted
          input#busquedaAusencia.form-control.border-start-0.rounded-end-pill(type="text" placeholder="Buscar médico o motivo...")
      
      .col-md-3.text-md-end.align-self-center
        //- a.btn.btn-outline-secondary.rounded-pill.me-2(href="/secretaria")
          i.fa-solid.fa-arrow-left
        a.btn.btn-outline-secondary.shadow-sm(href="/secretaria")
          i.fa-solid.fa-house-user.me-2
          | Volver al Panel
        button.btn.btn-secondary.rounded-pill(type="button" data-bs-toggle="modal" data-bs-target="#modalAusencia")
          i.fa-solid.fa-plus.me-1
          | Nueva

    .card.shadow-sm.border-0.rounded-4
      .card-body.p-0
        .table-responsive
          table#tablaAusencias.table.table-hover.align-middle.mb-0
            thead.bg-light
              tr.text-uppercase.small.fw-bold
                th.ps-4 Profesional
                th Periodo
                th Motivo
                th Observaciones
                th Estado
                th.text-center Acciones
            tbody
              if ausencias && ausencias.length > 0
                each aus in ausencias
                  - const hoy = new Date().setHours(0,0,0,0)
                  - const fin = new Date(aus.fecha_fin).setHours(0,0,0,0)
                  tr.fila-ausencia
                    td.ps-4
                      span.fw-bold.text-dark #{aus.apellido}, #{aus.nombre}
                    td
                      .small
                        i.fa-solid.fa-calendar-day.me-1.text-muted
                        | #{new Date(aus.fecha_inicio).toLocaleDateString('es-AR')} al #{new Date(aus.fecha_fin).toLocaleDateString('es-AR')}
                    td: span.badge.bg-light.text-secondary.border #{aus.tipo}
                    td.small.text-muted #{aus.descripcion || '-'}
                    td
                      if fin < hoy
                        span.badge.bg-secondary.bg-opacity-10.text-secondary Expirada
                      else
                        span.badge.bg-success.bg-opacity-10.text-success Vigente
                    td.text-center
                      .d-flex.justify-content-center.gap-2
                        //- BOTÓN EDITAR (Carga datos en el modal vía data-attributes)
                        button.btn.btn-sm.btn-outline-primary.rounded-circle(
                          type="button" 
                          data-bs-toggle="modal" 
                          data-bs-target="#modalEditarAusencia"
                          data-id=aus.id
                          data-medico=aus.id_medico
                          data-inicio=new Date(aus.fecha_inicio).toISOString().split('T')[0]
                          data-fin=new Date(aus.fecha_fin).toISOString().split('T')[0]
                          data-tipo=aus.tipo
                          data-desc=aus.descripcion
                        )
                          i.fa-solid.fa-pen-to-square

                        form.form-eliminar(action=`/secretaria/ausencias/eliminar/${aus.id}` method="POST")
                          button.btn.btn-sm.btn-outline-danger.rounded-circle(type="button" onclick="confirmarEliminacion(this)")
                            i.fa-solid.fa-trash-can
              else
                tr: td.text-center.py-5(colspan="6") No hay ausencias registradas.

  //- MODAL PARA REGISTRAR (NUEVA)
  #modalAusencia.modal.fade(tabindex="-1" aria-hidden="true")
    .modal-dialog.modal-dialog-centered
      .modal-content.border-0.shadow-lg(style="border-radius: 15px;")
        .modal-header.bg-secondary.text-white.py-3
          h5.modal-title.fw-bold
            i.fa-solid.fa-plus.me-2
            | Registrar Ausencia
          button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
        form(action="/secretaria/ausencias/registrar" method="POST")
          .modal-body.p-4
            .mb-3
              label.form-label.small.fw-bold Profesional
              select.form-select(name="id_medico" required)
                option(value="" disabled selected) Seleccionar médico...
                if medicos
                  each med in medicos
                    option(value=med.id_medico || med.id) #{med.apellido}, #{med.nombre}
            .row
              .col-6.mb-3
                label.form-label.small.fw-bold Desde
                input.form-control(type="date" name="fecha_inicio" required)
              .col-6.mb-3
                label.form-label.small.fw-bold Hasta
                input.form-control(type="date" name="fecha_fin" required)
            .mb-3
              label.form-label.small.fw-bold Motivo
              select.form-select(name="tipo" required)
                option(value="Licencia") Licencia Médica
                option(value="Congreso") Congreso / Capacitación
                option(value="Vacaciones") Vacaciones
                option(value="Particular") Asuntos Particulares
            .mb-3
              label.form-label.small.fw-bold Observaciones
              textarea.form-control(name="descripcion" rows="2" style="resize:none")
          .modal-footer.bg-light
            button.btn.btn-light.rounded-pill(type="button" data-bs-dismiss="modal") Cancelar
            button.btn.btn-secondary.px-4.rounded-pill(type="submit") Bloquear Agenda

  //- MODAL PARA EDITAR
  #modalEditarAusencia.modal.fade(tabindex="-1" aria-hidden="true")
    .modal-dialog.modal-dialog-centered
      .modal-content.border-0.shadow-lg(style="border-radius: 15px;")
        .modal-header.bg-primary.text-white.py-3
          h5.modal-title.fw-bold
            i.fa-solid.fa-pen-to-square.me-2
            | Editar Ausencia
          button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
        form#formEditarAusencia(method="POST")
          .modal-body.p-4
            .mb-3
              label.form-label.small.fw-bold Profesional
              select#edit_id_medico.form-select(name="id_medico" required)
                if medicos
                  each med in medicos
                    option(value=med.id_medico || med.id) #{med.apellido}, #{med.nombre}
            .row
              .col-6.mb-3
                label.form-label.small.fw-bold Desde
                input#edit_fecha_inicio.form-control(type="date" name="fecha_inicio" required)
              .col-6.mb-3
                label.form-label.small.fw-bold Hasta
                input#edit_fecha_fin.form-control(type="date" name="fecha_fin" required)
            .mb-3
              label.form-label.small.fw-bold Motivo
              select#edit_tipo.form-select(name="tipo" required)
                option(value="Licencia") Licencia Médica
                option(value="Congreso") Congreso / Capacitación
                option(value="Vacaciones") Vacaciones
                option(value="Particular") Asuntos Particulares
            .mb-3
              label.form-label.small.fw-bold Observaciones
              textarea#edit_descripcion.form-control(name="descripcion" rows="2" style="resize:none")
          .modal-footer.bg-light
            button.btn.btn-light.rounded-pill(type="button" data-bs-dismiss="modal") Cancelar
            button.btn.btn-primary.px-4.rounded-pill(type="submit") Guardar Cambios

  script.
    // 1. Script para cargar datos en el Modal de Edición
    const modalEditar = document.getElementById('modalEditarAusencia');
    modalEditar.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      
      // Extraer datos de los atributos data-*
      const id = button.getAttribute('data-id');
      const medico = button.getAttribute('data-medico');
      const inicio = button.getAttribute('data-inicio');
      const fin = button.getAttribute('data-fin');
      const tipo = button.getAttribute('data-tipo');
      const desc = button.getAttribute('data-desc');

      // Actualizar el action del form
      const form = modalEditar.querySelector('#formEditarAusencia');
      form.action = `/secretaria/ausencias/update/${id}`;

      // Llenar los campos
      modalEditar.querySelector('#edit_id_medico').value = medico;
      modalEditar.querySelector('#edit_fecha_inicio').value = inicio;
      modalEditar.querySelector('#edit_fecha_fin').value = fin;
      modalEditar.querySelector('#edit_tipo').value = tipo;
      modalEditar.querySelector('#edit_descripcion').value = desc === '-' ? '' : desc;
    });

    // 2. Función para eliminar
    function confirmarEliminacion(boton) {
      Swal.fire({
        title: '¿Habilitar agenda?',
        text: "Se eliminará el bloqueo y el médico volverá a figurar disponible.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#6c757d',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, habilitar',
        cancelButtonText: 'Cancelar',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          boton.closest('form').submit();
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('status') === 'success') {
        Swal.fire({ icon: 'success', title: '¡Listo!', text: 'Operación realizada con éxito.', timer: 2000, showConfirmButton: false });
      }

      // Búsqueda
      const inputBusqueda = document.getElementById('busquedaAusencia');
      const filas = document.querySelectorAll('.fila-ausencia');
      inputBusqueda.addEventListener('input', function() {
        const termino = this.value.toLowerCase();
        filas.forEach(fila => {
          fila.style.display = fila.textContent.toLowerCase().includes(termino) ? '' : 'none';
        });
      });
    });