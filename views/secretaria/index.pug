//- extends ../layout

//- block contenido
//-     .container.mt-4

//-         // ====== SECCIÓN: BUSCAR AGENDA ======
//-         .row.justify-content-center.mb-5
//-             .col-md-6
//-                 .card.shadow
//-                     .card-body.text-center
//-                         h3.card-title Buscar agendas disponibles
//-                         p.card-text
//-                         a.btn.btn-primary.btn-lg(href="/agendas")
//-                             i.fa-solid.fa-calendar-plus.me-2
//-                             | Buscar agendas

//-         // ====== SECCIÓN: SOLICITAR TURNO ======
//-         hr.mb-4

//-         h3.text-center.mb-4 Solicitar Turno

//-         .row.justify-content-center
//-             .col-md-10
//-                 .card.shadow
//-                     .card-body
//-                         //- form(method="POST" action="/turnos/buscar")
//-                         form(method="GET" action="/secretaria/disponibilidad")


//-                             // Doctor
//-                             .mb-3
//-                                 label.form-label(for="doctor") Doctor *
//-                                 //- select.form-select(name="doctor" id="doctor" required)
//-                                 //-     option(value="") Seleccione un profesional
//-                                 //-     option(value="munoz-anabella") Muñoz Anabella Celeste (FONOAUDIOLOGÍA)

//-                                 select.form-select(name="doctor" id="doctor" required)
//-                                     option(value="") Seleccione un profesional
//-                                     each m in medicos
//-                                         option(value=m.id_medico)
//-                                             | #{m.apellido} #{m.nombre} (#{m.especialidades})




//-                             // Especialidad
//-                             .mb-3
//-                                 label.form-label(for="doctor") Especialidad *                
//-                                 select.form-select(name="doctor" id="doctor" required)
//-                                     option(value="") Seleccione un profesional
//-                                     each m in medicos
//-                                         option(value=m.id_medico)
//-                                             | #{m.especialidades}            

//-                             // Tipo Consulta
//-                             .mb-3
//-                                 label.form-label(for="tipoConsulta") Tipo de Consulta *
//-                                 select.form-select(name="tipoConsulta" id="tipoConsulta" required)
//-                                     option(value="") Seleccione tipo de consulta
//-                                     option(value="evaluacion") Evaluación
//-                                     option(value="control") Control
//-                                     option(value="tratamiento") Tratamiento

//-                             // Fecha
//-                             .mb-3
//-                                 label.form-label(for="fecha") Fecha *
//-                                 input.form-control(
//-                                     type="date"
//-                                     name="fecha"
//-                                     id="fecha"
//-                                     required
//-                                 )

//-                             // ===== MENSAJE HORARIOS DISPONIBLES =====
//-                             if horarios && horarios.length
//-                                 .alert.alert-success.text-center.mt-4
//-                                     | Estos son los horarios disponibles para el 
//-                                     strong #{diaSemana} #{fechaSeleccionada}

//-                                 .d-flex.flex-wrap.justify-content-center.gap-2.mt-3
//-                                     each hora in horarios
//-                                         button.btn.btn-success.btn-sm(
//-                                             type="submit"
//-                                             name="hora"
//-                                             value=hora
//-                                         ) #{hora}

//-                             // ===== MENSAJE SIN TURNOS DÍA =====
//-                             if sinTurnosDia
//-                                 .alert.alert-danger.mt-4.text-center
//-                                     | No se encontraron turnos disponibles para el día 
//-                                     strong #{fechaSeleccionada}

//-                             // ===== OTRAS FECHAS DISPONIBLES =====
//-                             if otrasFechas && otrasFechas.length
//-                                 .alert.alert-info.text-center.mt-4
//-                                     | Otras fechas con turnos disponibles

//-                                 .d-flex.flex-wrap.justify-content-center.gap-2.mt-2
//-                                     each f in otrasFechas
//-                                         a.btn.btn-info.btn-sm(
//-                                             href=`/turnos?doctor=${doctorSeleccionado}&fecha=${f.valor}`
//-                                         ) #{f.label}

//-                             // ===== SIN TURNOS SEMANA =====
//-                             if sinTurnosSemana
//-                                 .alert.alert-danger.mt-4.text-center
//-                                     p.mb-1 No se encontraron turnos disponibles en la semana solicitada.
//-                                     p.mb-3 Intente con la semana del #{sugerenciaFecha}
//-                                     a.btn.btn-info(
//-                                         href=`/turnos?fecha=${sugerenciaFecha}`
//-                                     ) #{sugerenciaFecha}




//- extends ../layout

//- block contenido
//-     .container.mt-4

//-         // ====== SECCIÓN: BUSCAR AGENDA ======
//-         .row.justify-content-center.mb-5
//-             .col-md-6
//-                 .card.shadow
//-                     .card-body.text-center
//-                         h3.card-title Buscar agendas disponibles
//-                         p.card-text
//-                         a.btn.btn-primary.btn-lg(href="/agendas")
//-                             i.fa-solid.fa-calendar-plus.me-2
//-                             | Ver agendas

//-         // ====== SECCIÓN: SOLICITAR TURNO ======
//-         hr.mb-4
//-         h3.text-center.mb-4 Solicitar Turno

//-         .row.justify-content-center
//-             .col-md-10
//-                 .card.shadow
//-                     .card-body
//-                         form(method="GET" action="/secretaria/disponibilidad")

//-                             // ======================
//-                             // MÉDICO
//-                             // ======================
//-                             .mb-3
//-                                 label.form-label(for="medico") Médico *
//-                                 select.form-select(name="medico" id="medico" required)
//-                                     option(value="") Seleccione un profesional
//-                                     each m in medicos
//-                                         option(
//-                                             value=m.id_medico
//-                                             data-especialidades=JSON.stringify(m.especialidades)
//-                                         )
//-                                             | #{m.apellido} #{m.nombre}

//-                             // ======================
//-                             // ESPECIALIDAD
//-                             // ======================
//-                             .mb-3
//-                                 label.form-label(for="especialidad") Especialidad *
//-                                 select.form-select(
//-                                     name="especialidad"
//-                                     id="especialidad"
//-                                     required
//-                                     disabled
//-                                 )
//-                                     option(value="") Seleccione una especialidad

//-                             // ======================
//-                             // TIPO CONSULTA
//-                             // ======================
//-                             .mb-3
//-                                 label.form-label(for="tipoConsulta") Tipo de Consulta *
//-                                 select.form-select(name="tipoConsulta" id="tipoConsulta" required)
//-                                     option(value="") Seleccione tipo de consulta
//-                                     option(value="evaluacion") Evaluación
//-                                     option(value="control") Control
//-                                     option(value="tratamiento") Tratamiento

//-                             // ======================
//-                             // FECHA
//-                             // ======================
//-                             .mb-3
//-                                 label.form-label(for="fecha") Fecha *
//-                                 input.form-control(
//-                                     type="date"
//-                                     name="fecha"
//-                                     id="fecha"
//-                                     required
//-                                 )

//-                             // ======================
//-                             // BOTÓN BUSCAR
//-                             // ======================
//-                             .d-grid.mt-4
//-                                 button.btn.btn-success.btn-lg(type="submit")
//-                                     i.fa-solid.fa-magnifying-glass.me-2
//-                                     | Buscar turnos

//-                             // ===== HORARIOS DISPONIBLES =====
//-                             if horarios && horarios.length
//-                                 .alert.alert-success.text-center.mt-4
//-                                     | Horarios disponibles para el 
//-                                     strong #{diaSemana} #{fechaSeleccionada}

//-                                 .d-flex.flex-wrap.justify-content-center.gap-2.mt-3
//-                                     each hora in horarios
//-                                         a.btn.btn-success.btn-sm(
//-                                             href=`/secretaria/agendar?hora=${hora}&fecha=${fechaSeleccionada}&medico=${doctorSeleccionado}`
//-                                         ) #{hora}

//-                             // ===== SIN TURNOS DÍA =====
//-                             if sinTurnosDia
//-                                 .alert.alert-danger.mt-4.text-center
//-                                     | No se encontraron turnos disponibles para el día 
//-                                     strong #{fechaSeleccionada}

//-                             // ===== OTRAS FECHAS =====
//-                             if otrasFechas && otrasFechas.length
//-                                 .alert.alert-info.text-center.mt-4
//-                                     | Otras fechas con turnos disponibles

//-                                 .d-flex.flex-wrap.justify-content-center.gap-2.mt-2
//-                                     each f in otrasFechas
//-                                         a.btn.btn-info.btn-sm(
//-                                             href=`/secretaria/disponibilidad?medico=${doctorSeleccionado}&fecha=${f.valor}`
//-                                         ) #{f.label}

//-                             // ===== SIN TURNOS SEMANA =====
//-                             if sinTurnosSemana
//-                                 .alert.alert-danger.mt-4.text-center
//-                                     p.mb-1 No se encontraron turnos disponibles en la semana solicitada.
//-                                     p.mb-3 Intente con otra fecha.


//- extends ../layout

//- block contenido
//-   .container.mt-4

//-     // ===============================
//-     // BUSCAR AGENDA
//-     // ===============================
//-     .row.justify-content-center.mb-5
//-       .col-md-6
//-         .card.shadow
//-           .card-body.text-center
//-             h3.card-title Buscar agendas disponibles
//-             a.btn.btn-primary.btn-lg(href="/agendas")
//-               i.fa-solid.fa-calendar-plus.me-2
//-               | Buscar agendas

//-     hr.mb-4
//-     h3.text-center.mb-4 Solicitar Turno

//-     .row.justify-content-center
//-       .col-md-10
//-         .card.shadow
//-           .card-body

//-             form(method="GET" action="/secretaria/disponibilidad")

//-               // ===============================
//-               // BUSCAR MÉDICO
//-               // ===============================
//-               .mb-3
//-                 label.form-label(for="buscarMedico") Buscar médico *
//-                 input#buscarMedico.form-control(
//-                   type="text"
//-                   placeholder="Escriba nombre o apellido"
//-                   autocomplete="off"
//-                 )

//-               // ===============================
//-               // MÉDICO
//-               // ===============================
//-               .mb-3
//-                 label.form-label(for="medicoSelect") Médico *
//-                 select#medicoSelect.form-select(name="id_medico" required)
//-                   option(value="") Seleccione un médico

//-               // ===============================
//-               // ESPECIALIDAD
//-               // ===============================
//-               .mb-3
//-                 label.form-label(for="especialidadSelect") Especialidad *
//-                 select#especialidadSelect.form-select(
//-                   name="id_especialidad"
//-                   required
//-                   disabled
//-                 )
//-                   option(value="") Seleccione una especialidad

//-               // ===============================
//-               // TIPO CONSULTA
//-               // ===============================
//-               .mb-3
//-                 label.form-label(for="tipoConsulta") Tipo de Consulta *
//-                 select#tipoConsulta.form-select(name="tipoConsulta" required)
//-                   option(value="") Seleccione tipo de consulta
//-                   option(value="evaluacion") Evaluación
//-                   option(value="control") Control
//-                   option(value="tratamiento") Tratamiento

//-               // ===============================
//-               // FECHA
//-               // ===============================
//-               .mb-3
//-                 label.form-label(for="fecha") Fecha *
//-                 input#fecha.form-control(
//-                   type="date"
//-                   name="fecha"
//-                   required
//-                 )

//-               .d-grid.mt-3
//-                 button.btn.btn-success(type="submit")
//-                   i.fa-solid.fa-magnifying-glass.me-2
//-                   | Buscar disponibilidad

//-             // ===============================
//-             // RESULTADOS
//-             // ===============================
//-             if horarios && horarios.length
//-               .alert.alert-success.text-center.mt-4
//-                 | Horarios disponibles para
//-                 strong #{diaSemana} #{fechaSeleccionada}

//-               .d-flex.flex-wrap.justify-content-center.gap-2.mt-3
//-                 each h in horarios
//-                   span.badge.bg-success.p-2 #{h}

//-             if sinTurnosDia
//-               .alert.alert-danger.text-center.mt-4
//-                 | No hay turnos disponibles para
//-                 strong #{fechaSeleccionada}

//-             if sinTurnosSemana
//-               .alert.alert-danger.text-center.mt-4
//-                 p.mb-1 No se encontraron turnos en la semana.
//-                 p.mb-2 Intente con la semana del #{sugerenciaFecha}

//-   // ===============================
//-   // JAVASCRIPT
//-   // ===============================
//-   script.
//-     document.addEventListener('DOMContentLoaded', () => {
//-       const inputBuscar = document.getElementById('buscarMedico');
//-       const medicoSelect = document.getElementById('medicoSelect');
//-       const especialidadSelect = document.getElementById('especialidadSelect');

//-       let timeout;

//-       inputBuscar.addEventListener('input', () => {
//-         clearTimeout(timeout);

//-         timeout = setTimeout(async () => {
//-           const texto = inputBuscar.value.trim();

//-           if (texto.length < 2) {
//-             medicoSelect.innerHTML = '<option value="">Escriba al menos 2 letras</option>';
//-             especialidadSelect.innerHTML = '<option value="">Seleccione una especialidad</option>';
//-             especialidadSelect.disabled = true;
//-             return;
//-           }

//-           const res = await fetch(`/medicos/buscar?q=${encodeURIComponent(texto)}`);
//-           const medicos = await res.json();

//-           medicoSelect.innerHTML = '<option value="">Seleccione un médico</option>';
//-           especialidadSelect.innerHTML = '<option value="">Seleccione una especialidad</option>';
//-           especialidadSelect.disabled = true;

//-           if (medicos.length === 0) {
//-             medicoSelect.innerHTML += '<option value="">Sin resultados</option>';
//-             return;
//-           }

//-           medicos.forEach(m => {
//-             medicoSelect.innerHTML +=
//-               `<option value="${m.id_medico}">${m.nombre} ${m.apellido}</option>`;
//-           });
//-         }, 300);
//-       });

//-       medicoSelect.addEventListener('change', async () => {
//-         const idMedico = medicoSelect.value;

//-         especialidadSelect.innerHTML = '<option value="">Seleccione una especialidad</option>';
//-         especialidadSelect.disabled = true;

//-         if (!idMedico) return;

//-         const res = await fetch(`/medicos/${idMedico}/especialidades`);
//-         const especialidades = await res.json();

//-         especialidadSelect.disabled = false;

//-         if (especialidades.length === 0) {
//-           especialidadSelect.innerHTML += '<option value="">Sin especialidades</option>';
//-           return;
//-         }

//-         especialidades.forEach(e => {
//-           especialidadSelect.innerHTML +=
//-             `<option value="${e.id}">${e.nombre}</option>`;
//-         });
//-       });
//-     });


extends ../layout

block contenido
  .container.mt-4

    // ===============================
    // BUSCAR AGENDA
    // ===============================
    .row.justify-content-center.mb-5
      .col-md-6
        .card.shadow
          .card-body.text-center
            h3.card-title Buscar agendas disponibles
            a.btn.btn-primary.btn-lg(href="/agendas")
              i.fa-solid.fa-calendar-plus.me-2
              | Buscar agendas

    hr.mb-4
    h3.text-center.mb-4 Solicitar Turno

    .row.justify-content-center
      .col-md-10
        .card.shadow
          .card-body

            // ===============================
            // FORMULARIO (NO SE ENVÍA)
            // ===============================
            form(onSubmit="return false")

              // ===============================
              // BUSCAR MÉDICO
              // ===============================
              .mb-3
                label.form-label(for="buscarMedico") Buscar médico *
                input#buscarMedico.form-control(
                  type="text"
                  placeholder="Escriba nombre o apellido"
                  autocomplete="off"
                )

              // ===============================
              // MÉDICO
              // ===============================
              .mb-3
                label.form-label(for="medicoSelect") Médico *
                select#medicoSelect.form-select(name="id_medico" required)
                  option(value="") Seleccione un médico

              // ===============================
              // ESPECIALIDAD
              // ===============================
              .mb-3
                label.form-label(for="especialidadSelect") Especialidad *
                select#especialidadSelect.form-select(
                  name="id_especialidad"
                  required
                  disabled
                )
                  option(value="") Seleccione una especialidad

              // ===============================
              // TIPO CONSULTA
              // ===============================
              .mb-3
                label.form-label(for="tipoConsulta") Tipo de Consulta *
                select#tipoConsulta.form-select(name="tipoConsulta" required)
                  option(value="") Seleccione tipo de consulta
                  option(value="evaluacion") Evaluación
                  option(value="control") Control
                  option(value="tratamiento") Tratamiento

              // ===============================
              // FECHA
              // ===============================
              .mb-3
                label.form-label(for="fecha") Fecha *
                input#fecha.form-control(
                  type="date"
                  name="fecha"
                  required
                )

            // ===============================
            // RESULTADOS (AJAX)
            // ===============================
            #resultados
              if horarios && horarios.length
                .alert.alert-success.text-center.mt-4
                  | Horarios disponibles para
                  strong #{diaSemana} #{fechaSeleccionada}

                .d-flex.flex-wrap.justify-content-center.gap-2.mt-3
                  each h in horarios
                    span.badge.bg-success.p-2 #{h}

              if sinTurnosDia
                .alert.alert-danger.text-center.mt-4
                  | No hay turnos disponibles para
                  strong #{fechaSeleccionada}

              if sinTurnosSemana
                .alert.alert-danger.text-center.mt-4
                  p.mb-1 No se encontraron turnos en la semana.

  // ===============================
  // JAVASCRIPT
  // ===============================
  script.
    document.addEventListener('DOMContentLoaded', () => {
      const inputBuscar = document.getElementById('buscarMedico');
      const medicoSelect = document.getElementById('medicoSelect');
      const especialidadSelect = document.getElementById('especialidadSelect');
      const fechaInput = document.getElementById('fecha');
      const resultadosDiv = document.getElementById('resultados');

      let timeout;

      // ===============================
      // BUSCAR MÉDICOS
      // ===============================
      inputBuscar.addEventListener('input', () => {
        clearTimeout(timeout);

        timeout = setTimeout(async () => {
          const texto = inputBuscar.value.trim();

          if (texto.length < 2) {
            medicoSelect.innerHTML = '<option value="">Escriba al menos 2 letras</option>';
            especialidadSelect.innerHTML = '<option value="">Seleccione una especialidad</option>';
            especialidadSelect.disabled = true;
            return;
          }

          const res = await fetch(`/medicos/buscar?q=${encodeURIComponent(texto)}`);
          const medicos = await res.json();

          medicoSelect.innerHTML = '<option value="">Seleccione un médico</option>';
          especialidadSelect.innerHTML = '<option value="">Seleccione una especialidad</option>';
          especialidadSelect.disabled = true;

          medicos.forEach(m => {
            medicoSelect.innerHTML +=
              `<option value="${m.id_medico}">${m.nombre} ${m.apellido}</option>`;
          });
        }, 300);
      });

      // ===============================
      // CARGAR ESPECIALIDADES
      // ===============================
      medicoSelect.addEventListener('change', async () => {
        especialidadSelect.innerHTML = '<option value="">Seleccione una especialidad</option>';
        especialidadSelect.disabled = true;

        if (!medicoSelect.value) return;

        const res = await fetch(`/medicos/${medicoSelect.value}/especialidades`);
        const especialidades = await res.json();

        especialidadSelect.disabled = false;

        especialidades.forEach(e => {
          especialidadSelect.innerHTML +=
            `<option value="${e.id}">${e.nombre}</option>`;
        });
      });

      // ===============================
      // BUSCAR DISPONIBILIDAD AUTOMÁTICA
      // ===============================
      async function buscarDisponibilidad() {
        const id_medico = medicoSelect.value;
        const id_especialidad = especialidadSelect.value;
        const fecha = fechaInput.value;

        if (!id_medico || !id_especialidad || !fecha) return;

        const url =
          `/secretaria/disponibilidad?id_medico=${id_medico}` +
          `&id_especialidad=${id_especialidad}&fecha=${fecha}`;

        const res = await fetch(url);
        const html = await res.text();

        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const nuevosResultados = doc.querySelector('#resultados');

        if (nuevosResultados) {
          resultadosDiv.innerHTML = nuevosResultados.innerHTML;
        }
      }

      especialidadSelect.addEventListener('change', buscarDisponibilidad);
      fechaInput.addEventListener('change', buscarDisponibilidad);
    });
