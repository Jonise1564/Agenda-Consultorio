extends ../layout

block contenido
  .container.mt-4

    // ===============================
    // BUSCAR AGENDA
    // ===============================
    .row.justify-content-center.mb-5
      .col-md-6
        .card.shadow
          .card-body.text-center
            h3.card-title Buscar agendas disponibles
            a.btn.btn-primary.btn-lg(href="/agendas")
              i.fa-solid.fa-calendar-plus.me-2
              | Buscar agendas

    hr.mb-4
    h3.text-center.mb-4 Solicitar Turno

    .row.justify-content-center
      .col-md-10
        .card.shadow
          .card-body

            // ===============================
            // FORMULARIO (NO SE ENVÍA)
            // ===============================
            form(onSubmit="return false")

              // ===============================
              // BUSCAR MÉDICO
              // ===============================
              .mb-3
                label.form-label(for="buscarMedico") Buscar médico *
                input#buscarMedico.form-control(
                  type="text"
                  placeholder="Escriba nombre o apellido"
                  autocomplete="off"
                )

              // ===============================
              // MÉDICO
              // ===============================
              .mb-3
                label.form-label(for="medicoSelect") Médico *
                select#medicoSelect.form-select(name="id_medico" required)
                  option(value="") Seleccione un médico

              // ===============================
              // ESPECIALIDAD
              // ===============================
              .mb-3
                label.form-label(for="especialidadSelect") Especialidad *
                select#especialidadSelect.form-select(
                  name="id_especialidad"
                  required
                  disabled
                )
                  option(value="") Seleccione una especialidad

              // ===============================
              // TIPO CONSULTA
              // ===============================
              .mb-3
                label.form-label(for="tipoConsulta") Tipo de Consulta *
                select#tipoConsulta.form-select(name="tipoConsulta" required)
                  option(value="") Seleccione tipo de consulta
                  option(value="evaluacion") Evaluación
                  option(value="control") Control
                  option(value="tratamiento") Tratamiento

              // ===============================
              // FECHA
              // ===============================
              .mb-3
                label.form-label(for="fecha") Fecha *
                input#fecha.form-control(
                  type="date"
                  name="fecha"
                  required
                )

            // ===============================
            // RESULTADOS (AJAX)
            // ===============================
            #resultados
              if horarios && horarios.length
                .alert.alert-success.text-center.mt-4
                  | Estos son los horarios disponibles para el día: 
                  strong #{diaSemana} #{fechaSeleccionada}

                .d-flex.flex-wrap.justify-content-center.gap-2.mt-3
                  each h in horarios
                    span.badge.bg-success.p-2 #{h}

              if sinTurnosDia
                .alert.alert-danger.text-center.mt-4
                  | No hay turnos disponibles para
                  strong #{fechaSeleccionada}

              if sinTurnosSemana
                .alert.alert-danger.text-center.mt-4
                  p.mb-1 No se encontraron turnos en la semana.

  // ===============================
  // JAVASCRIPT
  // ===============================
  script.
    document.addEventListener('DOMContentLoaded', () => {
      const inputBuscar = document.getElementById('buscarMedico');
      const medicoSelect = document.getElementById('medicoSelect');
      const especialidadSelect = document.getElementById('especialidadSelect');
      const fechaInput = document.getElementById('fecha');
      const resultadosDiv = document.getElementById('resultados');

      let timeout;

      // ===============================
      // BUSCAR MÉDICOS
      // ===============================
      inputBuscar.addEventListener('input', () => {
        clearTimeout(timeout);

        timeout = setTimeout(async () => {
          const texto = inputBuscar.value.trim();

          if (texto.length < 2) {
            medicoSelect.innerHTML = '<option value="">Escriba al menos 2 letras</option>';
            especialidadSelect.innerHTML = '<option value="">Seleccione una especialidad</option>';
            especialidadSelect.disabled = true;
            return;
          }

          const res = await fetch(`/medicos/buscar?q=${encodeURIComponent(texto)}`);
          const medicos = await res.json();

          medicoSelect.innerHTML = '<option value="">Seleccione un médico</option>';
          especialidadSelect.innerHTML = '<option value="">Seleccione una especialidad</option>';
          especialidadSelect.disabled = true;

          medicos.forEach(m => {
            medicoSelect.innerHTML +=
              `<option value="${m.id_medico}">${m.nombre} ${m.apellido}</option>`;
          });
        }, 300);
      });

      // ===============================
      // CARGAR ESPECIALIDADES
      // ===============================
      medicoSelect.addEventListener('change', async () => {
        especialidadSelect.innerHTML = '<option value="">Seleccione una especialidad</option>';
        especialidadSelect.disabled = true;

        if (!medicoSelect.value) return;

        const res = await fetch(`/medicos/${medicoSelect.value}/especialidades`);
        const especialidades = await res.json();

        especialidadSelect.disabled = false;

        especialidades.forEach(e => {
          especialidadSelect.innerHTML +=
            `<option value="${e.id}">${e.nombre}</option>`;
        });
      });

      // ===============================
      // BUSCAR DISPONIBILIDAD AUTOMÁTICA
      // ===============================
      async function buscarDisponibilidad() {
        const id_medico = medicoSelect.value;
        const id_especialidad = especialidadSelect.value;
        const fecha = fechaInput.value;

        if (!id_medico || !id_especialidad || !fecha) return;

        const url =
          `/secretaria/disponibilidad?id_medico=${id_medico}` +
          `&id_especialidad=${id_especialidad}&fecha=${fecha}`;

        const res = await fetch(url);
        const html = await res.text();

        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const nuevosResultados = doc.querySelector('#resultados');

        if (nuevosResultados) {
          resultadosDiv.innerHTML = nuevosResultados.innerHTML;
        }
      }

      especialidadSelect.addEventListener('change', buscarDisponibilidad);
      fechaInput.addEventListener('change', buscarDisponibilidad);
    });
