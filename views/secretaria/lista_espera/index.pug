extends ../../layout

block contenido
  .container-fluid.py-4
    //- Cabecera con estadísticas rápidas
    .row.mb-4.align-items-center
      .col-md-6
        h2.fw-bold.text-primary 
          i.fa-solid.fa-rectangle-list.me-2
          | Lista de Espera
        p.text-muted.mb-0 Hay #{espera.length} pacientes pendientes de contacto.
      .col-md-6.text-md-end
        a.btn.btn-outline-secondary.me-2(href="/secretaria")
          i.fa-solid.fa-arrow-left.me-2
          | Volver al Panel
        a.btn.btn-primary.shadow-sm(href="/secretaria/lista-espera/create")
          i.fa-solid.fa-user-plus.me-2
          | Nueva Solicitud

    //- Tabla de Registros
    .card.border-0.shadow-sm
      .card-body.p-0
        .table-responsive
          table.table.table-hover.align-middle.mb-0
            thead.bg-light
              tr.text-secondary.small.text-uppercase
                th.ps-4.py-3 Paciente / Contacto Rápido
                th Profesional / Especialidad
                th Fecha Registro
                th Prioridad
                th.text-end.pe-4 Acciones
            tbody
              if espera && espera.length > 0
                each item in espera
                  tr
                    //- Columna Paciente con Mensajería Automatizada
                    td.ps-4
                      .d-flex.flex-column
                        span.fw-bold.text-dark #{item.paciente_apellido}, #{item.paciente_nombre}
                        .d-flex.align-items-center.gap-2.mt-1
                          span.badge.bg-light.text-dark.border.fw-normal DNI: #{item.paciente_dni}
                          
                          if item.paciente_telefono
                            //- Botón de WhatsApp con limpieza de URL (Llamada a función JS)
                            button.btn.btn-xs.btn-outline-success.py-0.px-1(
                              type="button"
                              onclick=`enviarWS('${item.paciente_telefono}', '${item.paciente_nombre}', '${item.especialidad_nombre}', '${item.medico_apellido}')`
                              data-bs-toggle="tooltip" 
                              title="Enviar propuesta por WhatsApp"
                            )
                              i.fa-brands.fa-whatsapp
                            
                            a.btn.btn-xs.btn-outline-primary.py-0.px-1(href=`tel:${item.paciente_telefono.replace(/[^0-9]/g, '')}` data-bs-toggle="tooltip" title="Llamar al paciente")
                              i.fa-solid.fa-phone

                          if item.paciente_email
                            - const subEmail = encodeURIComponent(`Turno Disponible: ${item.especialidad_nombre}`)
                            - const bodyEmail = encodeURIComponent(`Estimado/a ${item.paciente_nombre},\n\nLe informamos que contamos con una vacante para su solicitud de turno en ${item.especialidad_nombre}.\n\nPor favor, contáctenos para confirmar.\n\nSaludos.`)
                            
                            a.btn.btn-xs.btn-outline-secondary.py-0.px-1(href=`mailto:${item.paciente_email}?subject=${subEmail}&body=${bodyEmail}` data-bs-toggle="tooltip" title="Enviar correo formal")
                              i.fa-solid.fa-envelope
                    
                    td
                      .d-flex.flex-column
                        span.fw-bold Dra/er. #{item.medico_apellido}
                        span.badge.bg-info.text-dark.small(style="width: fit-content") #{item.especialidad_nombre}
                    
                    td
                      span.d-block.small #{new Date(item.fecha_registro).toLocaleDateString('es-AR')}
                      span.text-muted.x-small(style="font-size: 0.75rem") Registró: #{item.usuario_registro}
                    
                    td
                      if item.prioridad === 'Alta'
                        span.badge.rounded-pill.bg-danger.px-3 Alta
                      else if item.prioridad === 'Media'
                        span.badge.rounded-pill.bg-warning.text-dark.px-3 Media
                      else
                        span.badge.rounded-pill.bg-success.px-3 Baja
                    
                    td.text-end.pe-4
                      .btn-group
                        if item.observaciones
                          button.btn.btn-sm.btn-light.text-primary(type="button" data-bs-toggle="tooltip" title=`Obs: ${item.observaciones}`)
                            i.fa-solid.fa-circle-info
                        
                        form(id=`form-delete-${item.id}` action=`/secretaria/lista-espera/delete/${item.id}` method="POST" style="display:inline")
                          button.btn.btn-sm.btn-outline-danger.ms-2(type="button" onclick=`confirmarBorrado(${item.id}, '${item.paciente_apellido}')` data-bs-toggle="tooltip" title="Quitar de la lista")
                            i.fa-solid.fa-trash-can
              else
                tr
                  td.text-center.py-5(colspan="5")
                    .text-muted
                      i.fa-solid.fa-folder-open.fa-3x.mb-3
                      p.mb-0 No hay solicitudes pendientes en la lista de espera.

  script(src="https://cdn.jsdelivr.net/npm/sweetalert2@11")
  script.
    // Función para enviar WhatsApp ocultando el mensaje de la URL del navegador
    function enviarWS(telefono, nombre, especialidad, medico) {
        const tel = telefono.replace(/[^0-9]/g, '');
        const msg = `Hola ${nombre}, te contactamos del Consultorio. Tenemos un turno disponible para la especialidad de ${especialidad} con el/la Dr/a. ${medico}. ¿Te gustaría agendarlo?`;
        
        const url = `https://api.whatsapp.com/send?phone=${tel}&text=${encodeURIComponent(msg)}`;
        
        // Abrimos en pestaña nueva sin dejar rastro en el historial de la página actual
        window.open(url, '_blank', 'noopener,noreferrer');
    }

    function confirmarBorrado(id, apellido) {
      Swal.fire({
        title: '¿Remover paciente?',
        text: `Se cancelará la solicitud de espera para el paciente ${apellido}.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, quitar',
        cancelButtonText: 'Mantener',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          document.getElementById('form-delete-' + id).submit();
        }
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      tooltipTriggerList.map(function (el) {
        return new bootstrap.Tooltip(el)
      });
    });

  style.
    .table th { border-top: none; }
    .table tbody tr:last-child td { border-bottom: none; }
    .badge { font-weight: 500; letter-spacing: 0.2px; }
    .x-small { font-size: 0.7rem; }
    .btn-xs { padding: 0.2rem 0.4rem; font-size: 0.75rem; transition: all 0.2s; border-radius: 4px; }
    .btn-xs:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .fa-whatsapp { color: #25D366; }
    .btn-outline-success:hover .fa-whatsapp { color: white; }