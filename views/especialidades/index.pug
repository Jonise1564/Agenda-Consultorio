//- extends ../layout

//- block contenido
//-   .container-fluid
//-     // ---------- ENCABEZADO ----------
//-     .row.mb-4
//-       .col-12.d-flex.justify-content-between.align-items-center
//-         div
//-           //- a.text-decoration-none.small.text-muted(href="/medicos")
//-           //-   i.fa-solid.fa-arrow-left.me-1
//-           //-   | Volver a Médicos
//-           h2.fw-bold.text-primary.mt-1
//-             i.fa-solid.fa-stethoscope.me-2
//-             | Especialidades Médicas
//-           if especialidades
//-             span.badge.bg-light.text-dark.border 
//-               i.bi.bi-tag.me-1
//-               | #{especialidades.length} registros encontrados
        
//-         a.btn.btn-primary.shadow-sm(href="/especialidades/create")
//-           i.fa-solid.fa-plus.me-2
//-           | Nueva Especialidad

//-     // ---------- BUSCADOR ----------
//-     .card.border-0.shadow-sm.mb-4
//-       .card-body
//-         .input-group
//-           span.input-group-text.bg-white.border-end-0
//-             i.fa-solid.fa-magnifying-glass.text-muted
//-           input#search.form-control.border-start-0.ps-0(
//-             type="text" 
//-             placeholder="Filtrar especialidades..." 
//-             onkeyup="filterEspecialidades()"
//-           )

//-     if successMessage
//-       script.
//-         Swal.fire({ title: '¡Hecho!', text: '#{successMessage}', icon: 'success', confirmButtonColor: '#0a3d62' });

//-     // ---------- TABLA ----------
//-     .card.border-0.shadow-sm
//-       .table-responsive
//-         table.table.table-hover.align-middle.mb-0
//-           thead.bg-light
//-             tr
//-               th.ps-4(style="width: 60%") Nombre
//-               th.text-center Estado
//-               th.text-end.pe-4 Acciones

//-           tbody#especialidades-list
//-             if especialidades && especialidades.length > 0
//-               each esp in especialidades
//-                 //- Definimos la variable de estado buscando posibles nombres (estado o activo)
//-                 - const esActivo = (esp.estado == 1 || esp.activo == 1 || esp.estado == true)
                
//-                 tr(data-nombre=esp.nombre.toLowerCase())
//-                   td.ps-4
//-                     span.especialidad-nombre.fw-bold= esp.nombre
                    
//-                     form.edit-form(action=`/especialidades/update/${esp.id}` method="POST" style="display:none;")
//-                       .input-group.input-group-sm
//-                         input.form-control(type="text" name="nombre" value=esp.nombre required)
//-                         button.btn.btn-success(type="submit"): i.fa-solid.fa-check
//-                         button.btn.btn-outline-secondary(type="button" onclick=`toggleEditForm(${esp.id})`): i.fa-solid.fa-xmark

//-                   td.text-center
//-                     if esActivo
//-                       span.badge.rounded-pill.bg-success Activa
//-                     else
//-                       span.badge.rounded-pill.bg-danger Inactiva

//-                   td.text-end.pe-4
//-                     .btn-group.btn-group-sm
//-                       button.btn.btn-outline-primary(type="button" onclick=`toggleEditForm(${esp.id})` title="Editar")
//-                         i.fa-solid.fa-pen
                      
//-                       if esActivo
//-                         form(action=`/especialidades/inactivar/${esp.id}` method="POST" style="display:inline;")
//-                           button.btn.btn-outline-danger(type="submit" title="Desactivar")
//-                             i.fa-solid.fa-ban
//-                       else
//-                         form(action=`/especialidades/activar/${esp.id}` method="POST" style="display:inline;")
//-                           button.btn.btn-outline-success(type="submit" title="Activar")
//-                             i.fa-solid.fa-check-circle
//-             else
//-               tr
//-                 td.text-center.py-5(colspan="3") No hay especialidades.

//-   script.
//-     function toggleEditForm(id) {
//-       const row = document.querySelector(`form[action*='/update/${id}']`).closest('tr');
//-       const span = row.querySelector('.especialidad-nombre');
//-       const form = row.querySelector('.edit-form');
//-       if (form.style.display === 'none') {
//-         document.querySelectorAll('.edit-form').forEach(f => f.style.display = 'none');
//-         document.querySelectorAll('.especialidad-nombre').forEach(s => s.style.display = 'block');
//-         form.style.display = 'flex';
//-         span.style.display = 'none';
//-       } else {
//-         form.style.display = 'none';
//-         span.style.display = 'block';
//-       }
//-     }

//-     function filterEspecialidades() {
//-       const q = document.getElementById('search').value.toLowerCase();
//-       document.querySelectorAll('#especialidades-list tr').forEach(tr => {
//-         const nombre = tr.dataset.nombre || "";
//-         tr.style.display = nombre.includes(q) ? '' : 'none';
//-       });
//-     }

extends ../layout

block contenido
  //- Estilos para consistencia visual
  style.
    .modal-content { border-radius: 15px; border: none; }
    .modal-header { border-top-left-radius: 15px; border-top-right-radius: 15px; }
    .card { border-radius: 15px; }

  .container-fluid.py-4
    // ---------- ENCABEZADO ----------
    .row.mb-4
      .col-12.d-flex.justify-content-between.align-items-center
        div
          h2.fw-bold.text-primary.mt-1
            i.fa-solid.fa-stethoscope.me-2
            | Especialidades Médicas
          if especialidades
            span.badge.bg-light.text-dark.border.rounded-pill
              i.bi.bi-tag.me-1
              | #{especialidades.length} registros encontrados
        
        button.btn.btn-primary.shadow-sm.rounded-pill.px-4(type="button" data-bs-toggle="modal" data-bs-target="#modalCrearEspecialidad")
          i.fa-solid.fa-plus.me-2
          | Nueva Especialidad

    // ---------- BUSCADOR ----------
    .card.border-0.shadow-sm.mb-4
      .card-body.p-2
        .input-group
          span.input-group-text.bg-transparent.border-0
            i.fa-solid.fa-magnifying-glass.text-muted
          input#search.form-control.border-0.shadow-none(
            type="text" 
            placeholder="Filtrar especialidades por nombre..." 
            onkeyup="filterEspecialidades()"
          )

    // ---------- TABLA ----------
    .card.border-0.shadow-sm
      .card-body.p-0
        .table-responsive
          table.table.table-hover.align-middle.mb-0
            thead.bg-light
              tr
                th.ps-4(style="width: 60%") Nombre de la Especialidad
                th.text-center Estado
                th.text-end.pe-4 Acciones

            tbody#especialidades-list
              if especialidades && especialidades.length > 0
                each esp in especialidades
                  - const esActivo = (esp.estado == 1 || esp.activo == 1 || esp.estado == true)
                  
                  tr(data-nombre=esp.nombre.toLowerCase() class=esActivo ? '' : 'opacity-50')
                    td.ps-4
                      span.especialidad-nombre.fw-bold.text-dark= esp.nombre
                      
                      //- Formulario de edición rápida
                      form.edit-form(action=`/especialidades/update/${esp.id}` method="POST" style="display:none;")
                        .input-group.input-group-sm
                          input.form-control(type="text" name="nombre" value=esp.nombre required)
                          button.btn.btn-success(type="submit"): i.fa-solid.fa-check
                          button.btn.btn-outline-secondary(type="button" onclick=`toggleEditForm(${esp.id})`): i.fa-solid.fa-xmark

                    td.text-center
                      if esActivo
                        span.badge.rounded-pill.bg-success-subtle.text-success.border.border-success Activa
                      else
                        span.badge.rounded-pill.bg-danger-subtle.text-danger.border.border-danger Inactiva

                    td.text-end.pe-4
                      .btn-group.shadow-sm
                        button.btn.btn-outline-primary.btn-sm(type="button" onclick=`toggleEditForm(${esp.id})` title="Editar")
                          i.fa-solid.fa-pen
                        
                        if esActivo
                          form(action=`/especialidades/inactivar/${esp.id}` method="POST" style="display:inline;")
                            button.btn.btn-outline-danger.btn-sm(type="submit" title="Desactivar")
                              i.fa-solid.fa-ban
                        else
                          form(action=`/especialidades/activar/${esp.id}` method="POST" style="display:inline;")
                            button.btn.btn-outline-success.btn-sm(type="submit" title="Activar")
                              i.fa-solid.fa-check-circle
              else
                tr: td.text-center.py-5(colspan="3") No hay especialidades registradas.

  //- ---------- MODAL DE CREACIÓN ----------
  #modalCrearEspecialidad.modal.fade(tabindex="-1" aria-hidden="true")
    .modal-dialog.modal-dialog-centered
      .modal-content.shadow-lg
        .modal-header.bg-primary.text-white
          h5.modal-title.fw-bold
            i.fa-solid.fa-stethoscope.me-2
            | Nueva Especialidad
          button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal" aria-label="Close")
        form(action="/especialidades/store" method="post")
          .modal-body.p-4
            .mb-3
              label.form-label.fw-bold Nombre de la Especialidad
              input.form-control.form-control-lg(type="text" name="nombre" placeholder="Ej: Pediatría, Cardiología..." required)
              .form-text Ingrese el nombre oficial de la especialidad médica.
          .modal-footer.bg-light
            button.btn.btn-light.rounded-pill(type="button" data-bs-dismiss="modal") Cancelar
            button.btn.btn-primary.px-4.rounded-pill(type="submit") 
              i.fa-solid.fa-save.me-2
              | Guardar Especialidad

  //- ---------- SCRIPTS ----------
  script(src="https://cdn.jsdelivr.net/npm/sweetalert2@11")
  script.
    // Notificaciones SweetAlert2
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('success') || "#{successMessage}") {
        Swal.fire({
          title: '¡Hecho!',
          text: "#{successMessage}" || 'Operación realizada con éxito',
          icon: 'success',
          timer: 2000,
          showConfirmButton: false,
          confirmButtonColor: '#0d6efd'
        });
      }
    });

    // Edición rápida en tabla
    function toggleEditForm(id) {
      const row = document.querySelector(`form[action*='/update/${id}']`).closest('tr');
      const span = row.querySelector('.especialidad-nombre');
      const form = row.querySelector('.edit-form');
      
      if (form.style.display === 'none') {
        // Cerrar otros abiertos
        document.querySelectorAll('.edit-form').forEach(f => f.style.display = 'none');
        document.querySelectorAll('.especialidad-nombre').forEach(s => s.style.display = 'block');
        
        form.style.display = 'flex';
        span.style.display = 'none';
      } else {
        form.style.display = 'none';
        span.style.display = 'block';
      }
    }

    // Buscador en tiempo real
    function filterEspecialidades() {
      const q = document.getElementById('search').value.toLowerCase();
      document.querySelectorAll('#especialidades-list tr').forEach(tr => {
        const nombre = tr.dataset.nombre || "";
        tr.style.display = nombre.includes(q) ? '' : 'none';
      });
    }