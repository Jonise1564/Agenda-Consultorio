extends ../layout

block contenido
  .container-fluid
    // ---------- ENCABEZADO ----------
    .row.mb-4
      .col-12.d-flex.justify-content-between.align-items-center
        div
          //- a.text-decoration-none.small.text-muted(href="/medicos")
          //-   i.fa-solid.fa-arrow-left.me-1
          //-   | Volver a Médicos
          h2.fw-bold.text-primary.mt-1
            i.fa-solid.fa-stethoscope.me-2
            | Especialidades Médicas
          if especialidades
            span.badge.bg-light.text-dark.border 
              i.bi.bi-tag.me-1
              | #{especialidades.length} registros encontrados
        
        a.btn.btn-primary.shadow-sm(href="/especialidades/create")
          i.fa-solid.fa-plus.me-2
          | Nueva Especialidad

    // ---------- BUSCADOR ----------
    .card.border-0.shadow-sm.mb-4
      .card-body
        .input-group
          span.input-group-text.bg-white.border-end-0
            i.fa-solid.fa-magnifying-glass.text-muted
          input#search.form-control.border-start-0.ps-0(
            type="text" 
            placeholder="Filtrar especialidades..." 
            onkeyup="filterEspecialidades()"
          )

    if successMessage
      script.
        Swal.fire({ title: '¡Hecho!', text: '#{successMessage}', icon: 'success', confirmButtonColor: '#0a3d62' });

    // ---------- TABLA ----------
    .card.border-0.shadow-sm
      .table-responsive
        table.table.table-hover.align-middle.mb-0
          thead.bg-light
            tr
              th.ps-4(style="width: 60%") Nombre
              th.text-center Estado
              th.text-end.pe-4 Acciones

          tbody#especialidades-list
            if especialidades && especialidades.length > 0
              each esp in especialidades
                //- Definimos la variable de estado buscando posibles nombres (estado o activo)
                - const esActivo = (esp.estado == 1 || esp.activo == 1 || esp.estado == true)
                
                tr(data-nombre=esp.nombre.toLowerCase())
                  td.ps-4
                    span.especialidad-nombre.fw-bold= esp.nombre
                    
                    form.edit-form(action=`/especialidades/update/${esp.id}` method="POST" style="display:none;")
                      .input-group.input-group-sm
                        input.form-control(type="text" name="nombre" value=esp.nombre required)
                        button.btn.btn-success(type="submit"): i.fa-solid.fa-check
                        button.btn.btn-outline-secondary(type="button" onclick=`toggleEditForm(${esp.id})`): i.fa-solid.fa-xmark

                  td.text-center
                    if esActivo
                      span.badge.rounded-pill.bg-success Activa
                    else
                      span.badge.rounded-pill.bg-danger Inactiva

                  td.text-end.pe-4
                    .btn-group.btn-group-sm
                      button.btn.btn-outline-primary(type="button" onclick=`toggleEditForm(${esp.id})` title="Editar")
                        i.fa-solid.fa-pen
                      
                      if esActivo
                        form(action=`/especialidades/inactivar/${esp.id}` method="POST" style="display:inline;")
                          button.btn.btn-outline-danger(type="submit" title="Desactivar")
                            i.fa-solid.fa-ban
                      else
                        form(action=`/especialidades/activar/${esp.id}` method="POST" style="display:inline;")
                          button.btn.btn-outline-success(type="submit" title="Activar")
                            i.fa-solid.fa-check-circle
            else
              tr
                td.text-center.py-5(colspan="3") No hay especialidades.

  script.
    function toggleEditForm(id) {
      const row = document.querySelector(`form[action*='/update/${id}']`).closest('tr');
      const span = row.querySelector('.especialidad-nombre');
      const form = row.querySelector('.edit-form');
      if (form.style.display === 'none') {
        document.querySelectorAll('.edit-form').forEach(f => f.style.display = 'none');
        document.querySelectorAll('.especialidad-nombre').forEach(s => s.style.display = 'block');
        form.style.display = 'flex';
        span.style.display = 'none';
      } else {
        form.style.display = 'none';
        span.style.display = 'block';
      }
    }

    function filterEspecialidades() {
      const q = document.getElementById('search').value.toLowerCase();
      document.querySelectorAll('#especialidades-list tr').forEach(tr => {
        const nombre = tr.dataset.nombre || "";
        tr.style.display = nombre.includes(q) ? '' : 'none';
      });
    }