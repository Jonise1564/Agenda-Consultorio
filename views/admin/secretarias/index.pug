extends ../../layout

block contenido
  .container.py-4
    .d-flex.justify-content-between.align-items-center.mb-4
      h3.text-primary 
        i.fa-solid.fa-user-tie.me-2
        | Gestión de Secretarías
      button.btn.btn-primary(onclick="abrirModalNuevo()")
        i.fa-solid.fa-plus.me-2
        | Nueva Secretaria

    .card.border-0.shadow-sm
      .card-body.p-0
        .table-responsive
          table.table.table-hover.align-middle.mb-0
            thead.bg-light
              tr
                th.ps-4 Nombre y Apellido
                th DNI
                th Email
                th.text-end.pe-4 Acciones
            tbody
              if secretarias && secretarias.length > 0
                each s in secretarias
                  tr
                    td.ps-4
                      .fw-bold #{s.apellido}, #{s.nombre}
                    td #{s.dni}
                    td #{s.email}
                    td.text-end.pe-4
                      button.btn.btn-outline-primary.btn-sm.me-2(onclick=`abrirModalEditar(${JSON.stringify(s)})`)
                        i.fa-solid.fa-pen-to-square
                      button.btn.btn-outline-danger.btn-sm(onclick=`eliminarSecretaria(${s.id})`)
                        i.fa-solid.fa-trash
              else
                tr
                  td.text-center.py-4(colspan="4") No hay secretarias registradas.

  #modalSecretaria.modal.fade(tabindex="-1" aria-hidden="true")
    .modal-dialog.modal-lg
      .modal-content.border-0.shadow
        .modal-header.bg-primary.text-white
          h5#modalTitle.modal-title Nueva Secretaria
          button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
        .modal-body.p-4
          form#formSecretaria
            input#secretariaId(type="hidden" name="id")
            .row.g-3
              h6.text-muted.border-bottom.pb-2 Datos Personales
              .col-md-6
                label.form-label Nombre
                input#nombre.form-control(type="text" name="nombre" required)
              .col-md-6
                label.form-label Apellido
                input#apellido.form-control(type="text" name="apellido" required)
              .col-md-6
                label.form-label DNI
                input#dni.form-control(type="number" name="dni" required)
              .col-md-6
                label.form-label Nacimiento
                input#nacimiento.form-control(type="date" name="nacimiento" required)
              
              h6.text-muted.border-bottom.pb-2.mt-4 Acceso
              .col-md-12
                label.form-label Email
                input#email.form-control(type="email" name="email" required)
              #divPassword.col-md-12
                label.form-label Contraseña
                input#password.form-control(type="password" name="password")
                small#passHelp.text-muted La contraseña debe ser segura.
        .modal-footer.bg-light
          button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancelar
          button#btnGuardar.btn.btn-primary.px-4(type="button" onclick="guardarDatos()") 
            i.fa-solid.fa-save.me-2
            | Guardar

  script.
    const modalElement = document.getElementById('modalSecretaria');
    const myModal = new bootstrap.Modal(modalElement);
    const form = document.getElementById('formSecretaria');

    function abrirModalNuevo() {
      form.reset();
      document.getElementById('secretariaId').value = "";
      document.getElementById('modalTitle').innerText = "Nueva Secretaria";
      document.getElementById('dni').disabled = false;
      myModal.show();
    }

    function abrirModalEditar(s) {
      form.reset();
      document.getElementById('modalTitle').innerText = "Editar Secretaria";
      document.getElementById('secretariaId').value = s.id;
      document.getElementById('nombre').value = s.nombre || '';
      document.getElementById('apellido').value = s.apellido || '';
      document.getElementById('dni').value = s.dni || '';
      document.getElementById('dni').disabled = true; 
      document.getElementById('email').value = s.email || '';
      
      // --- LÓGICA DE FECHA REFORZADA ---
      if (s.nacimiento) {
        // Opción 1: Si viene como String ISO (MySQL -> JSON)
        // Ejemplo: "1995-10-25T00:00:00.000Z" -> "1995-10-25"
        let fechaLimpia = s.nacimiento.split('T')[0];
        
        // Opción 2: Si el split falló por algún motivo, forzamos vía Date
        if (fechaLimpia.length > 10 || !fechaLimpia.includes('-')) {
            const d = new Date(s.nacimiento);
            fechaLimpia = d.toISOString().split('T')[0];
        }
        
        document.getElementById('nacimiento').value = fechaLimpia;
      }
      
      myModal.show();
    }

    async function guardarDatos() {
      const id = document.getElementById('secretariaId').value;
      const url = id ? `/admin/secretarias/editar/${id}` : '/admin/secretarias/nuevo';
      
      const dniInput = document.getElementById('dni');
      const dniStatus = dniInput.disabled;
      dniInput.disabled = false;
      
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      dniInput.disabled = dniStatus; 

      try {
        Swal.fire({ title: 'Procesando...', didOpen: () => Swal.showLoading() });
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await response.json();
        if (response.ok) {
          Swal.fire('¡Éxito!', 'Guardado correctamente', 'success').then(() => location.reload());
        } else {
          Swal.fire('Error', result.error || 'Error al guardar', 'error');
        }
      } catch (error) {
        Swal.fire('Error', 'Fallo de conexión', 'error');
      }
    }

    async function eliminarSecretaria(id) {
      const result = await Swal.fire({
        title: '¿Confirmar eliminación?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Sí, eliminar'
      });
      if (result.isConfirmed) {
        try {
          const response = await fetch(`/admin/secretarias/eliminar/${id}`, { method: 'DELETE' });
          if (response.ok) location.reload();
        } catch (error) {
          Swal.fire('Error', 'No se pudo eliminar', 'error');
        }
      }
    }